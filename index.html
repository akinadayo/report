<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ãƒ‡ã‚¶ã‚¤ãƒ³æ€è€ƒã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ </title>
    
    <!-- 
    NOTE: This is a single HTML file application for easy deployment.
    Production warnings are expected and intentional:
    - Tailwind CDN is used instead of PostCSS for simplicity
    - Babel transformer is used for JSX without build step
    ã“ã‚Œã¯å˜ä¸€HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚ç°¡å˜ãªãƒ‡ãƒ—ãƒ­ã‚¤ã®ãŸã‚ã€
    æœ¬ç•ªç’°å¢ƒã§ã®è­¦å‘Šã¯æ„å›³çš„ãªã‚‚ã®ã§ã™ã€‚
    -->
    
    <!-- Tailwind CSS (CDN for single-file deployment) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Suppress Tailwind CDN warning for single-file deployment
        if (typeof window !== 'undefined' && window.console) {
            const originalWarn = console.warn;
            console.warn = function(...args) {
                if (args[0] && args[0].includes('cdn.tailwindcss.com')) return;
                originalWarn.apply(console, args);
            };
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX (required for single-file deployment) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Shared Game Logic (inlined for single-file deployment) -->
    <script>
    (function (root, factory) {
      if (typeof module === 'object' && module.exports) {
        module.exports = factory();
      } else {
        root.GameLogic = factory();
      }
    })(typeof globalThis !== 'undefined' ? globalThis : this, function () {
      const clamp = (value, min, max) => Math.max(min, Math.min(max, value));

      const defaultOptions = {
        mood: 'normal',
        difficulty: 'normal',
        challengeMode: null,
        currentMission: null,
        scoreHistory: []
      };

      function calculateScore(questionInput, previousContextInput = '', options = {}) {
        const question = (questionInput ?? '').toString();
        const previousContext = (previousContextInput ?? '').toString();
        const {
          mood,
          difficulty,
          challengeMode,
          currentMission,
          scoreHistory
        } = { ...defaultOptions, ...options };

        let breakdown = {
          depth: 0,
          empathy: 0,
          exploration: 0,
          context: 0,
          penalty: 0,
          bonus: 0,
          combo: 0
        };

        const whyCount = (question.match(/ãªãœ|ã©ã†ã—ã¦|ã©ã†ãªã£ã¦|åŸå› |ç†ç”±/g) || []).length;
        if (whyCount > 0) {
          breakdown.depth += Math.min(whyCount * 15, 30);
          if (question.includes('æœ¬å½“ã«') || question.includes('ãã‚‚ãã‚‚') || question.includes('æ ¹æœ¬')) {
            breakdown.depth += 15;
            breakdown.bonus += 10;
          }
        }

        if (Array.isArray(scoreHistory) && scoreHistory.length > 0) {
          const lastScore = scoreHistory[scoreHistory.length - 1];
          if (lastScore >= 70 && whyCount > 0) {
            breakdown.combo = 15;
          }
        }

        if (question.includes('å…·ä½“çš„') || question.includes('ä¾‹ãˆã°') || question.includes('ã©ã‚“ãª')) {
          breakdown.depth += 5;
        }

        if ((question.includes('æ„Ÿã˜') || question.includes('æ€ã„') || question.includes('æ°—æŒã¡')) &&
            (question.includes('ãªãœ') || question.includes('ã©ã†ã—ã¦'))) {
          breakdown.depth += 7;
        }

        const empathyWords = ['å¤§å¤‰', 'é›£ã—ã„', 'è¾›ã„', 'å¬‰ã—ã„', 'ç´ æ™´ã‚‰ã—ã„'];
        const hasEmpathy = empathyWords.some(word => question.includes(word));
        if (hasEmpathy && previousContext) {
          breakdown.empathy += 8;
        } else if (hasEmpathy) {
          breakdown.empathy += 3;
        }

        if ((previousContext && question.includes('"')) || question.includes('ã€Œ')) {
          breakdown.empathy += 5;
        }

        const isClosedQuestion = question.includes('ã§ã™ã‹ï¼Ÿ') ||
          question.includes('ã¾ã™ã‹ï¼Ÿ') ||
          !!question.match(/ã¯ã„|ã„ã„ãˆ|Yes|No/i);

        if (!isClosedQuestion) {
          if (question.includes('ã©ã®ã‚ˆã†ã«') || question.includes('ã©ã‚“ãª') || question.includes('ä½•ãŒ')) {
            breakdown.exploration += 10;
          } else {
            breakdown.exploration += 5;
          }
        }

        if (question.includes('ã‚‚ã—') || question.includes('ä»®ã«') || question.includes('ãŸã¨ãˆã°')) {
          breakdown.exploration += 6;
        }

        if ((question.includes('ç†æƒ³') && question.includes('ç¾å®Ÿ')) ||
            question.includes('ã‚®ãƒ£ãƒƒãƒ—') ||
            question.includes('é•ã„')) {
          breakdown.exploration += 8;
        }

        if (previousContext) {
          const contextWords = previousContext.split(/[ã€ã€‚ï¼ï¼Ÿ\s]+/).filter(w => w.length > 2);
          const usedContextWords = contextWords.filter(word => question.includes(word)).length;
          breakdown.context += Math.min(usedContextWords * 3, 10);
        }

        if (question.length > 70) {
          breakdown.penalty -= 12;
        }
        if (question.length < 15) {
          breakdown.penalty -= 15;
        }
        if (question.split('ï¼Ÿ').length > 2) {
          breakdown.penalty -= 20;
        }
        if (question.includes('ã¯ã„') || question.includes('ã„ã„ãˆ')) {
          breakdown.penalty -= 18;
        }
        if (!question.includes('ï¼Ÿ')) {
          breakdown.penalty -= 5;
        }
        if (question.includes('ã§ã™ã‚ˆã­') || question.includes('ã§ã—ã‚‡ã†ï¼Ÿ')) {
          breakdown.penalty -= 15;
        }

        const moodMultiplier = {
          open: 1.2,
          normal: 1.0,
          guard: 0.6,
          close: 0.3
        };

        const difficultyMultiplier = {
          easy: 1.2,
          normal: 0.9,
          hard: 0.7,
          expert: 0.5
        };

        let score = Object.values(breakdown).reduce((sum, val) => sum + val, 0);
        const difficultyFactor = difficultyMultiplier[difficulty] ?? difficultyMultiplier.normal;
        const moodFactor = moodMultiplier[mood] ?? moodMultiplier.normal;

        score *= difficultyFactor;
        if (challengeMode === 'noHint') {
          score *= 1.5;
        }
        if (currentMission === 'speedrun') {
          score *= 1.3;
        }

        score = Math.round(score * moodFactor);
        score = clamp(score, 15, 100);

        if (score > 80) {
          if (whyCount < 2 || !question.includes('ãªãœ')) {
            score = Math.min(score, 70);
          }
        }
        if (score > 90) {
          if (!question.includes('æ„Ÿæƒ…') && !question.includes('ä½“é¨“') && !question.includes('ãªãœ')) {
            score = Math.min(score, 85);
          }
        }

        return { score, breakdown };
      }

      function deriveNextMood(currentMood = 'normal', scoreValue = 50) {
        let mood = currentMood;
        const score = Number.isFinite(scoreValue) ? scoreValue : 50;

        if (score >= 80) {
          if (mood === 'close') mood = 'normal';
          else if (mood === 'guard') mood = 'open';
          else mood = 'open';
        } else if (score >= 60) {
          if (mood === 'close') mood = 'guard';
          else if (mood === 'guard') mood = 'normal';
          else if (mood === 'normal') mood = 'open';
        } else if (score <= 30) {
          if (mood === 'open') mood = 'normal';
          else if (mood === 'normal') mood = 'guard';
          else mood = 'close';
        } else if (score <= 40) {
          if (mood === 'open') mood = 'normal';
          else if (mood === 'normal') mood = 'guard';
        }

        return mood;
      }

      function calculateRank(currentScore = 0, targetScore = 0, scoreHistory = []) {
        const percentage = targetScore > 0 ? (currentScore / targetScore) * 100 : 0;
        const avgScore = Array.isArray(scoreHistory) && scoreHistory.length > 0
          ? scoreHistory.reduce((sum, value) => sum + value, 0) / scoreHistory.length
          : 0;

        if (percentage >= 100 && avgScore >= 85) return 'SSS';
        if (percentage >= 95 && avgScore >= 80) return 'SS';
        if (percentage >= 90 && avgScore >= 75) return 'S';
        if (percentage >= 80 && avgScore >= 70) return 'A';
        if (percentage >= 70 && avgScore >= 60) return 'B';
        if (percentage >= 60 && avgScore >= 50) return 'C';
        if (percentage >= 50 && avgScore >= 40) return 'D';
        return 'E';
      }

      function getAnalysisData(messages = [], scoreHistory = [], insights = [], questionCount = 0) {
        const avgScore = Array.isArray(scoreHistory) && scoreHistory.length > 0
          ? Math.round(scoreHistory.reduce((sum, value) => sum + value, 0) / scoreHistory.length)
          : 0;

        const userMessages = Array.isArray(messages)
          ? messages.filter(m => m && m.type === 'user' && typeof m.content === 'string')
          : [];

        const whyQuestions = userMessages.filter(m => m.content.includes('ãªãœ')).length;
        const openQuestions = userMessages.filter(m => !m.content.includes('ï¼Ÿ')).length;

        const totalLength = userMessages.reduce((sum, m) => sum + m.content.length, 0);
        const denominator = Math.max(1, questionCount || userMessages.length);
        const avgLength = Math.round(totalLength / denominator);

        return {
          avgScore,
          whyQuestions,
          openQuestions,
          avgLength,
          totalInsights: Array.isArray(insights) ? insights.length : 0
        };
      }

      function generatePersonaForTopic(selectedTopic = '', options = {}) {
        const rng = typeof options.rng === 'function' ? options.rng : Math.random;
        const maleNames = ['ç”°ä¸­å¤ªéƒ', 'éˆ´æœ¨ä¸€éƒ', 'æ¸¡è¾ºå¥', 'å±±ç”°å¤§è¼”', 'åŠ è—¤é›„ä»‹', 'å°æ—ç¿”'];
        const femaleNames = ['ä½è—¤èŠ±å­', 'é«˜æ©‹ç¾å’²', 'ä¼Šè—¤ã•ãã‚‰', 'å±±æœ¬æ„›', 'ä¸­æ‘çœŸç”±ç¾', 'æœ¨æ‘å„ªå­'];

        let personaConfig = {
          ages: [25, 32, 28, 45, 38, 52, 35, 29, 41],
          jobs: ['ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢', 'ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼', 'å–¶æ¥­è·', 'ãƒãƒ¼ã‚±ã‚¿ãƒ¼', 'æ•™å¸«', 'åŒ»ç™‚å¾“äº‹è€…', 'çµŒå–¶è€…', 'ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹', 'å…¬å‹™å“¡'],
          locations: ['æ±äº¬éƒ½å¿ƒ', 'ç¥å¥ˆå·éƒŠå¤–', 'åœ°æ–¹éƒ½å¸‚', 'å¤§é˜ªå¸‚å†…', 'ç¦å²¡å¸‚'],
          families: ['ç‹¬èº«', 'æ—¢å©šï¼ˆå­ä¾›ãªã—ï¼‰', 'æ—¢å©šï¼ˆå­ä¾›1äººï¼‰', 'æ—¢å©šï¼ˆå­ä¾›2äººï¼‰', 'ã‚·ãƒ³ã‚°ãƒ«ï¼ˆå­ä¾›1äººï¼‰'],
          hobbies: ['èª­æ›¸', 'æ˜ ç”»é‘‘è³', 'ã‚¹ãƒãƒ¼ãƒ„', 'æ–™ç†', 'æ—…è¡Œ', 'ã‚²ãƒ¼ãƒ ', 'éŸ³æ¥½', 'ã‚«ãƒ•ã‚§å·¡ã‚Š'],
          painPoints: [],
          hiddenNeeds: []
        };

        if (selectedTopic?.includes('æœ') || selectedTopic?.includes('ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³')) {
          personaConfig = {
            ages: [28, 35, 42, 30, 45],
            jobs: ['ä¼šç¤¾å“¡', 'ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢', 'å–¶æ¥­è·', 'ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ', 'ç®¡ç†è·'],
            locations: ['æ±äº¬éƒ½å¿ƒ', 'ç¥å¥ˆå·éƒŠå¤–', 'åƒè‘‰éƒŠå¤–'],
            families: ['æ—¢å©šï¼ˆå­ä¾›1äººï¼‰', 'æ—¢å©šï¼ˆå­ä¾›2äººï¼‰', 'ç‹¬èº«', 'æ—¢å©šï¼ˆå­ä¾›ãªã—ï¼‰'],
            hobbies: ['ã‚¸ãƒ§ã‚®ãƒ³ã‚°', 'ãƒ¨ã‚¬', 'èª­æ›¸', 'ã‚³ãƒ¼ãƒ’ãƒ¼', 'ç‘æƒ³'],
            painPoints: ['æ™‚é–“ä¸è¶³', 'æº–å‚™ã®éåŠ¹ç‡', 'å®¶æ—ã¨ã®èª¿æ•´'],
            hiddenNeeds: ['è‡ªåˆ†æ™‚é–“ã®ç¢ºä¿', 'åŠ¹ç‡çš„ãªæœæ´»', 'å¥åº·çš„ãªç¿’æ…£']
          };
        } else if (selectedTopic?.includes('ãƒªãƒ¢ãƒ¼ãƒˆ') || selectedTopic?.includes('åœ¨å®…')) {
          personaConfig = {
            ages: [29, 35, 40, 32, 38],
            jobs: ['ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢', 'ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼', 'ãƒãƒ¼ã‚±ã‚¿ãƒ¼', 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼', 'ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒŠãƒªã‚¹ãƒˆ'],
            locations: ['æ±äº¬éƒŠå¤–', 'åœ°æ–¹éƒ½å¸‚', 'ç¥å¥ˆå·çœŒ', 'åŸ¼ç‰çœŒ'],
            families: ['æ—¢å©šï¼ˆå­ä¾›1äººï¼‰', 'ç‹¬èº«', 'æ—¢å©šï¼ˆå­ä¾›ãªã—ï¼‰', 'ãƒšãƒƒãƒˆã¨åŒå±…'],
            hobbies: ['ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ', 'å‹•ç”»è¦–è´', 'æ–™ç†', 'åœ’èŠ¸', 'DIY'],
            painPoints: ['ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¸è¶³', 'é‹å‹•ä¸è¶³', 'ä»•äº‹ã¨ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã®å¢ƒç•Œ'],
            hiddenNeeds: ['ç¤¾ä¼šçš„ã¤ãªãŒã‚Š', 'å¥åº·ç¶­æŒ', 'ãƒ¯ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ•ãƒãƒ©ãƒ³ã‚¹']
          };
        } else if (selectedTopic?.includes('è²·ã„ç‰©') || selectedTopic?.includes('è³¼è²·')) {
          // è²·ã„ç‰©ãƒ»è³¼è²·ä½“é¨“ã«é–¢ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³
          options = {
            names: ['å±±ç”°èŠ±å­', 'ç”°ä¸­ç¾å’²', 'éˆ´æœ¨ç”±ç¾', 'ä½è—¤ã‚ã‚†ã¿'],
            ages: [28, 34, 42, 31],
            jobs: ['äº‹å‹™è·', 'ãƒ‘ãƒ¼ãƒˆå‹¤å‹™', 'ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹', 'ä¸»å©¦'],
            locations: ['æ±äº¬éƒ½å†…', 'åƒè‘‰çœŒ', 'ç¥å¥ˆå·çœŒ'],
            families: ['æ—¢å©šï¼ˆå­ä¾›2äººï¼‰', 'ç‹¬èº«', 'æ—¢å©šï¼ˆå­ä¾›ãªã—ï¼‰'],
            hobbies: ['æ–™ç†', 'ãƒãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ‰', 'ã‚«ãƒ•ã‚§å·¡ã‚Š', 'ç¯€ç´„'],
            painPoints: ['ä¾¡æ ¼æ¯”è¼ƒã®æ‰‹é–“', 'è²·ã„ç‰©æ™‚é–“ã®ç¢ºä¿', 'ãƒãƒƒãƒˆ vs å®Ÿåº—èˆ—ã®é¸æŠ'],
            hiddenNeeds: ['è³¢ã„è²·ã„ç‰©', 'æ™‚é–“åŠ¹ç‡', 'æº€è¶³æ„Ÿã®ã‚ã‚‹è³¼è²·ä½“é¨“']
          };
        }
        
        // ãƒ©ãƒ³ãƒ€ãƒ é¸æŠé–¢æ•°
        const random = (arr) => arr[Math.floor(Math.random() * arr.length)];
        
        return {
          name: random(options.names),
          gender: options.names[0].includes('èŠ±å­') || options.names[0].includes('ç¾å’²') ? 'å¥³æ€§' : 'ç”·æ€§',
          age: random(options.ages),
          job: random(options.jobs),
          location: random(options.locations),
          family: random(options.families),
          hobbies: [random(options.hobbies), random(options.hobbies)].filter((v, i, a) => a.indexOf(v) === i),
          personality: {
            traits: ['èª å®Ÿ', 'å¥½å¥‡å¿ƒæ—ºç››', 'æ…é‡'],
            communication_style: 'ä¸å¯§ã§è½ã¡ç€ã„ãŸè©±ã—æ–¹'
          },
          background: `${selectedTopic}ã«ã¤ã„ã¦æ—¥ã€…è€ƒãˆã¦ã„ã‚‹ä¸€èˆ¬çš„ãªç¤¾ä¼šäºº`,
          painPoints: options.painPoints,
          hiddenNeeds: options.hiddenNeeds,
          currentSituation: `${selectedTopic}ã«ã¤ã„ã¦ã®æ”¹å–„ã‚’æ¨¡ç´¢ä¸­`
        };
      }
      
      return {
        calculateScore,
        deriveNextMood,
        calculateRank,
        getAnalysisData,
        generatePersonaForTopic
      };
    });
    </script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: manipulation;
            margin: 0;
            padding: 0;
        }
        
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes ripple {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(4); opacity: 0; }
        }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(99, 102, 241, 0.5); }
            50% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.8); }
        }
        
        @keyframes countUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-50px); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
            20%, 40%, 60%, 80% { transform: translateX(2px); }
        }
        
        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        .bounce {
            animation: bounce 1s infinite;
        }
        
        .typing-dot {
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        .glow {
            animation: glow 2s infinite;
        }
        
        .float-up {
            animation: floatUp 2s ease-out forwards;
        }
        
        .shake {
            animation: shake 0.5s;
        }
        
        .rainbow-bg {
            background: linear-gradient(90deg, #6366F1, #8B5CF6, #EC4899, #6366F1);
            background-size: 300% 100%;
            animation: rainbow 3s linear infinite;
        }
        
        /* ãƒªãƒƒãƒ—ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .ripple {
            position: relative;
            overflow: hidden;
        }
        
        .ripple::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            animation: ripple 0.6s ease-out;
        }
        
        /* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ */
        .gradient-text {
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* ã‚«ãƒ¼ãƒ‰å½± */
        .card-shadow {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .card-shadow-hover {
            transition: all 0.3s ease;
        }
        
        .card-shadow-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 25px 30px -5px rgba(0, 0, 0, 0.15), 0 15px 15px -5px rgba(0, 0, 0, 0.06);
        }
        
        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ–ãƒ« - LINEé¢¨ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .message-bubble {
            position: relative;
            padding: 8px 12px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .message-bubble.user {
            background: #00B900;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .message-bubble.ai {
            background: white;
            color: #1f2937;
            margin-right: auto;
            border-bottom-left-radius: 4px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
        .progress-bar {
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar-fill {
            height: 100%;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #1e1b4b, #312e81);
            }
        }
        
        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ - LINEé¢¨UI */
        @media (max-width: 768px) {
            .message-bubble {
                max-width: 80%;
                font-size: 13px;
                padding: 7px 11px;
                line-height: 1.4;
            }
            
            /* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’LINEé¢¨ã« */
            .mobile-input-area {
                position: fixed;
                bottom: 0;
                bottom: env(safe-area-inset-bottom);
                left: 0;
                right: 0;
                background: #ffffff;
                border-top: 1px solid #e5e7eb;
                padding: 6px 8px;
                padding-bottom: calc(6px + env(safe-area-inset-bottom));
                z-index: 100;
                transform: translateZ(0);
                -webkit-transform: translateZ(0);
            }
            
            .mobile-input-field {
                font-size: 16px !important; /* iOSè‡ªå‹•ã‚ºãƒ¼ãƒ é˜²æ­¢ */
                padding: 8px 12px !important;
                border-radius: 20px !important;
                background: #f7f8fa !important;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
            }
            
            /* ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚’è¶…ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
            .mobile-status-bar {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 90;
                background: white;
                padding: 4px 8px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
                height: 36px;
            }
            
            .mobile-compact-score {
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 11px;
                height: 100%;
            }
            
            /* ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ã®èª¿æ•´ */
            .mobile-chat-area {
                padding-top: 40px !important; /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼åˆ†ã®ä½™ç™½ */
                padding-bottom: 70px !important; /* å…¥åŠ›ã‚¨ãƒªã‚¢åˆ†ã®ä½™ç™½ */
                padding-left: 8px !important;
                padding-right: 8px !important;
            }
            
            /* ãƒšãƒ«ã‚½ãƒŠæƒ…å ±ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
            .mobile-persona-info {
                font-size: 11px;
                padding: 4px 8px;
            }
            
            /* ãƒ¢ãƒã‚¤ãƒ«ãƒšãƒ«ã‚½ãƒŠæƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ« */
            .mobile-persona-modal {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90%;
                max-width: 350px;
                background: white;
                border-radius: 12px;
                padding: 16px;
                z-index: 200;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            }
            
            .mobile-persona-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 199;
            }
            
            /* ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚ºèª¿æ•´ */
            .mobile-button {
                padding: 8px 12px;
                font-size: 13px;
            }
            
            /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ã‚’éè¡¨ç¤º */
            .hide-mobile {
                display: none !important;
            }
            
            /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆå¯¾å¿œ */
            .mobile-viewport {
                height: 100vh;
                height: -webkit-fill-available;
                height: 100dvh;
                height: calc(var(--vh, 1vh) * 100); /* Android Chromeå¯¾å¿œ */
                overflow: hidden;
                display: flex;
                flex-direction: column;
                position: relative;
            }
            
            /* iOS Safe Areaå¯¾å¿œ */
            .safe-area-top {
                padding-top: env(safe-area-inset-top);
            }
            
            .safe-area-bottom {
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            /* ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¡¨ç¤ºæ™‚ã®èª¿æ•´ç”¨ */
            .keyboard-visible .mobile-chat-area {
                padding-bottom: 70px !important;
            }
            
            /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æœ€é©åŒ– */
            .smooth-scroll {
                scroll-behavior: smooth;
                -webkit-overflow-scrolling: touch;
            }
            
            /* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
            input:focus, textarea:focus, select:focus {
                outline: none;
                -webkit-tap-highlight-color: transparent;
            }
            
            /* Android Chromeç”¨ã®è¿½åŠ èª¿æ•´ */
            @supports (-webkit-appearance: none) and (not (-ms-ime-align: auto)) {
                .mobile-input-field {
                    font-size: 16px !important;
                }
                
                .mobile-viewport {
                    min-height: -webkit-fill-available;
                }
            }
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        /* ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”¨ */
        .particle {
            position: fixed;
            pointer-events: none;
            opacity: 0;
            animation: particle-float 3s ease-out forwards;
        }
        
        @keyframes particle-float {
            0% {
                opacity: 1;
                transform: translate(0, 0) scale(0);
            }
            50% {
                opacity: 1;
                transform: translate(var(--x), var(--y)) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(calc(var(--x) * 2), calc(var(--y) * 2)) scale(0.5);
            }
        }
        
        /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: slideInRight 0.3s ease-out;
            z-index: 1000;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;
        
        // Safari/iOS compatible fetch helper
        const safariFetch = async (url, options, timeout = 15000) => {
            const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            
            if (isSafari || isIOS) {
                // For Safari/iOS, use Promise.race for timeout
                return Promise.race([
                    fetch(url, options),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Request timeout')), timeout)
                    )
                ]);
            } else {
                // For other browsers, use AbortController
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                
                try {
                    const response = await fetch(url, {
                        ...options,
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    return response;
                } catch (error) {
                    clearTimeout(timeoutId);
                    throw error;
                }
            }
        };
        
        // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        const InterviewGame = () => {
            // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†
            const [gameState, setGameState] = useState('menu'); // menu, persona, playing, result
            const [currentScore, setCurrentScore] = useState(0);
            const [difficulty, setDifficulty] = useState('normal'); // easy, normal, hard, expert
            const [questionCount, setQuestionCount] = useState(0);
            const [maxQuestions, setMaxQuestions] = useState(10);
            
            // ã‚¹ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ ï¼ˆæº€ç‚¹ãªã—ã€ç´”ç²‹ãªç²å¾—ç‚¹ã®ã¿ï¼‰
            const [challengeMode, setChallengeMode] = useState(null); // null or specific challenge
            const [talkMeter, setTalkMeter] = useState(0);
            const [mood, setMood] = useState('normal'); // open, normal, guard, close
            const [messages, setMessages] = useState([]);
            const [currentQuestion, setCurrentQuestion] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const [scoreHistory, setScoreHistory] = useState([]);
            const [insights, setInsights] = useState([]);
            const [bestQuestions, setBestQuestions] = useState([]);
            const [comboCount, setComboCount] = useState(0);
            const [showParticles, setShowParticles] = useState(false);
            const [toasts, setToasts] = useState([]);
            const [achievements, setAchievements] = useState([]);
            const [totalGamesPlayed, setTotalGamesPlayed] = useState(
                parseInt(localStorage.getItem('totalGamesPlayed') || '0')
            );
            const [highScores, setHighScores] = useState(
                JSON.parse(localStorage.getItem('highScores') || '{}')
            );
            const [totalScore, setTotalScore] = useState(
                parseInt(localStorage.getItem('totalScore') || '0')
            );
            const [showDifficultySettings, setShowDifficultySettings] = useState(false);
            const [currentMission, setCurrentMission] = useState(null);
            const [isGeneratingPersona, setIsGeneratingPersona] = useState(false);
            const [showPersonaInfo, setShowPersonaInfo] = useState(false);
            
            // ãƒšãƒ«ã‚½ãƒŠè¨­å®š
            const [persona, setPersona] = useState(null);
            const [selectedCategory, setSelectedCategory] = useState('');
            const [painPoints, setPainPoints] = useState([]);
            const [selectedPainPoint, setSelectedPainPoint] = useState('');
            const [customPainPoint, setCustomPainPoint] = useState('');
            const [isGeneratingPainPoints, setIsGeneratingPainPoints] = useState(false);
            
            // APIè¨­å®š
            const [apiKey, setApiKey] = useState(() => {
                if (typeof window === 'undefined') return '';
                try {
                    return localStorage.getItem('apiKey') || '';
                } catch (error) {
                    console.warn('Failed to read apiKey from storage:', error);
                    return '';
                }
            });
            const [apiModel, setApiModel] = useState(() => {
                if (typeof window === 'undefined') return 'deepseek/deepseek-chat-v3.1:free';
                try {
                    return localStorage.getItem('apiModel') || 'deepseek/deepseek-chat-v3.1:free';
                } catch (error) {
                    console.warn('Failed to read apiModel from storage:', error);
                    return 'deepseek/deepseek-chat-v3.1:free';
                }
            });
            const [showApiSettings, setShowApiSettings] = useState(false);
            const [apiTested, setApiTested] = useState(() => {
                if (typeof window === 'undefined') return false;
                try {
                    return localStorage.getItem('apiTested') === 'true';
                } catch (error) {
                    console.warn('Failed to read apiTested flag:', error);
                    return false;
                }
            });
            const [apiTesting, setApiTesting] = useState(false);
            const [isMobile, setIsMobile] = useState(false);
            const [keyboardHeight, setKeyboardHeight] = useState(0);
            const [isInputFocused, setIsInputFocused] = useState(false);

            const gameLogic = useMemo(() => window.GameLogic || null, []);

            // Show API settings on first load if no API key
            useEffect(() => {
                if (!apiKey && !localStorage.getItem('APIkey')) {
                    setShowApiSettings(true);
                }
            }, []); // Run only on mount
            
            // Detect mobile device and handle keyboard
            useEffect(() => {
                const checkMobile = () => {
                    setIsMobile(window.innerWidth <= 768);
                };
                
                checkMobile();
                
                // Set custom viewport height for Android Chrome
                const setVH = () => {
                    const vh = window.innerHeight * 0.01;
                    document.documentElement.style.setProperty('--vh', `${vh}px`);
                };
                
                setVH();
                window.addEventListener('resize', setVH);
                window.addEventListener('orientationchange', setVH);
                
                // Visual Viewport API for keyboard detection (iOS and Android)
                const handleViewportChange = () => {
                    if (window.visualViewport) {
                        const keyboardHeight = window.innerHeight - window.visualViewport.height;
                        setKeyboardHeight(keyboardHeight);
                        
                        // Add class when keyboard is visible
                        if (keyboardHeight > 50) {
                            document.body.classList.add('keyboard-visible');
                        } else {
                            document.body.classList.remove('keyboard-visible');
                        }
                    }
                };
                
                // iOS specific keyboard handling
                const handleFocusIn = (e) => {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                        setIsInputFocused(true);
                        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã¯è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ©Ÿèƒ½ã«ä»»ã›ã‚‹
                        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¡¨ç¤ºæ™‚ã®å¼·åˆ¶ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å‰Šé™¤
                    }
                };
                
                const handleFocusOut = () => {
                    setIsInputFocused(false);
                    // Prevent page from staying scrolled up
                    window.scrollTo(0, 0);
                };
                
                window.addEventListener('resize', checkMobile);
                if (window.visualViewport) {
                    window.visualViewport.addEventListener('resize', handleViewportChange);
                    window.visualViewport.addEventListener('scroll', handleViewportChange);
                }
                document.addEventListener('focusin', handleFocusIn);
                document.addEventListener('focusout', handleFocusOut);
                
                return () => {
                    window.removeEventListener('resize', checkMobile);
                    window.removeEventListener('resize', setVH);
                    window.removeEventListener('orientationchange', setVH);
                    if (window.visualViewport) {
                        window.visualViewport.removeEventListener('resize', handleViewportChange);
                        window.visualViewport.removeEventListener('scroll', handleViewportChange);
                    }
                    document.removeEventListener('focusin', handleFocusIn);
                    document.removeEventListener('focusout', handleFocusOut);
                };
            }, [messagesEndRef]);

            useEffect(() => {
                if (typeof window === 'undefined') return;
                try {
                    localStorage.setItem('apiKey', apiKey);
                } catch (error) {
                    console.warn('Failed to persist apiKey:', error);
                }
            }, [apiKey]);

            useEffect(() => {
                if (typeof window === 'undefined') return;
                try {
                    localStorage.setItem('apiModel', apiModel);
                } catch (error) {
                    console.warn('Failed to persist apiModel:', error);
                }
            }, [apiModel]);

            useEffect(() => {
                if (typeof window === 'undefined') return;
                try {
                    localStorage.setItem('apiTested', apiTested ? 'true' : 'false');
                } catch (error) {
                    console.warn('Failed to persist apiTested flag:', error);
                }
            }, [apiTested]);
            
            // Refs
            const messagesEndRef = useRef(null);
            const inputRef = useRef(null);
            const chatAreaRef = useRef(null);
            
            // ãƒ†ãƒ¼ãƒã‚«ãƒ†ã‚´ãƒªãƒ¼
            const themeCategories = [
                { id: 'commute', title: 'é€šå‹¤ãƒ»ç§»å‹•', icon: 'ğŸšƒ' },
                { id: 'work', title: 'ä»•äº‹ãƒ»å­¦ç¿’', icon: 'ğŸ’¼' },
                { id: 'life', title: 'ç”Ÿæ´»ãƒ»å®¶äº‹', icon: 'ğŸ ' },
                { id: 'health', title: 'å¥åº·ãƒ»é‹å‹•', icon: 'ğŸ’ª' },
                { id: 'social', title: 'äººé–“é–¢ä¿‚', icon: 'ğŸ‘¥' },
                { id: 'hobby', title: 'è¶£å‘³ãƒ»å¨¯æ¥½', icon: 'ğŸ®' }
            ];
            
            // ãƒšã‚¤ãƒ³ãƒã‚¤ãƒ³ãƒˆç”Ÿæˆé–¢æ•°ï¼ˆãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãï¼‰
            const generatePainPoints = useCallback(async (category, retryCount = 0) => {
                if (!apiKey || !apiTested) {
                    showToast('APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„', 'error');
                    return [];
                }
                
                const maxRetries = 2;
                
                // AIç”Ÿæˆ
                try {
                    const categoryInfo = themeCategories.find(c => c.id === category);
                    
                    // ãƒ‡ãƒãƒƒã‚°: ãƒ¢ãƒ‡ãƒ«åã‚’ç¢ºèª
                    console.log('Generating scenario with model:', apiModel);
                    
                    // Sonoma Sky Alphaç”¨ã«è‹±èªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½¿ç”¨
                    const isSonoma = apiModel && apiModel.includes('sonoma');
                    
                    const prompt = isSonoma ? 
                        // English prompt for Sonoma Sky Alpha
                        `Generate 3 specific pain points that people commonly experience in the "${categoryInfo.title}" category.

Examples:
- Having difficulty taking buses
- Unable to handle stress in crowded trains
- Can't find the right timing to speak in online meetings

Respond with JSON:
{
  "painPoints": [
    "specific problem 1",
    "specific problem 2",
    "specific problem 3"
  ]
}` :
                        // Japanese prompt for DeepSeek models
                        `${categoryInfo.title}ã‚«ãƒ†ã‚´ãƒªãƒ¼ã§ã€ä¸€èˆ¬çš„ãªäººãŒæŠ±ãˆã‚‹å…·ä½“çš„ãªå›°ã‚Šã”ã¨ï¼ˆãƒšã‚¤ãƒ³ãƒã‚¤ãƒ³ãƒˆï¼‰ã‚’3ã¤ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

ä¾‹ï¼š
- ãƒã‚¹ã«ä¹—ã‚‹ã®ãŒè‹¦æ‰‹ã§å›°ã£ã¦ã„ã‚‹
- æº€å“¡é›»è»Šã§ã®ã‚¹ãƒˆãƒ¬ã‚¹ãŒè€ãˆã‚‰ã‚Œãªã„
- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ä¼šè­°ã§ç™ºè¨€ã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒæ´ã‚ãªã„

ä»¥ä¸‹ã®JSONå½¢å¼ã§å¿œç­”:
{
  "painPoints": [
    "å…·ä½“çš„ãªå›°ã‚Šã”ã¨1",
    "å…·ä½“çš„ãªå›°ã‚Šã”ã¨2",
    "å…·ä½“çš„ãªå›°ã‚Šã”ã¨3"
  ]
}`;

                    const systemPrompt = isSonoma ?
                        'You are a helpful assistant. Generate realistic pain points in Japanese. Respond only with valid JSON.' :
                        'ãƒªã‚¢ãƒ«ã§å…·ä½“çš„ãªå›°ã‚Šã”ã¨ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚JSONå½¢å¼ã§å¿œç­”ã€‚';
                    
                    const response = await safariFetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json',
                            'HTTP-Referer': window.location.origin || 'http://localhost',
                            'X-Title': 'Pain Point Generation'
                        },
                        body: JSON.stringify({
                            model: apiModel || 'deepseek/deepseek-chat-v3.1:free',
                            messages: [
                                { role: 'system', content: systemPrompt },
                                { role: 'user', content: prompt }
                            ],
                            temperature: isSonoma ? 0.5 : 0.8,
                            max_tokens: isSonoma ? 8000 : 2000 // Sonoma: 8000, DeepSeek: 2000
                        })
                    }, 20000); // 20 second timeout for Safari
                    
                    if (!response.ok) {
                        const errorData = await response.text();
                        console.error('API Error Response:', errorData);
                        console.error('Using model:', modelToUse);
                        throw new Error(`API request failed: ${response.status} - ${errorData}`);
                    }
                    
                    const data = await response.json();
                    if (!data.choices || !data.choices[0]) {
                        throw new Error('Invalid API response');
                    }
                    
                    const content = data.choices[0].message.content;
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const parsed = JSON.parse(jsonMatch[0]);
                        return parsed.painPoints || [];
                    }
                    return [];
                } catch (error) {
                    console.error(`Pain point generation error (attempt ${retryCount + 1}):`, error);
                    console.error('Model:', apiModel);
                    
                    // Sonoma Sky Alpha specific debugging
                    if (apiModel === 'openrouter/sonoma-sky-alpha') {
                        console.error('=== Sonoma Sky Alpha Debug Info ===');
                        console.error('Model name:', apiModel);
                        console.error('API Key present:', !!apiKey);
                        console.error('Error details:', error.message);
                        console.error('Full error:', error);
                        console.error('===================================');
                    }
                    
                    if (retryCount < maxRetries) {
                        console.log(`Retrying... (attempt ${retryCount + 2}/${maxRetries + 1})`);
                        showToast(`å†è©¦è¡Œä¸­... (${retryCount + 2}/${maxRetries + 1})`, 'info');
                        
                        // Wait a bit before retrying
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        // Recursive retry
                        return generatePainPoints(category, retryCount + 1);
                    }
                    
                    // All retries failed
                    const errorMsg = apiModel === 'openrouter/sonoma-sky-alpha'
                        ? 'Sonoma Sky Alphaã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä»–ã®ãƒ¢ãƒ‡ãƒ«ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚'
                        : 'ãŠé¡Œã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                    showToast(errorMsg, 'error');
                    throw error;
                }
            }, [apiKey, apiModel, apiTested, showToast]);
            
            // AIãƒšãƒ«ã‚½ãƒŠç”Ÿæˆæ©Ÿèƒ½
            const generatePersonaWithAI = useCallback(async (painPoint) => {
                if (!apiKey || !apiTested) {
                    showToast('AIãƒšãƒ«ã‚½ãƒŠç”Ÿæˆã«ã¯APIè¨­å®šãŒå¿…è¦ã§ã™', 'error');
                    return null;
                }
                
                try {
                    setIsGeneratingPersona(true);
                    showToast('AIãŒãƒšãƒ«ã‚½ãƒŠã‚’ç”Ÿæˆä¸­...', 'info');
                    
                    console.log('Generating persona with model:', apiModel);
                    
                    const promptText = `
ä»¥ä¸‹ã®å›°ã‚Šã”ã¨ï¼ˆãƒšã‚¤ãƒ³ãƒã‚¤ãƒ³ãƒˆï¼‰ã‚’æŠ±ãˆã¦ã„ã‚‹æ¶ç©ºã®äººç‰©ï¼ˆãƒšãƒ«ã‚½ãƒŠï¼‰ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
ãƒšã‚¤ãƒ³ãƒã‚¤ãƒ³ãƒˆ: ${painPoint}

ãƒªã‚¢ãƒ«ã§è‡ªç„¶ãªãƒšãƒ«ã‚½ãƒŠã‚’ä½œæˆã—ã€å¿…ãšå®Œå…¨ãªæœ‰åŠ¹ãªJSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
æ–‡ç« ã¯çŸ­ãã¾ã¨ã‚ã€JSONãŒé€”ä¸­ã§åˆ‡ã‚Œãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„ï¼š
{
  "name": "æ—¥æœ¬äººã®åå‰ï¼ˆãƒ•ãƒ«ãƒãƒ¼ãƒ ï¼‰",
  "gender": "ç”·æ€§ã¾ãŸã¯å¥³æ€§",
  "age": å¹´é½¢ï¼ˆ20-60ã®æ•´æ•°ï¼‰,
  "job": "å…·ä½“çš„ãªè·æ¥­",
  "location": "å…·ä½“çš„ãªå±…ä½åœ°ï¼ˆéƒ½å¸‚åã‚„åœ°åŸŸï¼‰",
  "family": "å®¶æ—æ§‹æˆï¼ˆç‹¬èº«ã€æ—¢å©šãªã©å…·ä½“çš„ã«ï¼‰",
  "hobbies": ["è¶£å‘³1", "è¶£å‘³2"],
  "personality": {
    "traits": ["æ€§æ ¼ç‰¹æ€§1", "æ€§æ ¼ç‰¹æ€§2", "æ€§æ ¼ç‰¹æ€§3"],
    "communication_style": "ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«"
  },
  "background": "èƒŒæ™¯ï¼ˆ1-2æ–‡ã§ç°¡æ½”ã«ï¼‰",
  "painPoints": ["èª²é¡Œ1", "èª²é¡Œ2", "èª²é¡Œ3"],
  "hiddenNeeds": ["ãƒ‹ãƒ¼ã‚º1", "ãƒ‹ãƒ¼ã‚º2"],
  "currentSituation": "ç¾çŠ¶ï¼ˆ1-2æ–‡ã§ç°¡æ½”ã«ï¼‰"
}

é‡è¦ï¼š
- ä¸ãˆã‚‰ã‚ŒãŸãƒšã‚¤ãƒ³ãƒã‚¤ãƒ³ãƒˆã‚’å¿…ãšä¸»è¦ãªæ‚©ã¿ã¨ã—ã¦å«ã‚ã¦ãã ã•ã„
- painPointsï¼ˆèª²é¡Œï¼‰ã®1ã¤ç›®ã¯å¿…ãšã€Œ${painPoint}ã€ã«ã—ã¦ãã ã•ã„
- æ®‹ã‚Š2ã¤ã¯é–¢é€£ã™ã‚‹å…·ä½“çš„ãªå•é¡Œã‚’è¿½åŠ ã—ã¦ãã ã•ã„
- hiddenNeedsï¼ˆéš ã‚ŒãŸãƒ‹ãƒ¼ã‚ºï¼‰ã¯ã“ã®ãƒšã‚¤ãƒ³ãƒã‚¤ãƒ³ãƒˆã‚’è§£æ±ºã—ãŸã„æœ¬å½“ã®ç†ç”±ã‚’2ã¤æŒ™ã’ã¦ãã ã•ã„
- ãƒšãƒ«ã‚½ãƒŠã¯ã“ã®ãƒšã‚¤ãƒ³ãƒã‚¤ãƒ³ãƒˆã«å®Ÿéš›ã«å›°ã£ã¦ã„ã‚‹äººã¨ã—ã¦æŒ¯ã‚‹èˆã„ã¾ã™
- çŸ›ç›¾ã—ãŸå›ç­”ï¼ˆä¾‹ï¼šå›°ã£ã¦ã„ã‚‹ã®ã«ã€Œå•é¡Œãªã„ã€ã¨ç­”ãˆã‚‹ï¼‰ã¯çµ¶å¯¾ã«ã—ã¾ã›ã‚“`;
                    
                    const response = await safariFetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json',
                            'HTTP-Referer': window.location.origin || 'http://localhost',
                            'X-Title': 'Interview Game'
                        },
                        body: JSON.stringify({
                            model: apiModel,
                            messages: [
                                { 
                                    role: 'system', 
                                    content: 'ã‚ãªãŸã¯ãƒšãƒ«ã‚½ãƒŠä½œæˆã®å°‚é–€å®¶ã§ã™ã€‚ãƒªã‚¢ãƒ«ã§è©³ç´°ãªäººç‰©è¨­å®šã‚’ä½œæˆã—ã€å¿…ãšJSONå½¢å¼ã§å¿œç­”ã—ã¦ãã ã•ã„ã€‚' 
                                },
                                { role: 'user', content: promptText }
                            ],
                            temperature: 0.9,
                            max_tokens: apiModel === 'openrouter/sonoma-sky-alpha' ? 8000 : 3000 // Sonoma: 8000, DeepSeek: 3000
                        })
                    }, 20000);
                    
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('API Response:', data);
                    
                    if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                        throw new Error('Invalid API response structure');
                    }
                    
                    const content = data.choices[0].message.content || '';
                    
                    // ç©ºã®å¿œç­”ã‚’ãƒã‚§ãƒƒã‚¯
                    if (!content || content.trim().length < 10) {
                        console.log('Empty or too short API response, using fallback');
                        throw new Error('Empty API response');
                    }
                    
                    // JSONãƒ‘ãƒ¼ã‚¹è©¦è¡Œï¼ˆæ”¹å–„ç‰ˆï¼‰
                    let parsedPersona;
                    try {
                        // JSONãƒ–ãƒ­ãƒƒã‚¯ã‚’æŠ½å‡º
                        let jsonStr = content;
                        
                        // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’é™¤å»
                        if (content.includes('```json')) {
                            const match = content.match(/```json\n?([\s\S]*?)\n?```/);
                            if (match) jsonStr = match[1];
                        } else if (content.includes('```')) {
                            const match = content.match(/```\n?([\s\S]*?)\n?```/);
                            if (match) jsonStr = match[1];
                        }
                        
                        // ä¸å®Œå…¨ãªJSONã‚’æ¤œå‡ºã—ã¦ä¿®å¾©
                        if (!jsonStr.trim().endsWith('}')) {
                            console.log('Incomplete JSON detected, attempting to fix...');
                            
                            // æœ€å¾Œã®å®Œå…¨ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¾ã§ã§åˆ‡ã‚‹
                            const lines = jsonStr.split('\n');
                            let lastValidLine = -1;
                            
                            for (let i = lines.length - 1; i >= 0; i--) {
                                const line = lines[i].trim();
                                if (line.endsWith(',') || line.endsWith('}') || line.endsWith(']')) {
                                    lastValidLine = i;
                                    break;
                                }
                            }
                            
                            if (lastValidLine >= 0) {
                                jsonStr = lines.slice(0, lastValidLine + 1).join('\n');
                                // æœ€å¾Œã®ã‚«ãƒ³ãƒã‚’å‰Šé™¤
                                if (jsonStr.trim().endsWith(',')) {
                                    jsonStr = jsonStr.trim().slice(0, -1);
                                }
                            }
                            
                            // é–‹ã„ã¦ã„ã‚‹ãƒ–ãƒ©ã‚±ãƒƒãƒˆã‚’æ•°ãˆã‚‹
                            const openBraces = (jsonStr.match(/\{/g) || []).length;
                            const closeBraces = (jsonStr.match(/\}/g) || []).length;
                            const openBrackets = (jsonStr.match(/\[/g) || []).length;
                            const closeBrackets = (jsonStr.match(/\]/g) || []).length;
                            
                            // ä¸è¶³ã—ã¦ã„ã‚‹é–‰ã˜æ‹¬å¼§ã‚’è¿½åŠ 
                            for (let i = 0; i < openBrackets - closeBrackets; i++) {
                                jsonStr += ']';
                            }
                            
                            // ä¸è¶³ã—ã¦ã„ã‚‹é–‰ã˜æ³¢æ‹¬å¼§ã‚’è¿½åŠ 
                            for (let i = 0; i < openBraces - closeBraces; i++) {
                                jsonStr += '}';
                            }
                        }
                        
                        // JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æŠ½å‡º
                        const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            jsonStr = jsonMatch[0];
                        }
                        
                        // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚ŒãŸå¼•ç”¨ç¬¦ã‚’ä¿®æ­£ï¼ˆæœ€åˆã«å‡¦ç†ï¼‰
                        jsonStr = jsonStr.replace(/\\"/g, '"');
                        
                        // ä¸€èˆ¬çš„ãªJSONå½¢å¼ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£
                        jsonStr = jsonStr
                            .replace(/,\s*}/g, '}')  // æœ«å°¾ã®ã‚«ãƒ³ãƒã‚’å‰Šé™¤
                            .replace(/,\s*]/g, ']')  // é…åˆ—æœ«å°¾ã®ã‚«ãƒ³ãƒã‚’å‰Šé™¤
                            .replace(/"\s*:\s*"([^"]*)"([^,}\]]*[,}\]])/g, '": "$1"$2')  // ã‚³ãƒ­ãƒ³å¾Œã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä¿®æ­£
                            .replace(/\n\s*\n/g, '\n')  // ä½™åˆ†ãªæ”¹è¡Œã‚’å‰Šé™¤
                            .replace(/,(\s*[}\]])/g, '$1'); // æœ€å¾Œã®ã‚«ãƒ³ãƒã‚’å‰Šé™¤
                        
                        console.log('Attempting to parse JSON:', jsonStr.substring(0, 500) + '...');
                        parsedPersona = JSON.parse(jsonStr);
                        
                    } catch (e) {
                        console.error('Persona JSON Parse Error:', e, '\nContent:', content);
                        
                        // ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼æ™‚ã¯åŸºæœ¬çš„ãªãƒšãƒ«ã‚½ãƒŠã‚’ä½œæˆ
                        parsedPersona = {
                            name: 'å±±ç”°å¤ªéƒ',
                            gender: 'ç”·æ€§',
                            age: 35,
                            job: 'ä¼šç¤¾å“¡',
                            location: 'æ±äº¬éƒ½',
                            family: 'æ—¢å©šï¼ˆå­ä¾›1äººï¼‰',
                            hobbies: ['èª­æ›¸', 'æ•£æ­©'],
                            personality: {
                                traits: ['çœŸé¢ç›®', 'å”èª¿çš„', 'æ…é‡'],
                                communication_style: 'ä¸å¯§ã§è½ã¡ç€ã„ãŸè©±ã—æ–¹'
                            },
                            background: `${painPoint}ã§å›°ã£ã¦ã„ã‚‹ç¤¾ä¼šäººã§ã™ã€‚`,
                            painPoints: [painPoint, 'æ™‚é–“ä¸è¶³', 'ã‚¹ãƒˆãƒ¬ã‚¹'],
                            hiddenNeeds: ['å•é¡Œè§£æ±º', 'å¿«é©ãªç”Ÿæ´»'],
                            currentSituation: `ç¾åœ¨ã€${painPoint}ã¨ã„ã†èª²é¡Œã‚’è§£æ±ºã—ãŸã„ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚`
                        };
                        
                        console.log('Using fallback persona due to parse error');
                    }
                    
                    // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ç¢ºèªã¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®š
                    const persona = {
                        name: parsedPersona.name || 'ç”°ä¸­å¤ªéƒ',
                        gender: parsedPersona.gender || 'ç”·æ€§',
                        age: parsedPersona.age || 35,
                        job: parsedPersona.job || 'ä¼šç¤¾å“¡',
                        location: parsedPersona.location || 'æ±äº¬éƒ½',
                        family: parsedPersona.family || 'ç‹¬èº«',
                        hobbies: parsedPersona.hobbies || ['èª­æ›¸', 'æ˜ ç”»é‘‘è³'],
                        personality: {
                            openness: Math.random(),
                            empathy: Math.random(),
                            guardedness: Math.random(),
                            traits: parsedPersona.personality?.traits || [],
                            communication_style: parsedPersona.personality?.communication_style || 'æ™®é€š'
                        },
                        background: parsedPersona.background || '',
                        painPoints: parsedPersona.painPoints || [],
                        hiddenNeeds: parsedPersona.hiddenNeeds || [],
                        currentSituation: parsedPersona.currentSituation || '',
                        currentMood: 'normal'
                    };
                    
                    // AIç”ŸæˆæˆåŠŸã®å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    if (parsedPersona && parsedPersona.name && parsedPersona.name !== 'å±±ç”°å¤ªéƒ') {
                        showToast('AIãƒšãƒ«ã‚½ãƒŠã®ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'success');
                    } else {
                        showToast('AIãƒšãƒ«ã‚½ãƒŠã‚’ç°¡æ˜“ç”Ÿæˆã—ã¾ã—ãŸ', 'info');
                    }
                    
                    return persona;
                    
                } catch (error) {
                    console.error('AI Persona Generation Error:', error);
                    showToast('AIãƒšãƒ«ã‚½ãƒŠç”Ÿæˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚åŸºæœ¬ãƒšãƒ«ã‚½ãƒŠã‚’ä½¿ç”¨ã—ã¾ã™ã€‚', 'warning');
                    
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚åŸºæœ¬çš„ãªãƒšãƒ«ã‚½ãƒŠã‚’è¿”ã™
                    const fallbackPainPoint = 'ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ãŒè‹¦æ‰‹ã§å›°ã£ã¦ã„ã‚‹';
                    return {
                        name: 'éˆ´æœ¨èŠ±å­',
                        gender: 'å¥³æ€§',
                        age: 30,
                        job: 'ä¼šç¤¾å“¡',
                        location: 'æ±äº¬éƒ½',
                        family: 'ç‹¬èº«',
                        hobbies: ['ã‚«ãƒ•ã‚§å·¡ã‚Š', 'èª­æ›¸'],
                        personality: {
                            openness: 0.7,
                            empathy: 0.8,
                            guardedness: 0.3,
                            traits: ['ç¤¾äº¤çš„', 'å¥½å¥‡å¿ƒæ—ºç››', 'å‰å‘ã'],
                            communication_style: 'è¦ªã—ã¿ã‚„ã™ã„è©±ã—æ–¹'
                        },
                        background: `éƒ½å†…ã§åƒãä¼šç¤¾å“¡ã§ã™ã€‚${fallbackPainPoint}`,
                        painPoints: [fallbackPainPoint, 'æ™‚é–“ç®¡ç†', 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¸è¶³'],
                        hiddenNeeds: ['è‡ªä¿¡ã‚’æŒã¡ãŸã„', 'åŠ¹æœçš„ãªè³ªå•ã‚¹ã‚­ãƒ«'],
                        currentSituation: `${fallbackPainPoint}ã¨ã„ã†çŠ¶æ³ã‚’æ”¹å–„ã—ãŸã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚`,
                        currentMood: 'normal'
                    };
                } finally {
                    setIsGeneratingPersona(false);
                }
            }, [apiKey, apiModel, apiTested, showToast, generatePersona]);
            
            // ãƒšãƒ«ã‚½ãƒŠç”Ÿæˆï¼ˆæ‰‹å‹•ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
            const generatePersona = useCallback((painPoint) => {
                // ãƒšã‚¤ãƒ³ãƒã‚¤ãƒ³ãƒˆã«åŸºã¥ã„ãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒšãƒ«ã‚½ãƒŠã‚’ç”Ÿæˆ
                return {
                    name: 'å±±ç”°å¤ªéƒ',
                    gender: 'ç”·æ€§',
                    age: 35,
                    job: 'ä¼šç¤¾å“¡',
                    location: 'æ±äº¬éƒ½',
                    family: 'ç‹¬èº«',
                    hobbies: ['èª­æ›¸', 'æ˜ ç”»é‘‘è³'],
                    personality: {
                        openness: 0.5,
                        empathy: 0.5,
                        guardedness: 0.5
                    },
                    hiddenNeeds: ['ã‚¹ãƒˆãƒ¬ã‚¹ãƒ•ãƒªãƒ¼ãªç”Ÿæ´»', 'åŠ¹ç‡çš„ãªè§£æ±ºç­–'],
                    painPoints: [painPoint, 'æ™‚é–“çš„ä½™è£•ã®ãªã•', 'ã‚¹ãƒˆãƒ¬ã‚¹ã®è“„ç©'],
                    currentMood: 'normal',
                    background: `${painPoint}ã§æ—¥ã€…å›°ã£ã¦ã„ã‚‹ä¼šç¤¾å“¡`,
                    currentSituation: `${painPoint}ã‚’ã©ã†ã«ã‹è§£æ±ºã—ãŸã„ã¨æ€ã£ã¦ã„ã‚‹`
                };
            }, [gameLogic]);
            
            // ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆæ”¹å–„ç‰ˆ - å…±é€šãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ©ç”¨ï¼‰
            const calculateScore = useCallback((question, previousContext) => {
                if (gameLogic?.calculateScore) {
                    return gameLogic.calculateScore(question, previousContext, {
                        mood,
                        difficulty,
                        challengeMode,
                        currentMission,
                        scoreHistory
                    });
                }
                return {
                    score: 50,
                    breakdown: {
                        depth: 0,
                        empathy: 0,
                        exploration: 0,
                        context: 0,
                        penalty: 0,
                        bonus: 0,
                        combo: 0
                    }
                };
            }, [gameLogic, mood, difficulty, challengeMode, currentMission, scoreHistory]);
            
            // APIãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
            const testAPI = useCallback(async () => {
                if (!apiKey) {
                    showToast('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                    return false;
                }
                
                setApiTesting(true);
                try {
                    const requestBody = {
                        model: apiModel,
                        messages: [
                            { role: 'user', content: 'ãƒ†ã‚¹ãƒˆæ¥ç¶šã§ã™ã€‚ç°¡æ½”ã«å¿œç­”ã—ã¦ãã ã•ã„ã€‚' }
                        ],
                        max_tokens: 100,
                        temperature: 0.7
                    };
                    
                    console.log('Testing API with model:', apiModel);
                    
                    const response = await safariFetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json',
                            'HTTP-Referer': window.location.origin || 'http://localhost',
                            'X-Title': 'Interview Game'
                        },
                        body: JSON.stringify(requestBody)
                    }, 10000);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        let errorMsg = `API Error: ${response.status}`;
                        
                        try {
                            const errorJson = JSON.parse(errorText);
                            errorMsg = errorJson.error?.message || errorMsg;
                        } catch {
                            errorMsg = errorText || errorMsg;
                        }
                        
                        // Sonoma Sky Alpha specific error handling
                        if (apiModel === 'openrouter/sonoma-sky-alpha') {
                            console.error('=== Sonoma Sky Alpha Connection Failed ===');
                            console.error('Status:', response.status);
                            console.error('Error:', errorMsg);
                            console.error('Headers:', response.headers);
                            
                            if (response.status === 403 || response.status === 401) {
                                errorMsg = 'Sonoma Sky Alphaã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                            } else if (response.status === 404) {
                                errorMsg = 'Sonoma Sky Alphaãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';
                            }
                        }
                        
                        throw new Error(errorMsg);
                    }
                    
                    const data = await response.json();
                    if (data.choices && data.choices[0]) {
                        setApiTested(true);
                        showToast('APIæ¥ç¶šæˆåŠŸï¼ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã§ãã¾ã™', 'success');
                        return true;
                    }
                    throw new Error('Invalid API response');
                    
                } catch (error) {
                    console.error('API Test Error:', error);
                    
                    // Sonoma Sky Alpha fallback suggestion
                    if (apiModel === 'openrouter/sonoma-sky-alpha') {
                        setApiTested(false);
                        showToast('Sonoma Sky Alphaã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚DeepSeekãƒ¢ãƒ‡ãƒ«ã®ä½¿ç”¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚', 'error');
                        
                        // Suggest switching to DeepSeek
                        setTimeout(() => {
                            if (window.confirm('DeepSeek Chat V3.1ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã‹ï¼Ÿ')) {
                                setApiModel('deepseek/deepseek-chat-v3.1:free');
                                showToast('DeepSeek Chat V3.1ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸã€‚å†åº¦ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚', 'info');
                            }
                        }, 500);
                    } else {
                        setApiTested(false);
                        showToast(`APIæ¥ç¶šå¤±æ•—: ${error.message}`, 'error');
                    }
                    return false;
                } finally {
                    setApiTesting(false);
                }
            }, [apiKey, apiModel, showToast]);
            
            // AIå¿œç­”ç”Ÿæˆ
            const generateAIResponse = useCallback(async (question) => {
                setIsTyping(true);

                // APIã‚­ãƒ¼ãŒãªã„ã€ã¾ãŸã¯ãƒ†ã‚¹ãƒˆã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
                if (!apiKey || !apiTested) {
                    setIsTyping(false);
                    showToast('APIãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è¨­å®šç”»é¢ã§APIã‚’ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚', 'error');
                    return {
                        response: 'APIãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚',
                        score: 0,
                        breakdown: {},
                        newMood: mood,
                        insight: null
                    };
                }
                
                console.log('Generating response with model:', apiModel);
                
                // OpenRouter APIå‘¼ã³å‡ºã—ï¼ˆãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãï¼‰
                const maxRetries = 3;
                let retryCount = 0;
                let lastError = null;
                
                while (retryCount < maxRetries) {
                    try {
                        if (retryCount > 0) {
                            console.log(`Retry attempt ${retryCount} of ${maxRetries}`);
                            showToast(`å†è©¦è¡Œä¸­... (${retryCount}/${maxRetries})`, 'info');
                            await new Promise(resolve => setTimeout(resolve, 1000 * retryCount)); // å¢—åˆ†å¾…æ©Ÿ
                        }
                        
                        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’çŸ­ãã—ã¦ç¢ºå®Ÿã«å¿œç­”ã‚’å¾—ã‚‹
                        const moodDescription = {
                            open: 'é–‹æ”¾çš„ã§ã€å‰å‘ãã«è©±ã—ãŸãŒã£ã¦ã„ã‚‹ã€‚è§£æ±ºã¸ã®æœŸå¾…ã‚’æŒã£ã¦ã„ã‚‹',
                            normal: 'æ™®é€šã«ä¼šè©±ã—ã¦ã„ã‚‹ã€‚é©åº¦ãªå”åŠ›å§¿å‹¢',
                            guard: 'å°‘ã—è­¦æˆ’ã—ã¦ã„ã‚‹ãŒã€è©±ã™æ„æ¬²ã¯ã‚ã‚‹',
                            close: 'å¿ƒã‚’é–‰ã–ã—æ°—å‘³ã ãŒã€è‰¯ã„è³ªå•ã«ã¯åå¿œã—ãŸã„'
                        };
                        
                        const conversationHistory = messages.slice(-4).map(m => 
                            `${m.type === 'user' ? 'ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼' : persona.name}: ${m.content}`
                        ).join('\n');
                        
                        const promptText = `ã‚ãªãŸã¯${persona.name}ï¼ˆ${persona.age}æ­³ã€${persona.gender}ï¼‰ã§ã™ã€‚
è·æ¥­: ${persona.job}
å ´æ‰€: ${persona.location}
å®¶æ—: ${persona.family}
è¶£å‘³: ${persona.hobbies.join('ã€')}
æ‚©ã¿ãƒ»èª²é¡Œ: ${persona.painPoints && persona.painPoints.length > 0 ? persona.painPoints.join('ã€') : 'ç‰¹ã«ãªã—'}
éš ã‚ŒãŸãƒ‹ãƒ¼ã‚º: ${persona.hiddenNeeds && persona.hiddenNeeds.length > 0 ? persona.hiddenNeeds.join('ã€') : 'ç‰¹ã«ãªã—'}
ç¾åœ¨ã®æ°—åˆ†: ${moodDescription[mood]}
è©±é¡Œ: ${persona.painPoints && persona.painPoints[0] ? persona.painPoints[0] : 'æ—¥å¸¸ã®å›°ã‚Šã”ã¨'}

é‡è¦ãªæŒ‡ç¤º:
- æ‚©ã¿ã¯æŠ±ãˆã¦ã„ã‚‹ãŒã€å®Œå…¨ã«ãƒã‚¬ãƒ†ã‚£ãƒ–ã§ã¯ãªãã€è§£æ±ºã¸ã®æ„æ¬²ã‚‚æŒã£ã¦ã„ã¾ã™
- æ™‚ã«ã¯å‰å‘ããªé¢ã‚„ã€å°ã•ãªå–œã³ã‚‚è¡¨ç¾ã—ã¦ãã ã•ã„
- äººé–“å‘³ã®ã‚ã‚‹ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸå¿œç­”ã‚’ã—ã¦ãã ã•ã„
- è‰¯ã„è³ªå•ã«ã¯ç´ ç›´ã«å–œã³ã€å”åŠ›çš„ãªæ…‹åº¦ã‚’ç¤ºã—ã¦ãã ã•ã„
- éš ã‚ŒãŸãƒ‹ãƒ¼ã‚ºã¯ç›´æ¥è¨€ã‚ãšã€ãã‚Œã¨ãªãç¤ºã—ã¦ãã ã•ã„

ä¼šè©±å±¥æ­´:
${conversationHistory}

ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼ã®è³ªå•: ${question}

è³ªå•ã‚’è©•ä¾¡ã—ã¦å¿œç­”ã—ã¦ãã ã•ã„ã€‚è©•ä¾¡åŸºæº–:
- æ·±æ˜ã‚ŠåŠ›ï¼ˆãªãœãƒ»ã©ã†ã—ã¦ã‚’èã„ã¦ã„ã‚‹ã‹ï¼‰
- å…±æ„ŸåŠ›ï¼ˆæ„Ÿæƒ…ã¸ã®ç†è§£ã‚’ç¤ºã—ã¦ã„ã‚‹ã‹ï¼‰
- æ¢ç´¢åŠ›ï¼ˆã‚ªãƒ¼ãƒ—ãƒ³ãªè³ªå•ã‹ï¼‰
- æ–‡è„ˆåŠ›ï¼ˆå‰ã®ä¼šè©±ã‚’è¸ã¾ãˆã¦ã„ã‚‹ã‹ï¼‰

ä»¥ä¸‹ã®JSONå½¢å¼ã§å¿œç­”:
{
  "response": "ãƒšãƒ«ã‚½ãƒŠã¨ã—ã¦è‡ªç„¶ã§äººé–“å‘³ã®ã‚ã‚‹è¿”ç­”ï¼ˆ1-3æ–‡ï¼‰ã€‚æ™‚ã«ã¯æ„Ÿè¬ã‚„æœŸå¾…ã‚‚è¡¨ç¾",
  "score": è³ªå•ã®è©•ä¾¡ç‚¹(0-100),
  "scoreBreakdown": {
    "depth": æ·±æ˜ã‚Šç‚¹(0-35),
    "empathy": å…±æ„Ÿç‚¹(0-25),
    "exploration": æ¢ç´¢ç‚¹(0-30),
    "context": æ–‡è„ˆç‚¹(0-10)
  },
  "newMood": "æ–°ã—ã„æ°—åˆ†(open/normal/guard/close) - è‰¯ã„è³ªå•ãªã‚‰é–‹æ”¾çš„ã«ã€æ‚ªã„è³ªå•ãªã‚‰é–‰ã˜ã¦ã„ã",
  "insight": "é‡è¦ãªç™ºè¦‹ãŒã‚ã‚Œã°è¨˜è¼‰ï¼ˆãªã‘ã‚Œã°nullï¼‰",
  "moodReason": "æ°—åˆ†ãŒå¤‰ã‚ã£ãŸç†ç”±ï¼ˆ1æ–‡ï¼‰"
}`;
                    
                    const response = await safariFetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json',
                            'HTTP-Referer': window.location.origin || 'http://localhost',
                            'X-Title': 'Interview Game'
                        },
                        body: JSON.stringify({
                            model: apiModel,
                            messages: [
                                { 
                                    role: 'system', 
                                    content: 'ã‚ãªãŸã¯æŒ‡å®šã•ã‚ŒãŸãƒšãƒ«ã‚½ãƒŠã«ãªã‚Šãã£ã¦å¿œç­”ã—ã¾ã™ã€‚é‡è¦ï¼šãƒªã‚¢ãƒ«ã§å…±æ„Ÿã§ãã‚‹äººé–“ã¨ã—ã¦æŒ¯ã‚‹èˆã£ã¦ãã ã•ã„ã€‚æ‚©ã¿ã¯ã‚ã‚‹ãŒå‰å‘ããªé¢ã‚‚æŒã¡ã€ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼ã¨ã®å»ºè¨­çš„ãªå¯¾è©±ã‚’æœ›ã‚“ã§ã„ã¾ã™ã€‚éåº¦ã«ãƒã‚¬ãƒ†ã‚£ãƒ–ã«ãªã‚‰ãšã€æ™‚ã«ã¯æ„Ÿè¬ã‚„æœŸå¾…ã€å°ã•ãªå–œã³ã‚‚è¡¨ç¾ã—ã¦ãã ã•ã„ã€‚å¿…ãšæœ‰åŠ¹ãªJSONå½¢å¼ã§å¿œç­”ã—ã€JSONã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã¯ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã‚“ã§ãã ã•ã„ã€‚' 
                                },
                                { role: 'user', content: promptText }
                            ],
                            temperature: 0.7,
                            max_tokens: apiModel === 'openrouter/sonoma-sky-alpha' ? 8000 : 4000 // Sonoma: 8000, DeepSeek: 4000
                        })
                    }, 20000);
                    
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('API Response:', data);
                    
                    // å¿œç­”ãŒç©ºã¾ãŸã¯ç„¡åŠ¹ãªå ´åˆã®ãƒã‚§ãƒƒã‚¯
                    if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                        console.error('Invalid API response structure:', data);
                        throw new Error('Invalid API response structure');
                    }
                    
                    // contentãŒå­˜åœ¨ã—ãªã„ã€ã¾ãŸã¯ç©ºã®å ´åˆ
                    if (!data.choices[0].message.content || data.choices[0].message.content.trim() === '') {
                        console.error('Empty content in API response:', data);
                        throw new Error('Empty content in API response');
                    }
                    
                    const content = data.choices[0].message.content;
                    
                    // ç©ºã®å†…å®¹ã‚’ãƒã‚§ãƒƒã‚¯
                    if (!content || content.trim() === '') {
                        console.log('Empty content received from API, will retry...');
                        throw new Error('Empty API response');
                    }
                    
                    // JSONãƒ‘ãƒ¼ã‚¹è©¦è¡Œ
                    let parsedResponse;
                    try {
                        // JSONãƒ–ãƒ­ãƒƒã‚¯ã‚’æŠ½å‡ºï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã«å¯¾å¿œï¼‰
                        const jsonMatch = content.match(/```json\n?([\s\S]*?)\n?```/) || 
                                         content.match(/```\n?([\s\S]*?)\n?```/) ||
                                         content.match(/\{[\s\S]*\}/);
                        
                        let jsonStr = jsonMatch ? 
                            (jsonMatch[1] || jsonMatch[0]).replace(/```json\n?|```\n?|```/g, '') : 
                            content;
                        
                        // ã‚ˆãã‚ã‚‹JSONã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£
                        jsonStr = jsonStr
                            .replace(/" "/g, '""') // ä½™åˆ†ãªã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤
                            .replace(/,\s*\}/g, '}') // æœ«å°¾ã®ã‚«ãƒ³ãƒã‚’å‰Šé™¤
                            .replace(/,\s*\]/g, ']') // é…åˆ—æœ«å°¾ã®ã‚«ãƒ³ãƒã‚’å‰Šé™¤
                            .replace(/\n\s*"/g, '\n"') // æ”¹è¡Œå¾Œã®ä½™åˆ†ãªã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤
                            .replace(/" "([a-zA-Z]+)":/g, '"$1":'); // ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åå‰ã®ä½™åˆ†ãªå¼•ç”¨ç¬¦ã‚’ä¿®æ­£
                        
                        // ä¸å®Œå…¨ãªJSONã‚’ä¿®å¾©ã™ã‚‹è©¦ã¿
                        // æ–‡å­—åŒ–ã‘ã‚„åˆ‡æ–­ã•ã‚ŒãŸJSONã‚’æ¤œå‡ºã—ã¦ä¿®å¾©
                        if (jsonStr.includes('insã€€') || jsonStr.includes('ã¨ãªã‚Šã¾ã™') || 
                            jsonStr.includes('æœ¬å½“ã«') || /[^\x00-\x7F]{3,}$/.test(jsonStr)) {
                            console.warn('Detected corrupted JSON, attempting repair');
                            
                            // æœ€å¾Œã®æœ‰åŠ¹ãªJSONè¦ç´ ã‚’æ¢ã™
                            const lastValidPositions = [
                                jsonStr.lastIndexOf('"}'),
                                jsonStr.lastIndexOf('",'),
                                jsonStr.lastIndexOf(': "'),
                                jsonStr.lastIndexOf('],'),
                                jsonStr.lastIndexOf('},')
                            ].filter(pos => pos > 0);
                            
                            if (lastValidPositions.length > 0) {
                                const cutoffPoint = Math.max(...lastValidPositions);
                                jsonStr = jsonStr.substring(0, cutoffPoint + 2);
                            }
                        }
                        
                        // æ–‡å­—åˆ—ã®é€”ä¸­ã§åˆ‡ã‚Œã¦ã„ã‚‹å ´åˆã®ä¿®å¾©
                        const lastQuoteIndex = jsonStr.lastIndexOf('"');
                        const secondLastQuoteIndex = jsonStr.lastIndexOf('"', lastQuoteIndex - 1);
                        if (lastQuoteIndex > secondLastQuoteIndex && 
                            !jsonStr.substring(lastQuoteIndex).includes('}')) {
                            // æœªå®Œäº†ã®æ–‡å­—åˆ—ã‚’é–‰ã˜ã‚‹
                            jsonStr = jsonStr.substring(0, lastQuoteIndex + 1);
                        }
                        
                        // JSONãŒä¸å®Œå…¨ã«è¦‹ãˆã‚‹å ´åˆã®ä¿®å¾©
                        const openBraces = (jsonStr.match(/\{/g) || []).length;
                        const closeBraces = (jsonStr.match(/\}/g) || []).length;
                        const openBrackets = (jsonStr.match(/\[/g) || []).length;
                        const closeBrackets = (jsonStr.match(/\]/g) || []).length;
                        
                        // é…åˆ—ã‚’é–‰ã˜ã‚‹
                        if (openBrackets > closeBrackets) {
                            jsonStr += ']'.repeat(openBrackets - closeBrackets);
                        }
                        
                        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‰ã˜ã‚‹
                        if (openBraces > closeBraces) {
                            jsonStr += '}'.repeat(openBraces - closeBraces);
                        }
                        
                        // ç©ºã®JSONãƒã‚§ãƒƒã‚¯
                        if (!jsonStr || jsonStr.trim() === '') {
                            throw new Error('Empty JSON string');
                        }
                        
                        parsedResponse = JSON.parse(jsonStr);
                        
                        // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ¤œè¨¼ã¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®š
                        if (!parsedResponse.response) {
                            throw new Error('No response text found');
                        }
                        
                        // ã‚¹ã‚³ã‚¢ãŒå­˜åœ¨ã—ãªã„ã€ã¾ãŸã¯ä¸æ­£ãªå€¤ã®å ´åˆã¯è¨ˆç®—ã™ã‚‹
                        if (typeof parsedResponse.score !== 'number' || parsedResponse.score < 0 || parsedResponse.score > 100) {
                            const { score, breakdown } = calculateScore(question, messages.length > 0 ? messages[messages.length - 1].content : '');
                            parsedResponse.score = score;
                            parsedResponse.breakdown = breakdown;
                        }
                        
                        // breakdownãŒä¸å®Œå…¨ãªå ´åˆã¯å†è¨ˆç®—
                        if (!parsedResponse.breakdown || typeof parsedResponse.breakdown !== 'object') {
                            const { score, breakdown } = calculateScore(question, messages.length > 0 ? messages[messages.length - 1].content : '');
                            parsedResponse.breakdown = breakdown;
                        }
                        
                        // newMoodã®æ¤œè¨¼ã¨ä¿®æ­£
                        if (!parsedResponse.newMood || !['open', 'normal', 'guard', 'close'].includes(parsedResponse.newMood)) {
                            // ã‚¹ã‚³ã‚¢ã«åŸºã¥ã„ã¦æ°—åˆ†ã‚’æ›´æ–°
                            let newMood = mood;
                            const score = parsedResponse.score || 50;
                            
                            // ã‚ˆã‚Šç©æ¥µçš„ãªæ°—åˆ†å¤‰åŒ–
                            if (score >= 80) {
                                // ç´ æ™´ã‚‰ã—ã„è³ªå• - å¤§å¹…ã«é–‹æ”¾çš„ã«
                                if (mood === 'close') newMood = 'normal';
                                else if (mood === 'guard') newMood = 'open';
                                else newMood = 'open';
                            } else if (score >= 60) {
                                // è‰¯ã„è³ªå• - å°‘ã—é–‹æ”¾çš„ã«
                                if (mood === 'close') newMood = 'guard';
                                else if (mood === 'guard') newMood = 'normal';
                                else if (mood === 'normal') newMood = 'open';
                            } else if (score <= 30) {
                                // æ‚ªã„è³ªå• - é–‰ã˜ã¦ã„ã
                                if (mood === 'open') newMood = 'normal';
                                else if (mood === 'normal') newMood = 'guard';
                                else newMood = 'close';
                            } else if (score <= 40) {
                                // ã‚„ã‚„æ‚ªã„è³ªå•
                                if (mood === 'open') newMood = 'normal';
                                else if (mood === 'normal') newMood = 'guard';
                            }
                            parsedResponse.newMood = newMood;
                        }
                        
                        // æ°—åˆ†å¤‰åŒ–ã®ç†ç”±ã‚’è¿½åŠ 
                        if (parsedResponse.newMood !== mood && !parsedResponse.moodReason) {
                            const reasons = {
                                'open': ['è³ªå•ãŒçš„ç¢ºã§è©±ã—ã‚„ã™ããªã‚Šã¾ã—ãŸ', 'ç†è§£ã—ã¦ã‚‚ã‚‰ãˆã¦ã„ã‚‹ã¨æ„Ÿã˜ã¾ã™'],
                                'normal': ['æ™®é€šã«è©±ã›ãã†ã§ã™', 'å°‘ã—æ§˜å­ã‚’è¦‹ã¦ã„ã¾ã™'],
                                'guard': ['ã¡ã‚‡ã£ã¨ç­”ãˆã«ãã„è³ªå•ã§ã—ãŸ', 'å°‘ã—è­¦æˆ’ã—ã¦ã„ã¾ã™'],
                                'close': ['ã“ã®è©±é¡Œã¯é¿ã‘ãŸã„ã§ã™', 'è³ªå•ã®æ„å›³ãŒåˆ†ã‹ã‚Šã¾ã›ã‚“']
                            };
                            parsedResponse.moodReason = reasons[parsedResponse.newMood]?.[Math.floor(Math.random() * 2)] || '';
                        }
                        
                        // insightã®ãƒã‚§ãƒƒã‚¯
                        if (parsedResponse.score > 80 && !parsedResponse.insight) {
                            const insights = [
                                'æœ¬è³ªçš„ãªèª²é¡Œã‚’ç™ºè¦‹',
                                'éš ã‚ŒãŸãƒ‹ãƒ¼ã‚ºã‚’ç‰¹å®š',
                                'æ„Ÿæƒ…ã®æ ¹æºã‚’ç™ºè¦‹',
                                'ç†æƒ³ã¨ç¾å®Ÿã®ã‚®ãƒ£ãƒƒãƒ—ã‚’ç™ºè¦‹'
                            ];
                            parsedResponse.insight = insights[Math.floor(Math.random() * insights.length)];
                        }
                        
                    } catch (e) {
                        console.error('JSON Parse Error:', e, 'Content:', content);
                        
                        // JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ãŸå ´åˆã€å†…å®¹ã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’æŠ½å‡ºã™ã‚‹è©¦ã¿
                        let extractedResponse = null;
                        
                        // responseãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¢ã™
                        const responseMatch = content.match(/"response"\s*:\s*"([^"]+)"/);
                        if (responseMatch) {
                            extractedResponse = responseMatch[1];
                        }
                        
                        // ãã‚Œã§ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æœ€åˆã®æ—¥æœ¬èªæ–‡ã‚’ä½¿ç”¨
                        if (!extractedResponse) {
                            const japaneseMatch = content.match(/[ã-ã‚“ã‚¡-ãƒ¶ãƒ¼ä¸€-é¾ ].+[ã€‚ï¼ï¼Ÿ]/);
                            if (japaneseMatch) {
                                extractedResponse = japaneseMatch[0];
                            }
                        }
                        
                        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”ã®ç”Ÿæˆ
                        const { score, breakdown } = calculateScore(question, messages.length > 0 ? messages[messages.length - 1].content : '');
                        parsedResponse = {
                            response: extractedResponse || 'ãã†ã§ã™ã­ã€ãã‚Œã¯èˆˆå‘³æ·±ã„è³ªå•ã§ã™ã­ã€‚ã‚‚ã†å°‘ã—è©³ã—ããŠèã‹ã›ãã ã•ã„ã€‚',
                            score: score,
                            breakdown: breakdown,
                            newMood: mood,
                            insight: null,
                            moodReason: 'APIå¿œç­”ã®è§£æã«å•é¡ŒãŒã‚ã‚Šã¾ã—ãŸ'
                        };
                        
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è»½ã„ã‚¨ãƒ©ãƒ¼é€šçŸ¥
                        console.warn('JSON parsing failed, using extracted response:', extractedResponse);
                    }
                    
                    console.log('Final parsed response:', parsedResponse);
                        setIsTyping(false);
                        return parsedResponse;
                        
                    } catch (error) {
                        lastError = error;
                        retryCount++;
                        console.error(`API Error (attempt ${retryCount}):`, error);
                        
                        if (retryCount >= maxRetries) {
                            console.error('Max retries reached, using fallback');
                            break;
                        }
                    }
                }
                
                // ã™ã¹ã¦ã®ãƒªãƒˆãƒ©ã‚¤ãŒå¤±æ•—ã—ãŸå ´åˆ
                console.error('All retries failed, using fallback response');
                showToast('APIå¿œç­”ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”ã‚’ä½¿ç”¨ã—ã¾ã™', 'warning');
                
                const fallbackResponses = [
                    'ãã†ã§ã™ã­ã€ãã‚Œã«ã¤ã„ã¦ã‚‚ã†å°‘ã—è©³ã—ãæ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ',
                    'ãªã‚‹ã»ã©ã€èˆˆå‘³æ·±ã„ãŠè©±ã§ã™ã­ã€‚å…·ä½“çš„ã«ã¯ã©ã®ã‚ˆã†ãªæ„Ÿã˜ã§ã—ã‚‡ã†ã‹ï¼Ÿ',
                    'ãã®ç‚¹ã¯ç¢ºã‹ã«é‡è¦ã§ã™ã­ã€‚æ™®æ®µã¯ã©ã®ã‚ˆã†ã«å¯¾å‡¦ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ'
                ];
                
                const { score, breakdown } = calculateScore(question, messages.length > 0 ? messages[messages.length - 1].content : '');
                
                setIsTyping(false);
                return {
                    response: fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)],
                    score: Math.max(20, score),
                    breakdown,
                    newMood: mood,
                    insight: null
                };
            }, [apiKey, apiModel, mood, persona, calculateScore, messages, gameLogic]);
            
            // è³ªå•é€ä¿¡å‡¦ç†
            const handleSubmitQuestion = useCallback(async () => {
                if (!currentQuestion.trim() || questionCount >= maxQuestions) return;
                
                // è³ªå•å†…å®¹ã‚’ä¿å­˜ã—ã¦ã‹ã‚‰ã€ã™ãã«å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
                const questionText = currentQuestion;
                setCurrentQuestion('');
                
                // Clear input immediately and manage focus
                if (inputRef.current) {
                    inputRef.current.value = '';
                    // Only blur on mobile to hide keyboard after sending
                    if (isMobile) {
                        inputRef.current.blur();
                    }
                }
                
                // Scroll to bottom after sending message
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ãŸå¾Œã¯å¿…ãšã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                scrollToLatest();
                
                const userMessage = {
                    type: 'user',
                    content: questionText,
                    timestamp: new Date()
                };
                
                setMessages(prev => [...prev, userMessage]);
                const newQuestionCount = questionCount + 1;
                setQuestionCount(newQuestionCount);
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ãŸæ™‚ã¯å¿…ãšæœ€æ–°ã‚’è¡¨ç¤º
                scrollToLatest();
                
                const aiResponse = await generateAIResponse(questionText);
                
                // ã‚¹ã‚³ã‚¢æ›´æ–°
                const newScore = currentScore + aiResponse.score;
                setCurrentScore(newScore);
                setScoreHistory(prev => [...prev, aiResponse.score]);
                setTalkMeter(prev => Math.min(100, prev + (aiResponse.score / 10)));
                setMood(aiResponse.newMood);
                
                // é«˜å¾—ç‚¹æ™‚ã®æ¼”å‡ºï¼ˆã‚ˆã‚Šé »ç¹ã«ç™ºç”Ÿï¼‰
                if (aiResponse.score >= 60) { // é–¾å€¤ã‚’ä¸‹ã’ã‚‹
                    const newComboCount = comboCount + 1;
                    setComboCount(newComboCount);
                    if (newComboCount >= 2) { // 2å›ç›®ã‹ã‚‰è¡¨ç¤º
                        showToast(`ğŸ”¥ ${newComboCount}é€£ç¶šã‚³ãƒ³ãƒœï¼ +${newComboCount * 20}ãƒœãƒ¼ãƒŠã‚¹`, 'success');
                        setCurrentScore(prev => prev + newComboCount * 20);
                    }
                    triggerParticles();
                } else {
                    if (comboCount > 2) {
                        showToast('ğŸ’” ã‚³ãƒ³ãƒœãŒé€”åˆ‡ã‚Œã¾ã—ãŸ', 'warning');
                    }
                    setComboCount(0);
                }
                
                // ã‚¹ãƒšã‚·ãƒ£ãƒ«ãƒœãƒ¼ãƒŠã‚¹
                if (aiResponse.score >= 90) {
                    showToast('â­ ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆè³ªå•ï¼ +50ãƒœãƒ¼ãƒŠã‚¹', 'success');
                    setCurrentScore(prev => prev + 50);
                    // ç‰¹åˆ¥ãªã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                    document.body.style.animation = 'pulse 0.5s';
                    setTimeout(() => document.body.style.animation = '', 500);
                }
                
                // ãƒ™ã‚¹ãƒˆè³ªå•ã®è¨˜éŒ²
                if (aiResponse.score >= 80) {
                    setBestQuestions(prev => [...prev, { question: currentQuestion, score: aiResponse.score }]
                        .sort((a, b) => b.score - a.score)
                        .slice(0, 3));
                }
                
                // ã‚¤ãƒ³ã‚µã‚¤ãƒˆç™ºè¦‹
                if (aiResponse.insight) {
                    setInsights(prev => [...prev, aiResponse.insight]);
                    showToast('ğŸ’¡ ã‚¤ãƒ³ã‚µã‚¤ãƒˆç™ºè¦‹ï¼', 'success');
                    checkAchievements('insight');
                }
                
                // ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
                checkAchievements('score', aiResponse.score);
                if (questionCount === 0) {
                    checkAchievements('firstQuestion');
                }
                if (comboCount >= 3) {
                    checkAchievements('combo3');
                }
                if (comboCount >= 5) {
                    checkAchievements('combo5');
                }
                
                const aiMessage = {
                    type: 'ai',
                    content: aiResponse.response,
                    score: aiResponse.score,
                    breakdown: aiResponse.breakdown,
                    timestamp: new Date()
                };
                
                setMessages(prev => [...prev, aiMessage]);
                
                // AIãŒå¿œç­”ã—ãŸæ™‚ã‚‚æœ€æ–°ã‚’è¡¨ç¤º
                scrollToLatest();
                
                // ã‚¹ã‚³ã‚¢è©³ç´°ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                console.log('Question Score Details:', {
                    question: questionText,
                    score: aiResponse.score,
                    breakdown: aiResponse.breakdown,
                    mood: mood,
                    newMood: aiResponse.newMood
                });
                
                // ã‚²ãƒ¼ãƒ çµ‚äº†ãƒã‚§ãƒƒã‚¯ï¼ˆè³ªå•æ•°ã®ã¿ã§åˆ¤å®šï¼‰
                console.log(`Question ${newQuestionCount} of ${maxQuestions} completed`);
                if (newQuestionCount >= maxQuestions) {
                    console.log('Game ending - starting analysis...');
                    // ã‚³ãƒ³ãƒœã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
                    setComboCount(0);
                    // ã‚²ãƒ¼ãƒ å®Œäº†æ™‚ã®ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆ
                    checkAchievements('gameComplete');
                    const newTotal = totalGamesPlayed + 1;
                    setTotalGamesPlayed(newTotal);
                    localStorage.setItem('totalGamesPlayed', newTotal.toString());
                    
                    // éš ã—ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
                    if (insights.length >= 5) {
                        checkAchievements('hiddenGenius');
                    }
                    
                    // ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ©ãƒ³ãƒã‚§ãƒƒã‚¯ï¼ˆã‚²ãƒ¼ãƒ é–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ²ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ï¼‰
                    const gameTime = Date.now() - (window.gameStartTime || Date.now());
                    if (gameTime < 180000) { // 3åˆ†ä»¥å†…
                        checkAchievements('speedDemon');
                    }
                    
                    // ãƒã‚¤ã‚¹ã‚³ã‚¢æ›´æ–°
                    const finalScore = currentScore + aiResponse.score;
                    const newHighScores = { ...highScores };
                    if (!newHighScores[difficulty] || finalScore > newHighScores[difficulty]) {
                        newHighScores[difficulty] = finalScore;
                        setHighScores(newHighScores);
                        localStorage.setItem('highScores', JSON.stringify(newHighScores));
                        showToast('ğŸ† æ–°è¨˜éŒ²é”æˆï¼', 'success');
                    }
                    
                    // ç·ã‚¹ã‚³ã‚¢æ›´æ–°
                    const newTotalScore = totalScore + finalScore;
                    setTotalScore(newTotalScore);
                    localStorage.setItem('totalScore', newTotalScore.toString());
                    
                    // ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ç‰¹åˆ¥ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆ
                    if (difficulty === 'expert' && finalScore >= 800) {
                        checkAchievements('expertMaster');
                    }
                    
                    // ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆã‚²ãƒ¼ãƒ ãƒã‚§ãƒƒã‚¯
                    const allHighScores = scoreHistory.every(s => s >= 70);
                    if (allHighScores && currentMission === 'perfect') {
                        checkAchievements('perfectGame');
                    }
                    
                    setTimeout(async () => {
                        console.log('Starting AI analysis...');
                        // AIã§ä¼šè©±ã‚’åˆ†æ
                        try {
                            await generateAIAnalysis();
                            console.log('AI analysis completed, switching to result screen');
                        } catch (error) {
                            console.error('AI analysis failed:', error);
                        }
                        setGameState('result');
                    }, 2000);
                }
            }, [currentQuestion, questionCount, maxQuestions, generateAIResponse, comboCount, currentScore, generateAIAnalysis, checkAchievements, totalGamesPlayed, highScores, difficulty, totalScore, currentMission, scoreHistory, showToast, insights]);
            
            // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            const triggerParticles = useCallback(() => {
                setShowParticles(true);
                setTimeout(() => setShowParticles(false), 3000);
            }, []);
            
            // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
            const showToast = useCallback((message, type = 'info') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => {
                    setToasts(prev => prev.filter(t => t.id !== id));
                }, 3000);
            }, []);
            
            // ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ 
            const checkAchievements = useCallback((type, value = null) => {
                const newAchievements = [];
                
                switch(type) {
                    case 'firstQuestion':
                        if (!localStorage.getItem('achievement_firstQuestion')) {
                            newAchievements.push({
                                id: 'firstQuestion',
                                name: 'ğŸ¯ åˆã‚ã¦ã®è³ªå•',
                                description: 'æœ€åˆã®è³ªå•ã‚’é€ä¿¡ã—ã¾ã—ãŸ'
                            });
                        }
                        break;
                    case 'score':
                        if (value >= 95 && !localStorage.getItem('achievement_perfect')) {
                            newAchievements.push({
                                id: 'perfect',
                                name: 'â­ ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆè³ªå•',
                                description: '95ç‚¹ä»¥ä¸Šã®è³ªå•ã‚’é”æˆï¼ˆé«˜é›£æ˜“åº¦ï¼‰'
                            });
                        }
                        break;
                    case 'combo3':
                        if (!localStorage.getItem('achievement_combo3')) {
                            newAchievements.push({
                                id: 'combo3',
                                name: 'ğŸ”¥ 3é€£ç¶šã‚³ãƒ³ãƒœ',
                                description: '3å›é€£ç¶šã§è‰¯ã„è³ªå•ã‚’é”æˆ'
                            });
                        }
                        break;
                    case 'combo5':
                        if (!localStorage.getItem('achievement_combo5')) {
                            newAchievements.push({
                                id: 'combo5',
                                name: 'ğŸ’¥ 5é€£ç¶šã‚³ãƒ³ãƒœãƒã‚¹ã‚¿ãƒ¼',
                                description: '5å›é€£ç¶šã§è‰¯ã„è³ªå•ã‚’é”æˆ'
                            });
                        }
                        break;
                    case 'insight':
                        if (!localStorage.getItem('achievement_insight')) {
                            newAchievements.push({
                                id: 'insight',
                                name: 'ğŸ’¡ ã‚¤ãƒ³ã‚µã‚¤ãƒˆç™ºè¦‹è€…',
                                description: 'é‡è¦ãªã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’ç™ºè¦‹'
                            });
                        }
                        break;
                    case 'expertMaster':
                        if (!localStorage.getItem('achievement_expertMaster')) {
                            newAchievements.push({
                                id: 'expertMaster',
                                name: 'ğŸ‘‘ ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆãƒã‚¹ã‚¿ãƒ¼',
                                description: 'ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ã§900ç‚¹ä»¥ä¸Šé”æˆ'
                            });
                        }
                        break;
                    case 'perfectGame':
                        if (!localStorage.getItem('achievement_perfectGame')) {
                            newAchievements.push({
                                id: 'perfectGame',
                                name: 'ğŸ’ ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆã‚²ãƒ¼ãƒ ',
                                description: 'å…¨è³ªå•80ç‚¹ä»¥ä¸Šã§ã‚¯ãƒªã‚¢'
                            });
                        }
                        break;
                    case 'hiddenGenius':
                        if (!localStorage.getItem('achievement_hiddenGenius')) {
                            newAchievements.push({
                                id: 'hiddenGenius',
                                name: 'ğŸ§  éš ã‚ŒãŸå¤©æ‰',
                                description: '1å›ã®ã‚²ãƒ¼ãƒ ã§5ã¤ä»¥ä¸Šã®ã‚¤ãƒ³ã‚µã‚¤ãƒˆç™ºè¦‹'
                            });
                        }
                        break;
                    case 'speedDemon':
                        if (!localStorage.getItem('achievement_speedDemon')) {
                            newAchievements.push({
                                id: 'speedDemon',
                                name: 'âš¡ ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ‡ãƒ¼ãƒ¢ãƒ³',
                                description: '3åˆ†ä»¥å†…ã«ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢'
                            });
                        }
                        break;
                    case 'legendaryInterviewer':
                        if (!localStorage.getItem('achievement_legendaryInterviewer') && totalGamesPlayed >= 50) {
                            newAchievements.push({
                                id: 'legendaryInterviewer',
                                name: 'ğŸŒŸ ä¼èª¬ã®ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼',
                                description: '50å›ãƒ—ãƒ¬ã‚¤ï¼†å¹³å‡ã‚¹ã‚³ã‚¢80ç‚¹ä»¥ä¸Š'
                            });
                        }
                        break;
                    case 'secretEnding':
                        // ã‚¤ãƒ¼ã‚¹ã‚¿ãƒ¼ã‚¨ãƒƒã‚°: ç‰¹å®šã®è³ªå•ãƒ‘ã‚¿ãƒ¼ãƒ³ã§è§£é™¤
                        if (!localStorage.getItem('achievement_secretEnding')) {
                            newAchievements.push({
                                id: 'secretEnding',
                                name: 'ğŸ”® ç§˜å¯†ã®çµ‚ã‚ã‚Š',
                                description: '??? ã‚’ç™ºè¦‹ã—ãŸ'
                            });
                        }
                        break;
                    case 'gameComplete':
                        const gamesPlayed = totalGamesPlayed + 1;
                        if (gamesPlayed === 1) {
                            newAchievements.push({
                                id: 'firstGame',
                                name: 'ğŸ® ã‚²ãƒ¼ãƒ ãƒ‡ãƒ“ãƒ¥ãƒ¼',
                                description: 'åˆã‚ã¦ã‚²ãƒ¼ãƒ ã‚’å®Œäº†'
                            });
                        }
                        if (gamesPlayed === 10) {
                            newAchievements.push({
                                id: 'veteran',
                                name: 'ğŸ… ãƒ™ãƒ†ãƒ©ãƒ³ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼',
                                description: '10å›ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤'
                            });
                        }
                        break;
                }
                
                // æ–°ã—ã„ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆã‚’è¨˜éŒ²
                newAchievements.forEach(achievement => {
                    localStorage.setItem(`achievement_${achievement.id}`, 'true');
                    setAchievements(prev => [...prev, achievement]);
                    showToast(`ğŸ† ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆè§£é™¤: ${achievement.name}`, 'success');
                });
            }, [showToast, totalGamesPlayed]);
            
            // ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ˆãƒšãƒ«ã‚½ãƒŠç¢ºèªç”»é¢ã¸ï¼‰
            const startGame = useCallback(async () => {
                const finalPainPoint = customPainPoint || selectedPainPoint;
                if (!finalPainPoint) {
                    showToast('å›°ã‚Šã”ã¨ã‚’é¸æŠã™ã‚‹ã‹ã€ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
                    return;
                }
                
                if (!apiTested) {
                    showToast('å…ˆã«APIã‚’ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„', 'warning');
                    return;
                }
                
                const aiPersona = await generatePersonaWithAI(finalPainPoint);
                const personaCandidate = aiPersona || generatePersona(finalPainPoint);
                setPersona(personaCandidate);
                if (typeof window !== 'undefined') {
                    window.__PLAYWRIGHT_PERSONA = personaCandidate;
                }
                setShowPersonaInfo(false);
                setGameState('persona');
            }, [selectedPainPoint, customPainPoint, generatePersona, generatePersonaWithAI, showToast, apiTested]);
            
            // ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼é–‹å§‹ï¼ˆãƒšãƒ«ã‚½ãƒŠç¢ºèªå¾Œï¼‰
            const startInterview = useCallback(() => {
                if (!persona) return;
                
                const mainPainPoint = persona.painPoints && persona.painPoints[0] ? persona.painPoints[0] : 'å›°ã‚Šã”ã¨';

                setGameState('playing');
                setCurrentScore(0);
                setQuestionCount(0);
                setTalkMeter(0);
                setMood('normal');
                
                window.gameStartTime = Date.now();
                
                // ãƒšã‚¤ãƒ³ãƒã‚¤ãƒ³ãƒˆã‚’è‡ªç„¶ãªè¡¨ç¾ã«å¤‰æ›
                const naturalPainPoint = (() => {
                    // ä¸è¦ãªèªå°¾ã‚’é™¤å»
                    let cleaned = mainPainPoint
                        .replace(/ã§å›°ã£ã¦ã„ã‚‹|ã«å›°ã£ã¦ã„ã‚‹|ã¦ã—ã¾ã†|ã—ã¦ã—ã¾ã†|å›°ã£ã¦ã„ã‚‹/g, '')
                        .replace(/ã€/g, '')
                        .trim();
                    
                    // é•·ã™ãã‚‹å ´åˆã¯è¦ç´„çš„ã«
                    if (cleaned.length > 40) {
                        // æœ€åˆã®ä¸»è¦ãªå•é¡Œéƒ¨åˆ†ã‚’æŠ½å‡º
                        const mainIssue = cleaned.match(/^([^ã€ã€‚]+)/);
                        if (mainIssue) {
                            return mainIssue[1] + 'ã“ã¨';
                        }
                        // ãã‚Œã§ã‚‚é•·ã„å ´åˆã¯30æ–‡å­—ã§ã‚«ãƒƒãƒˆ
                        return cleaned.substring(0, 30) + '...ã“ã¨';
                    }
                    
                    // ã€Œã“ã¨ã€ã§çµ‚ã‚ã£ã¦ã„ãªã„å ´åˆã¯è¿½åŠ 
                    if (!cleaned.endsWith('ã“ã¨')) {
                        return cleaned + 'ã“ã¨';
                    }
                    
                    return cleaned;
                })();
                
                setMessages([{
                    type: 'ai',
                    content: `ã“ã‚“ã«ã¡ã¯ï¼${persona.name}ã§ã™ã€‚ä»Šæ—¥ã¯ãŠæ™‚é–“ã‚’ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚å®Ÿã¯æœ€è¿‘ã€${naturalPainPoint}ã§å°‘ã—æ‚©ã‚“ã§ã„ã¦...ã€‚ä½•ã‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã„ãŸã ã‘ãŸã‚‰å¬‰ã—ã„ã§ã™ã€‚ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼`,
                    timestamp: new Date()
                }]);
                setScoreHistory([]);
                setInsights([]);
                setBestQuestions([]);
                setComboCount(0);
                setShowPersonaInfo(false);
                if (typeof window !== 'undefined') {
                    window.__PLAYWRIGHT_STATE = 'playing';
                }
            }, [persona]);

            useEffect(() => {
                if (typeof window !== 'undefined') {
                    window.__PLAYWRIGHT_FORCE_RESULT = async () => {
                        await generateAIAnalysis();
                        setGameState('result');
                    };
                    window.__PLAYWRIGHT_STATE = gameState;
                }
            }, [generateAIAnalysis, gameState]);

            // ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            const resetGame = useCallback(() => {
                setGameState('menu');
                setCurrentScore(0);
                setQuestionCount(0);
                setTalkMeter(0);
                setMood('normal');
                setMessages([]);
                setCurrentQuestion('');
                setScoreHistory([]);
                setInsights([]);
                setBestQuestions([]);
                setComboCount(0);
                setPersona(null);
                setSelectedPainPoint('');
                setCustomPainPoint('');
                setShowPersonaInfo(false);
                if (typeof window !== 'undefined') {
                    window.__PLAYWRIGHT_STATE = 'menu';
                }
            }, []);
            
            // ã‚¹ãƒãƒ¼ãƒˆãªè‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœ€ä¸‹éƒ¨ã«ã„ã‚‹æ™‚ã®ã¿ï¼‰
            const [isUserScrolling, setIsUserScrolling] = React.useState(false);
            const [shouldAutoScroll, setShouldAutoScroll] = React.useState(true);
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ç›£è¦–
            const checkIfAtBottom = useCallback(() => {
                if (!chatAreaRef.current) return true;
                const { scrollTop, scrollHeight, clientHeight } = chatAreaRef.current;
                // æœ€ä¸‹éƒ¨ã‹ã‚‰100pxä»¥å†…ãªã‚‰ã€Œæœ€ä¸‹éƒ¨ã«ã„ã‚‹ã€ã¨åˆ¤å®š
                return scrollHeight - scrollTop - clientHeight < 100;
            }, []);
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãŸæ™‚
            const handleScroll = useCallback(() => {
                if (chatAreaRef.current) {
                    const isAtBottom = checkIfAtBottom();
                    setShouldAutoScroll(isAtBottom);
                }
            }, [checkIfAtBottom]);
            
            // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿½åŠ ã•ã‚ŒãŸæ™‚ã®è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            useEffect(() => {
                // æœ€ä¸‹éƒ¨ã«ã„ã‚‹å ´åˆã€ã¾ãŸã¯åˆå›è¡¨ç¤ºæ™‚ã®ã¿è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                if (shouldAutoScroll && messagesEndRef.current) {
                    setTimeout(() => {
                        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth', block: 'end' });
                    }, 100);
                }
            }, [messages, shouldAutoScroll]);
            
            // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ™‚ã¯å¿…ãšã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            const scrollToLatest = useCallback(() => {
                setShouldAutoScroll(true);
                setTimeout(() => {
                    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }, 100);
            }, []);
            
            // æ°—åˆ†ã«å¿œã˜ãŸèƒŒæ™¯è‰²å¤‰æ›´
            const getMoodColor = useCallback(() => {
                switch(mood) {
                    case 'open': return 'from-green-400 to-blue-500';
                    case 'normal': return 'from-blue-400 to-purple-500';
                    case 'guard': return 'from-yellow-400 to-orange-500';
                    case 'close': return 'from-red-400 to-pink-500';
                    default: return 'from-blue-400 to-purple-500';
                }
            }, [mood]);
            
            // çµæœç”»é¢ã®ãƒ©ãƒ³ã‚¯è¨ˆç®—ï¼ˆç·åˆã‚¹ã‚³ã‚¢ã¨å¹³å‡ã‚¹ã‚³ã‚¢ã§åˆ¤å®šï¼‰
            const calculateRank = useCallback(() => {
                const avgScore = scoreHistory.length > 0 ? 
                    scoreHistory.reduce((a, b) => a + b, 0) / scoreHistory.length : 0;
                
                // ç·åˆã‚¹ã‚³ã‚¢ã¨å¹³å‡ã‚¹ã‚³ã‚¢ã®ä¸¡æ–¹ã‚’è€ƒæ…®
                if (currentScore >= 1500 && avgScore >= 95) return 'SSS';
                if (currentScore >= 1200 && avgScore >= 90) return 'SS';
                if (currentScore >= 1000 && avgScore >= 85) return 'S';
                if (currentScore >= 800 && avgScore >= 80) return 'A';
                if (currentScore >= 600 && avgScore >= 70) return 'B';
                if (currentScore >= 400 && avgScore >= 60) return 'C';
                if (currentScore >= 200 && avgScore >= 50) return 'D';
                return 'E';
            }, [currentScore, scoreHistory]);
            
            // è©³ç´°ãªåˆ†æã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ
            const generateDetailedAnalysis = useCallback(() => {
                const avgScore = scoreHistory.length > 0 ? 
                    scoreHistory.reduce((a, b) => a + b, 0) / scoreHistory.length : 0;
                
                // è³ªå•ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ
                const questionPatterns = messages.filter(m => m.type === 'user').map(m => {
                    const q = m.content;
                    return {
                        hasWhy: q.includes('ãªãœ') || q.includes('ã©ã†ã—ã¦'),
                        hasHow: q.includes('ã©ã®ã‚ˆã†ã«') || q.includes('ã©ã†ã‚„ã£ã¦'),
                        hasFeel: q.includes('æ„Ÿã˜') || q.includes('æ€ã„'),
                        isOpen: !q.includes('ã§ã™ã‹ï¼Ÿ') && !q.includes('ã¾ã™ã‹ï¼Ÿ'),
                        length: q.length
                    };
                });
                
                const whyQuestions = questionPatterns.filter(p => p.hasWhy).length;
                const openQuestions = questionPatterns.filter(p => p.isOpen).length;
                const avgLength = questionPatterns.reduce((sum, p) => sum + p.length, 0) / questionPatterns.length;
                
                // å¼·ã¿ã®åˆ†æ
                const strengths = [];
                if (whyQuestions >= 5) {
                    strengths.push({
                        title: 'æ·±æ˜ã‚ŠåŠ›ãŒå„ªç§€',
                        detail: `${whyQuestions}å›ã®ã€Œãªãœã€è³ªå•ã§æœ¬è³ªã«è¿«ã‚‹å§¿å‹¢ãŒç´ æ™´ã‚‰ã—ã„ã§ã™ã€‚ç›¸æ‰‹ã®è¡¨é¢çš„ãªå›ç­”ã«æº€è¶³ã›ãšã€æ ¹æœ¬åŸå› ã‚’æ¢æ±‚ã™ã‚‹ç¿’æ…£ãŒèº«ã«ã¤ã„ã¦ã„ã¾ã™ã€‚`
                    });
                }
                if (openQuestions >= 7) {
                    strengths.push({
                        title: 'ã‚ªãƒ¼ãƒ—ãƒ³ã‚¯ã‚¨ã‚¹ãƒãƒ§ãƒ³ã®æ´»ç”¨',
                        detail: `${openQuestions}å›ã®ã‚ªãƒ¼ãƒ—ãƒ³è³ªå•ã‚’ä½¿ç”¨ã€‚ç›¸æ‰‹ã«è‡ªç”±ã«è©±ã—ã¦ã‚‚ã‚‰ã†ç’°å¢ƒã‚’ä½œã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šäºˆæƒ³å¤–ã®ç™ºè¦‹ãŒç”Ÿã¾ã‚Œã‚„ã™ããªã‚Šã¾ã™ã€‚`
                    });
                }
                if (avgScore >= 70) {
                    strengths.push({
                        title: 'è³ªå•ã®è³ªãŒé«˜ã„',
                        detail: `å¹³å‡${Math.round(avgScore)}ç‚¹ã¨ã„ã†é«˜å¾—ç‚¹ã€‚ç›¸æ‰‹ã®å¿ƒç†çŠ¶æ…‹ã‚’èª­ã¿å–ã‚Šã€é©åˆ‡ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§é©åˆ‡ãªè³ªå•ãŒã§ãã¦ã„ã¾ã™ã€‚`
                    });
                }
                if (comboCount >= 3) {
                    strengths.push({
                        title: 'æµã‚Œã‚’ä½œã‚‹åŠ›',
                        detail: 'é€£ç¶šã—ã¦è‰¯ã„è³ªå•ãŒã§ãã¦ãŠã‚Šã€ä¼šè©±ã®æµã‚Œã‚’ä¸Šæ‰‹ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã§ãã¦ã„ã¾ã™ã€‚ç›¸æ‰‹ãŒè©±ã—ã‚„ã™ã„é›°å›²æ°—ã‚’ç¶­æŒã§ãã¦ã„ã¾ã™ã€‚'
                    });
                }
                
                // æ”¹å–„ç‚¹ã®åˆ†æï¼ˆã‚ˆã‚Šå…·ä½“çš„ã«ï¼‰
                const improvements = [];
                if (whyQuestions < 3) {
                    improvements.push({
                        title: 'ã€Œãªãœã€ã‚’ã‚‚ã£ã¨æ´»ç”¨',
                        detail: 'è¡¨é¢çš„ãªäº‹å®Ÿã ã‘ã§ãªãã€ãã®èƒŒæ™¯ã«ã‚ã‚‹ç†ç”±ã‚„å‹•æ©Ÿã‚’æ¢ã‚Šã¾ã—ã‚‡ã†ã€‚',
                        practice: '5 Whysæ‰‹æ³•ï¼š1ã¤ã®å›ç­”ã«å¯¾ã—ã¦5å›ã€Œãªãœã€ã‚’ç¹°ã‚Šè¿”ã—ã€æœ¬è³ªçš„ãªåŸå› ã«åˆ°é”ã™ã‚‹ç·´ç¿’ã‚’ã—ã¾ã—ã‚‡ã†ã€‚',
                        examples: [
                            'ã€Œãªãœãã®æ–¹æ³•ã‚’é¸ã‚“ã ã®ã§ã™ã‹ï¼Ÿã€',
                            'ã€Œãã‚‚ãã‚‚ãªãœãã®å•é¡ŒãŒèµ·ããŸã¨æ€ã„ã¾ã™ã‹ï¼Ÿã€',
                            'ã€Œãã®æ™‚ãªãœãã†æ„Ÿã˜ãŸã®ã‹ã€ç†ç”±ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿã€'
                        ]
                    });
                }
                if (avgLength > 60) {
                    improvements.push({
                        title: 'è³ªå•ã‚’ç°¡æ½”ã«',
                        detail: `å¹³å‡${Math.round(avgLength)}æ–‡å­—ã¯é•·ã™ãã¾ã™ã€‚ç›¸æ‰‹ãŒç†è§£ã—ã‚„ã™ã„20-40æ–‡å­—ç¨‹åº¦ã®è³ªå•ã‚’å¿ƒãŒã‘ã¾ã—ã‚‡ã†ã€‚`,
                        practice: 'è³ªå•ã‚’ä½œã£ãŸå¾Œã€å‰Šã‚Œã‚‹è¨€è‘‰ãŒãªã„ã‹è¦‹ç›´ã™ç¿’æ…£ã‚’ã¤ã‘ã¾ã—ã‚‡ã†ã€‚',
                        examples: [
                            'âŒ æ‚ªã„ä¾‹ï¼šã€Œæ™®æ®µã®ä¼‘æ—¥ã¯ã©ã®ã‚ˆã†ãªæ„Ÿã˜ã§éã”ã•ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã‹ï¼Ÿã¾ãŸã€ç†æƒ³çš„ãªä¼‘æ—¥ã®éã”ã—æ–¹ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€',
                            'âœ… è‰¯ã„ä¾‹ï¼šã€Œä¼‘æ—¥ã¯ã©ã†éã”ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿã€â†’ã€Œç†æƒ³ã®ä¼‘æ—¥ã¯ï¼Ÿã€'
                        ]
                    });
                }
                if (openQuestions < 5) {
                    improvements.push({
                        title: 'ã‚ªãƒ¼ãƒ—ãƒ³ã‚¯ã‚¨ã‚¹ãƒãƒ§ãƒ³ã‚’å¢—ã‚„ã™',
                        detail: 'Yes/Noã§ç­”ãˆã‚‰ã‚Œã‚‹è³ªå•ãŒå¤šã„ã§ã™ã€‚ç›¸æ‰‹ãŒè‡ªç”±ã«è©±ã›ã‚‹è³ªå•ã‚’å¢—ã‚„ã—ã¾ã—ã‚‡ã†ã€‚',
                        practice: 'ã‚¯ãƒ­ãƒ¼ã‚ºãƒ‰è³ªå•ã‚’ã‚ªãƒ¼ãƒ—ãƒ³è³ªå•ã«å¤‰æ›ã™ã‚‹ç·´ç¿’ã‚’ã—ã¾ã—ã‚‡ã†ã€‚',
                        examples: [
                            'âŒã€Œæº€è¶³ã—ã¦ã„ã¾ã™ã‹ï¼Ÿã€',
                            'âœ…ã€Œã©ã‚“ãªç‚¹ã«æº€è¶³ã—ã¦ã„ã¾ã™ã‹ï¼Ÿã€',
                            'âœ…ã€Œä½•ãŒä¸€ç•ªã®èª²é¡Œã ã¨æ„Ÿã˜ã¦ã„ã¾ã™ã‹ï¼Ÿã€'
                        ]
                    });
                }
                if (avgScore < 50) {
                    improvements.push({
                        title: 'ç›¸æ‰‹ã®æ°—æŒã¡ã«å¯„ã‚Šæ·»ã†',
                        detail: 'ç›¸æ‰‹ã®æ„Ÿæƒ…ã‚„çŠ¶æ³ã¸ã®å…±æ„ŸãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚',
                        practice: 'å…±æ„Ÿã‚’ç¤ºã—ã¦ã‹ã‚‰è³ªå•ã™ã‚‹ç¿’æ…£ã‚’ã¤ã‘ã¾ã—ã‚‡ã†ã€‚',
                        examples: [
                            'ã€Œãã‚Œã¯å¤§å¤‰ã§ã—ãŸã­ã€‚ãã®æ™‚ã©ã†å¯¾å‡¦ã•ã‚ŒãŸã‚“ã§ã™ã‹ï¼Ÿã€',
                            'ã€Œãªã‚‹ã»ã©ã€ã€œã¨ã„ã†ã“ã¨ã§ã™ã­ã€‚ã‚‚ã†å°‘ã—è©³ã—ãæ•™ãˆã¦ãã ã•ã„ã€',
                            'ã€Œç¢ºã‹ã«ãã®æ°—æŒã¡ã‚ã‹ã‚Šã¾ã™ã€‚ä»–ã«ã‚‚ä¼¼ãŸçµŒé¨“ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿã€'
                        ]
                    });
                }
                
                // æ¬¡å›ã®èª²é¡Œï¼ˆå…·ä½“ä¾‹ä»˜ãï¼‰
                const challenges = [];
                if (insights.length < 2) {
                    challenges.push({
                        title: 'éš ã‚ŒãŸãƒ‹ãƒ¼ã‚ºã®ç™ºè¦‹',
                        approach: 'ç›¸æ‰‹ãŒæ˜è¨€ã—ã¦ã„ãªã„æ½œåœ¨çš„ãªãƒ‹ãƒ¼ã‚ºã‚’è¦‹ã¤ã‘ã¾ã—ã‚‡ã†ã€‚',
                        techniques: [
                            'ç†æƒ³ã¨ç¾å®Ÿã®ã‚®ãƒ£ãƒƒãƒ—ã‚’æ¢ã‚‹ï¼šã€Œç†æƒ³çš„ã«ã¯ã©ã†ã‚ã‚ŠãŸã„ã§ã™ã‹ï¼Ÿã€',
                            'æ„Ÿæƒ…ã®å¤‰åŒ–ã«æ³¨ç›®ï¼šã€Œãã®å‰å¾Œã§æ°—æŒã¡ã«å¤‰åŒ–ã¯ã‚ã‚Šã¾ã—ãŸã‹ï¼Ÿã€',
                            'çŸ›ç›¾ã‚’æ·±æ˜ã‚Šï¼šã€Œå…ˆã»ã©ã€œã¨ãŠã£ã—ã‚ƒã„ã¾ã—ãŸãŒã€ä»Šã®è©±ã¨é•ã„ãŒã‚ã‚‹ã‚ˆã†ã§ã™ãŒï¼Ÿã€'
                        ]
                    });
                }
                
                if (!bestQuestions.length || (bestQuestions[0] && bestQuestions[0].score < 85)) {
                    challenges.push({
                        title: '90ç‚¹è¶…ãˆã®è³ªå•ã«æŒ‘æˆ¦',
                        approach: 'æœ¬è³ªçš„ãªæ·±æ˜ã‚Šã¨å…·ä½“æ€§ã‚’çµ„ã¿åˆã‚ã›ãŸè³ªå•ã‚’ä½œã‚Šã¾ã—ã‚‡ã†ã€‚',
                        techniques: [
                            'ã€Œãã‚‚ãã‚‚ãªãœãã®çŠ¶æ³ã«ãªã£ãŸã¨æ€ã„ã¾ã™ã‹ï¼Ÿãã£ã‹ã‘ã‚’å…·ä½“çš„ã«æ•™ãˆã¦ãã ã•ã„ã€',
                            'ã€Œãªãœãã‚ŒãŒä¸€ç•ªé‡è¦ã ã¨æ„Ÿã˜ã‚‹ã®ã§ã™ã‹ï¼Ÿä»–ã®é¸æŠè‚¢ã¨æ¯”ã¹ã¦ä½•ãŒé•ã„ã¾ã—ãŸã‹ï¼Ÿã€',
                            'ã€Œãã®å•é¡Œã®æ ¹æœ¬åŸå› ã¯ä½•ã ã¨æ€ã„ã¾ã™ã‹ï¼Ÿãªãœãã†è€ƒãˆã‚‹ã®ã§ã™ã‹ï¼Ÿã€'
                        ]
                    });
                }
                
                challenges.push({
                    title: 'æ„Ÿæƒ…ã®æ·±å±¤ã‚’æ¢ã‚‹',
                    approach: 'äº‹å®Ÿã ã‘ã§ãªãã€æ„Ÿæƒ…ã¨ãã®ç†ç”±ã‚’æ·±ãæ˜ã‚Šä¸‹ã’ã¾ã—ã‚‡ã†ã€‚',
                    techniques: [
                        'ã€Œãã®æ™‚ã©ã‚“ãªæ°—æŒã¡ã§ã—ãŸã‹ï¼Ÿãªãœãã†æ„Ÿã˜ãŸã¨æ€ã„ã¾ã™ã‹ï¼Ÿã€',
                        'ã€Œä¸€ç•ªè¾›ã‹ã£ãŸ/å¬‰ã—ã‹ã£ãŸã®ã¯ã©ã‚“ãªç¬é–“ã§ã—ãŸã‹ï¼Ÿã€',
                        'ã€Œãã®çµŒé¨“ã‹ã‚‰ã€è‡ªåˆ†ã«ã¤ã„ã¦ä½•ã‹ç™ºè¦‹ã¯ã‚ã‚Šã¾ã—ãŸã‹ï¼Ÿã€'
                    ]
                });
                
                return {
                    strengths,
                    improvements,
                    challenges,
                    stats: {
                        avgScore: Math.round(avgScore),
                        whyQuestions,
                        openQuestions,
                        avgLength: Math.round(avgLength),
                        totalInsights: insights.length
                    }
                };
            }, [scoreHistory, messages, comboCount, insights, bestQuestions]);
            
            // AIåˆ†æç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const getAnalysisData = useCallback(() => {
                if (gameLogic?.getAnalysisData) {
                    return gameLogic.getAnalysisData(messages, scoreHistory, insights, questionCount);
                }
                return {
                    avgScore: 0,
                    whyQuestions: 0,
                    openQuestions: 0,
                    avgLength: 0,
                    totalInsights: insights.length
                };
            }, [gameLogic, messages, scoreHistory, insights, questionCount]);
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢
            const renderMenu = () => (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl w-full fade-in relative">
                        {/* è¨­å®šã‚¢ã‚¤ã‚³ãƒ³ */}
                        <button
                            onClick={() => setShowApiSettings(true)}
                            className="absolute top-6 right-6 p-2 rounded-lg hover:bg-gray-100 transition-colors group"
                            title="APIè¨­å®š"
                        >
                            <div className="relative">
                                <svg className="w-6 h-6 text-gray-600 group-hover:text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                {/* APIè¨­å®šçŠ¶æ…‹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */}
                                {apiTested ? (
                                    <div className="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                                ) : (
                                    <div className="absolute -bottom-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></div>
                                )}
                            </div>
                        </button>
                        
                        <h1 className="text-4xl font-bold text-center mb-2 gradient-text">
                            ãƒ‡ã‚¶ã‚¤ãƒ³æ€è€ƒã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ 
                        </h1>
                        <p className="text-gray-600 text-center mb-8">
                            AIãƒšãƒ«ã‚½ãƒŠã«ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã—ã¦ã€éš ã‚ŒãŸãƒ‹ãƒ¼ã‚ºã‚’ç™ºè¦‹ã—ã‚ˆã†ï¼
                        </p>
                        
                        <div className="space-y-6">
                            {/* é›£æ˜“åº¦ã¨ãƒãƒ£ãƒ¬ãƒ³ã‚¸è¨­å®š */}
                            <div>
                                <h3 className="text-lg font-semibold mb-3">ğŸ® é›£æ˜“åº¦è¨­å®š</h3>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3">
                                    <button
                                        onClick={() => {
                                            setDifficulty('easy');
                                            setMaxQuestions(15);
                                            showToast('ã‚¤ãƒ¼ã‚¸ãƒ¼ãƒ¢ãƒ¼ãƒ‰è¨­å®š', 'info');
                                            console.log('Set Easy Mode: maxQuestions=15');
                                            if (typeof window !== 'undefined') {
                                                window.__DEBUG_MAX_QUESTIONS = 15;
                                            }
                                        }}
                                        className={`p-2 rounded-lg border-2 transition-all ${
                                            difficulty === 'easy' 
                                                ? 'border-green-500 bg-green-50' 
                                                : 'border-gray-200 hover:border-green-300'
                                        }`}
                                    >
                                        <div className="text-green-600 font-bold text-sm">ã‚¤ãƒ¼ã‚¸ãƒ¼</div>
                                        <div className="text-xs text-gray-600">15å•ã¾ã§</div>
                                    </button>
                                    <button
                                        onClick={() => {
                                            setDifficulty('normal');
                                            setMaxQuestions(10);
                                            showToast('ãƒãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰è¨­å®š', 'info');
                                            console.log('Set Normal Mode: maxQuestions=10');
                                            if (typeof window !== 'undefined') {
                                                window.__DEBUG_MAX_QUESTIONS = 10;
                                            }
                                        }}
                                        className={`p-2 rounded-lg border-2 transition-all ${
                                            difficulty === 'normal' 
                                                ? 'border-blue-500 bg-blue-50' 
                                                : 'border-gray-200 hover:border-blue-300'
                                        }`}
                                    >
                                        <div className="text-blue-600 font-bold text-sm">ãƒãƒ¼ãƒãƒ«</div>
                                        <div className="text-xs text-gray-600">10å•ã¾ã§</div>
                                    </button>
                                    <button
                                        onClick={() => {
                                            setDifficulty('hard');
                                            setMaxQuestions(8);
                                            showToast('ãƒãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰è¨­å®š', 'warning');
                                            console.log('Set Hard Mode: maxQuestions=8');
                                            if (typeof window !== 'undefined') {
                                                window.__DEBUG_MAX_QUESTIONS = 8;
                                            }
                                        }}
                                        className={`p-2 rounded-lg border-2 transition-all ${
                                            difficulty === 'hard' 
                                                ? 'border-orange-500 bg-orange-50' 
                                                : 'border-gray-200 hover:border-orange-300'
                                        }`}
                                    >
                                        <div className="text-orange-600 font-bold text-sm">ãƒãƒ¼ãƒ‰</div>
                                        <div className="text-xs text-gray-600">8å•ã¾ã§</div>
                                    </button>
                                    <button
                                        onClick={() => {
                                            setDifficulty('expert');
                                            setMaxQuestions(6);
                                            showToast('âš¡ ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰èµ·å‹•ï¼', 'error');
                                            console.log('Set Expert Mode: maxQuestions=6');
                                            if (typeof window !== 'undefined') {
                                                window.__DEBUG_MAX_QUESTIONS = 6;
                                            }
                                        }}
                                        className={`p-2 rounded-lg border-2 transition-all ${
                                            difficulty === 'expert' 
                                                ? 'border-red-500 bg-red-50 animate-pulse' 
                                                : 'border-gray-200 hover:border-red-300'
                                        }`}
                                    >
                                        <div className="text-red-600 font-bold text-sm">ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ</div>
                                        <div className="text-xs text-gray-600">6å•ã¾ã§</div>
                                    </button>
                                </div>
                                
                                {/* ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒŸãƒƒã‚·ãƒ§ãƒ³ */}
                                {difficulty === 'expert' && (
                                    <div className="p-3 bg-gradient-to-r from-red-50 to-orange-50 rounded-lg mb-3 fade-in">
                                        <div className="text-sm font-bold text-red-700 mb-2">ğŸ† ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆãƒãƒ£ãƒ¬ãƒ³ã‚¸</div>
                                        <div className="grid gap-2">
                                            <label className="flex items-center cursor-pointer">
                                                <input
                                                    type="checkbox"
                                                    onChange={(e) => setChallengeMode(e.target.checked ? 'noHint' : null)}
                                                    className="mr-2"
                                                />
                                                <span className="text-xs">ãƒãƒ¼ãƒ’ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰ (ã‚¹ã‚³ã‚¢Ã—1.5)</span>
                                            </label>
                                            <label className="flex items-center cursor-pointer">
                                                <input
                                                    type="checkbox"
                                                    onChange={(e) => setCurrentMission(e.target.checked ? 'speedrun' : null)}
                                                    className="mr-2"
                                                />
                                                <span className="text-xs">ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ©ãƒ³ - 3åˆ†ä»¥å†…ã‚¯ãƒªã‚¢ (ã‚¹ã‚³ã‚¢Ã—2)</span>
                                            </label>
                                            <label className="flex items-center cursor-pointer">
                                                <input
                                                    type="checkbox"
                                                    onChange={(e) => setCurrentMission(e.target.checked ? 'perfect' : null)}
                                                    className="mr-2"
                                                />
                                                <span className="text-xs">ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆãƒ©ãƒ³ - å…¨è³ªå•70ç‚¹ä»¥ä¸Š (ç‰¹åˆ¥ç§°å·)</span>
                                            </label>
                                        </div>
                                    </div>
                                )}
                            </div>
                            
                            <div>
                                <h3 className="text-lg font-semibold mb-3">1. ãƒ†ãƒ¼ãƒã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠ</h3>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                    {themeCategories.map(cat => (
                                        <button
                                            key={cat.id}
                                            onClick={async () => {
                                                if (!isGeneratingPainPoints) {
                                                    setSelectedCategory(cat.id);
                                                    setIsGeneratingPainPoints(true);
                                                    try {
                                                        const points = await generatePainPoints(cat.id);
                                                        if (points && points.length > 0) {
                                                            setPainPoints(points);
                                                        } else {
                                                            // Empty result, clear selection to allow retry
                                                            setSelectedCategory(null);
                                                            setPainPoints([]);
                                                        }
                                                    } catch (error) {
                                                        console.error('All retries failed:', error);
                                                        // Reset selection to allow user to try again
                                                        setSelectedCategory(null);
                                                        setPainPoints([]);
                                                    } finally {
                                                        setIsGeneratingPainPoints(false);
                                                    }
                                                }
                                            }}
                                            disabled={isGeneratingPainPoints}
                                            className={`p-4 rounded-lg border-2 transition-all ${
                                                isGeneratingPainPoints 
                                                    ? 'opacity-50 cursor-not-allowed' 
                                                    : 'card-shadow-hover'
                                            } ${
                                                selectedCategory === cat.id 
                                                    ? 'border-purple-500 bg-purple-50' 
                                                    : 'border-gray-200 hover:border-purple-300'
                                            }`}
                                        >
                                            <div className="text-2xl mb-1">{cat.icon}</div>
                                            <div className="font-medium text-sm">{cat.title}</div>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            
                            {/* ãƒšã‚¤ãƒ³ãƒã‚¤ãƒ³ãƒˆç”Ÿæˆä¸­ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */}
                            {isGeneratingPainPoints && (
                                <div className="fade-in">
                                    <div className="flex items-center justify-center py-8">
                                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500"></div>
                                        <span className="ml-3 text-gray-600">ãŠé¡Œã‚’ç”Ÿæˆä¸­...</span>
                                    </div>
                                </div>
                            )}
                            
                            {selectedCategory && painPoints.length > 0 && !isGeneratingPainPoints && (
                                <div className="fade-in">
                                    <h3 className="text-lg font-semibold mb-3">2. å›°ã‚Šã”ã¨ã‚’é¸æŠ</h3>
                                    <div className="space-y-2">
                                        {painPoints.map((point, index) => (
                                            <button
                                                key={index}
                                                onClick={() => setSelectedPainPoint(point)}
                                                className={`w-full text-left p-4 rounded-lg border-2 transition-all ${
                                                    selectedPainPoint === point
                                                        ? 'border-purple-500 bg-purple-50'
                                                        : 'border-gray-200 hover:border-purple-300'
                                                }`}
                                            >
                                                <div className="font-medium">{point}</div>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            <div>
                                <h3 className="text-lg font-semibold mb-3">ã‚«ã‚¹ã‚¿ãƒ å›°ã‚Šã”ã¨</h3>
                                <input
                                    type="text"
                                    value={customPainPoint}
                                    onChange={(e) => {
                                        setCustomPainPoint(e.target.value);
                                        setSelectedPainPoint(''); // ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›æ™‚ã¯é¸æŠã‚’ã‚¯ãƒªã‚¢
                                    }}
                                    placeholder="å…·ä½“çš„ãªå›°ã‚Šã”ã¨ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šãƒã‚¹ã«ä¹—ã‚‹ã®ãŒè‹¦æ‰‹ã§å›°ã£ã¦ã„ã‚‹ï¼‰"
                                    className="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-colors"
                                />
                            </div>
                            
                            <div className="flex gap-3">
                                <button
                                    onClick={startGame}
                                    disabled={!apiTested || isGeneratingPersona}
                                    className={`w-full py-3 px-6 rounded-lg font-medium transition-all transform ${
                                        apiTested && !isGeneratingPersona
                                            ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white hover:from-purple-600 hover:to-pink-600 hover:scale-105' 
                                            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                    }`}
                                >
                                    {isGeneratingPersona ? 'ãƒšãƒ«ã‚½ãƒŠç”Ÿæˆä¸­...' : apiTested ? 'ã‚²ãƒ¼ãƒ é–‹å§‹' : 'APIãƒ†ã‚¹ãƒˆãŒå¿…è¦'}
                                </button>
                            </div>
                            
                        </div>
                    </div>
                    
                    {/* APIè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */}
                    {showApiSettings && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 fade-in">
                            <div className="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                                <h2 className="text-xl font-bold mb-4">APIè¨­å®š</h2>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">OpenRouter APIã‚­ãƒ¼</label>
                                        <input
                                            type="password"
                                            value={apiKey}
                                            onChange={(e) => {
                                                setApiKey(e.target.value);
                                                setApiTested(false);
                                            }}
                                            placeholder="sk-or-..."
                                            className="w-full p-2 border rounded focus:border-purple-500 focus:outline-none"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">ãƒ¢ãƒ‡ãƒ«</label>
                                        <select
                                            value={apiModel}
                                            onChange={(e) => {
                                                setApiModel(e.target.value);
                                                setApiTested(false);
                                            }}
                                            className="w-full p-2 border rounded focus:border-purple-500 focus:outline-none"
                                        >
                                            <option value="deepseek/deepseek-chat-v3.1:free">DeepSeek Chat V3.1 (Free)</option>
                                            <option value="openrouter/sonoma-sky-alpha">Sonoma Sky Alpha (Free)</option>
                                            <option value="deepseek/deepseek-chat-v3-0324:free">DeepSeek Chat V3 (Free)</option>
                                        </select>
                                    </div>
                                    <div className="flex gap-2 items-center">
                                        <button
                                            onClick={testAPI}
                                            disabled={apiTesting}
                                            className={`flex-1 py-2 px-4 rounded-lg font-medium transition-all ${
                                                apiTested
                                                    ? 'bg-green-500 text-white hover:bg-green-600'
                                                    : !apiKey
                                                        ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                                        : 'bg-blue-500 text-white hover:bg-blue-600'
                                            }`}
                                        >
                                            {apiTesting ? 'ãƒ†ã‚¹ãƒˆä¸­...' : apiTested ? 'âœ“ æ¥ç¶šæˆåŠŸ' : 'APIã‚’ãƒ†ã‚¹ãƒˆ'}
                                        </button>
                                        {apiTested && (
                                            <button
                                                onClick={() => setShowApiSettings(false)}
                                                className="py-2 px-4 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
                                            >
                                                é–‰ã˜ã‚‹
                                            </button>
                                        )}
                                    </div>
                                    {!apiTested && (
                                        <p className="text-xs text-red-500">
                                            â€»APIãƒ†ã‚¹ãƒˆã«æˆåŠŸã™ã‚‹ã¾ã§ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã§ãã¾ã›ã‚“
                                        </p>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
            
            // ã‚²ãƒ¼ãƒ ç”»é¢
            const renderGame = () => {
                return (
                <div className={`min-h-screen flex flex-col ${isMobile ? 'mobile-viewport' : ''}`}>
                    {/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */}
                    <div className={`bg-white shadow-lg ${isMobile ? 'mobile-status-bar' : 'p-4'}`}>
                        <div className="max-w-6xl mx-auto">
                            <div className={isMobile ? 'mobile-compact-score' : 'grid grid-cols-2 md:grid-cols-4 gap-4'}>
                                {isMobile ? (
                                    // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤º
                                    <>
                                        <div className="flex items-center gap-2">
                                            <button
                                                onClick={() => setShowPersonaInfo(!showPersonaInfo)}
                                                className="p-1.5 bg-blue-500 text-white rounded-full"
                                                title="ãƒšãƒ«ã‚½ãƒŠæƒ…å ±"
                                            >
                                                <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
                                                </svg>
                                            </button>
                                            <div className="flex items-center gap-1">
                                                <span className="text-[11px]">
                                                    {mood === 'open' && 'ğŸ˜Š'}
                                                    {mood === 'normal' && 'ğŸ˜'}
                                                    {mood === 'guard' && 'ğŸ˜”'}
                                                    {mood === 'close' && 'ğŸ˜¤'}
                                                </span>
                                                <span className="text-[12px] font-bold text-purple-600">{currentScore}ç‚¹</span>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <div className="flex gap-0.5">
                                                {[...Array(Math.min(maxQuestions, 10))].map((_, i) => (
                                                    <div
                                                        key={i}
                                                        className={`w-2 h-2 rounded-full ${
                                                            i < questionCount 
                                                                ? 'bg-gray-300' 
                                                                : 'bg-purple-500'
                                                        }`}
                                                    />
                                                ))}
                                            </div>
                                            <span className="text-[11px] text-gray-500">
                                                æ®‹{maxQuestions - questionCount}
                                            </span>
                                        </div>
                                    </>
                                ) : (
                                    // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨é€šå¸¸è¡¨ç¤º
                                    <>
                                        <div>
                                            <div className="text-sm text-gray-500 mb-1">è©±ã—ãŸã„åº¦</div>
                                            <div className="progress-bar">
                                                <div 
                                                    className={`progress-bar-fill bg-gradient-to-r ${getMoodColor()}`}
                                                    style={{ width: `${talkMeter}%` }}
                                                />
                                            </div>
                                        </div>
                                        <div>
                                            <div className="text-sm text-gray-500 mb-1">ã‚¹ã‚³ã‚¢</div>
                                            <div className="text-2xl font-bold">
                                                {currentScore}
                                            </div>
                                            <div className="text-xs text-gray-500 mt-1">
                                                ç‚¹
                                            </div>
                                        </div>
                                        <div>
                                            <div className="text-sm text-gray-500 mb-1">æ®‹ã‚Šè³ªå•</div>
                                            <div className="flex gap-1">
                                                {[...Array(maxQuestions)].map((_, i) => (
                                                    <div
                                                        key={i}
                                                        className={`w-3 h-3 rounded-full ${
                                                            i < questionCount 
                                                                ? 'bg-gray-300' 
                                                                : 'bg-purple-500'
                                                        }`}
                                                    />
                                                ))}
                                            </div>
                                        </div>
                                        <div>
                                            <div className="text-sm text-gray-500 mb-1">æ°—åˆ†</div>
                                            <div className="flex items-center gap-2">
                                                <span className="text-2xl">
                                                    {mood === 'open' && 'ğŸ˜Š'}
                                                    {mood === 'normal' && 'ğŸ˜'}
                                                    {mood === 'guard' && 'ğŸ˜”'}
                                                    {mood === 'close' && 'ğŸ˜¤'}
                                                </span>
                                                <span className="text-xs text-gray-600">
                                                    {mood === 'open' && 'é–‹æ”¾çš„'}
                                                    {mood === 'normal' && 'æ™®é€š'}
                                                    {mood === 'guard' && 'è­¦æˆ’'}
                                                    {mood === 'close' && 'é–‰é–çš„'}
                                                </span>
                                            </div>
                                        </div>
                                    </>
                                )}
                            </div>
                            
                            {/* ãƒšãƒ«ã‚½ãƒŠæƒ…å ±è¡¨ç¤ºãƒœã‚¿ãƒ³ - ãƒ¢ãƒã‚¤ãƒ«ã§ã¯éè¡¨ç¤º */}
                            {!isMobile && (
                                <div className="mt-3 flex justify-between items-center">
                                    <button
                                        onClick={() => setShowPersonaInfo(!showPersonaInfo)}
                                        className="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-lg text-sm font-medium hover:from-blue-600 hover:to-purple-600 transition-all"
                                    >
                                        {showPersonaInfo ? 'ğŸ‘¤ ãƒšãƒ«ã‚½ãƒŠæƒ…å ±ã‚’éš ã™' : 'ğŸ‘¤ ãƒšãƒ«ã‚½ãƒŠæƒ…å ±ã‚’è¦‹ã‚‹'}
                                    </button>
                                    <div className="text-sm text-gray-600">
                                        ç›¸æ‰‹: <strong>{persona?.name}</strong> ({persona?.age}æ­³ / {persona?.job})
                                    </div>
                                </div>
                            )}
                            
                            {/* ãƒšãƒ«ã‚½ãƒŠè©³ç´°æƒ…å ±ãƒ‘ãƒãƒ« */}
                            {showPersonaInfo && persona && (
                                isMobile ? (
                                    // ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«
                                    <>
                                        <div className="mobile-persona-overlay" onClick={() => setShowPersonaInfo(false)} />
                                        <div className="mobile-persona-modal">
                                            <div className="flex justify-between items-center mb-3">
                                                <h3 className="text-lg font-bold">ãƒšãƒ«ã‚½ãƒŠæƒ…å ±</h3>
                                                <button
                                                    onClick={() => setShowPersonaInfo(false)}
                                                    className="p-1 rounded-full hover:bg-gray-100"
                                                >
                                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                                    </svg>
                                                </button>
                                            </div>
                                            <div className="space-y-2 text-sm">
                                                <div className="flex justify-between">
                                                    <span className="text-gray-500">åå‰:</span>
                                                    <span className="font-medium">{persona.name}</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span className="text-gray-500">å¹´é½¢:</span>
                                                    <span className="font-medium">{persona.age}æ­³ / {persona.gender}</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span className="text-gray-500">è·æ¥­:</span>
                                                    <span className="font-medium">{persona.job}</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span className="text-gray-500">å±…ä½åœ°:</span>
                                                    <span className="font-medium">{persona.location}</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span className="text-gray-500">å®¶æ—:</span>
                                                    <span className="font-medium">{persona.family}</span>
                                                </div>
                                                {persona.currentSituation && (
                                                    <div className="pt-2 mt-2 border-t">
                                                        <div className="text-gray-500 mb-1">ç¾åœ¨ã®çŠ¶æ³:</div>
                                                        <div className="text-xs">{persona.currentSituation}</div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </>
                                ) : (
                                    // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ãƒ‘ãƒãƒ«
                                <div className="mt-3 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border border-blue-200 fade-in">
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                        <div>
                                            <div className="text-xs text-gray-500">åå‰</div>
                                            <div className="font-medium">{persona.name}</div>
                                        </div>
                                        <div>
                                            <div className="text-xs text-gray-500">å¹´é½¢ãƒ»æ€§åˆ¥</div>
                                            <div className="font-medium">{persona.age}æ­³ / {persona.gender}</div>
                                        </div>
                                        <div>
                                            <div className="text-xs text-gray-500">è·æ¥­</div>
                                            <div className="font-medium">{persona.job}</div>
                                        </div>
                                        <div>
                                            <div className="text-xs text-gray-500">å±…ä½åœ°</div>
                                            <div className="font-medium">{persona.location}</div>
                                        </div>
                                        <div>
                                            <div className="text-xs text-gray-500">å®¶æ—</div>
                                            <div className="font-medium">{persona.family}</div>
                                        </div>
                                        <div>
                                            <div className="text-xs text-gray-500">è¶£å‘³</div>
                                            <div className="font-medium">{persona.hobbies?.join('ã€')}</div>
                                        </div>
                                        {persona.personality?.traits && (
                                            <div className="md:col-span-2">
                                                <div className="text-xs text-gray-500">æ€§æ ¼</div>
                                                <div className="font-medium">{persona.personality.traits.join('ã€')}</div>
                                            </div>
                                        )}
                                    </div>
                                    {persona.currentSituation && (
                                        <div className="mt-3 p-3 bg-white rounded">
                                            <div className="text-xs text-gray-500 mb-1">ç¾åœ¨ã®çŠ¶æ³</div>
                                            <div className="text-sm">{persona.currentSituation}</div>
                                        </div>
                                    )}
                                </div>
                                )
                            )}
                            
                            {/* ãƒ™ã‚¹ãƒˆè³ªå•è¡¨ç¤º - ãƒ¢ãƒã‚¤ãƒ«ã§ã¯éè¡¨ç¤º */}
                            {!isMobile && bestQuestions.length > 0 && (
                                <div className="mt-4 p-3 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg">
                                    <div className="text-sm font-bold text-purple-700 mb-2">ğŸ† å„ªç§€ãªè³ªå•</div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                                        {bestQuestions.slice(0, 3).map((q, i) => (
                                            <div key={i} className="bg-white p-2 rounded text-xs">
                                                <div className="font-medium text-gray-800 truncate">ã€Œ{q.question}ã€</div>
                                                <div className="text-purple-600 font-bold">{q.score}ç‚¹</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            {/* ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ’ãƒ³ãƒˆ - ãƒ¢ãƒã‚¤ãƒ«ã§ã¯éè¡¨ç¤º */}
                            {!isMobile && questionCount > 2 && scoreHistory.length > 0 && (
                                <div className="mt-3 p-3 bg-blue-50 rounded-lg">
                                    <div className="text-xs text-blue-800">
                                        ğŸ’¡ ãƒ’ãƒ³ãƒˆ: 
                                        {scoreHistory[scoreHistory.length - 1] < 50 ? 
                                            'ã€Œãªãœã€ã€Œã©ã†ã—ã¦ã€ã‚’ä½¿ã£ã¦æ·±æ˜ã‚Šã—ã¦ã¿ã¾ã—ã‚‡ã†' :
                                         scoreHistory[scoreHistory.length - 1] < 70 ?
                                            'å…·ä½“çš„ãªã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’èã„ã¦ã¿ã¾ã—ã‚‡ã†' :
                                            'ç´ æ™´ã‚‰ã—ã„è³ªå•ã§ã™ï¼ã“ã®èª¿å­ã§ç¶šã‘ã¾ã—ã‚‡ã†'}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {/* ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ */}
                    <div className="relative flex-1">
                        <div 
                            ref={chatAreaRef}
                            className={`h-full overflow-y-auto p-4 bg-gray-50 ${isMobile ? 'mobile-chat-area smooth-scroll' : ''}`}
                            style={isMobile && keyboardHeight > 0 ? { paddingBottom: `${keyboardHeight + 70}px` } : {}}
                            onScroll={handleScroll}
                        >
                        <div className="max-w-4xl mx-auto space-y-3">
                            {messages.map((msg, index) => (
                                <div 
                                    key={index} 
                                    className={`flex ${msg.type === 'user' ? 'justify-end' : 'justify-start'} fade-in`}
                                >
                                    <div className={`message-bubble ${msg.type}`}>
                                        <div>{msg.content}</div>
                                        {msg.score !== undefined && (
                                            <div className="mt-2 text-xs opacity-70">
                                                ã‚¹ã‚³ã‚¢: {msg.score}ç‚¹
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ))}
                            {isTyping && (
                                <div className="flex justify-start">
                                    <div className="message-bubble ai flex gap-1 items-center">
                                        <span className="typing-dot inline-block w-2 h-2 bg-gray-400 rounded-full"></span>
                                        <span className="typing-dot inline-block w-2 h-2 bg-gray-400 rounded-full"></span>
                                        <span className="typing-dot inline-block w-2 h-2 bg-gray-400 rounded-full"></span>
                                    </div>
                                </div>
                            )}
                            <div ref={messagesEndRef} />
                        </div>
                        </div>
                        
                        {/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä¸Šã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãŸæ™‚ã®ã¿è¡¨ç¤º */}
                        {!shouldAutoScroll && (
                            <button
                                onClick={scrollToLatest}
                                className="absolute bottom-4 right-4 bg-purple-500 text-white p-3 rounded-full shadow-lg hover:bg-purple-600 transition-all transform hover:scale-110 animate-bounce"
                                aria-label="æœ€æ–°ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¸"
                            >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                                </svg>
                            </button>
                        )}
                    </div>
                    
                    {/* å…¥åŠ›ã‚¨ãƒªã‚¢ */}
                    <div className={`bg-white border-t ${isMobile ? 'mobile-input-area' : 'p-4'}`}>
                        <div className="max-w-4xl mx-auto">
                            <div className="flex gap-2">
                                <input
                                    ref={inputRef}
                                    type="text"
                                    value={currentQuestion}
                                    onChange={(e) => setCurrentQuestion(e.target.value)}
                                    onKeyPress={(e) => {
                                        if (e.key === 'Enter') {
                                            e.preventDefault();
                                            handleSubmitQuestion();
                                        }
                                    }}
                                    onFocus={() => {
                                        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ©Ÿèƒ½ã«ä»»ã›ã‚‹
                                    }}
                                    placeholder="è³ªå•ã‚’å…¥åŠ›..."
                                    disabled={questionCount >= maxQuestions}
                                    autoComplete="off"
                                    autoCorrect="off"
                                    autoCapitalize="off"
                                    spellCheck="false"
                                    className={`flex-1 ${isMobile ? 'mobile-input-field' : 'p-3'} border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-colors disabled:bg-gray-100`}
                                />
                                <button
                                    onClick={handleSubmitQuestion}
                                    disabled={!currentQuestion.trim() || questionCount >= maxQuestions}
                                    className={`${isMobile ? 'mobile-button px-4' : 'px-6'} py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:from-purple-600 hover:to-pink-600 transition-all transform hover:scale-105`}
                                >
                                    é€ä¿¡
                                </button>
                            </div>
                            {comboCount > 0 && (
                                <div className="mt-2 text-center text-purple-600 font-bold bounce">
                                    ğŸ”¥ {comboCount}ã‚³ãƒ³ãƒœï¼
                                </div>
                            )}
                        </div>
                    </div>
                </div>
                );
            };
            
            // AIã«ã‚ˆã‚‹ä¼šè©±åˆ†æç”Ÿæˆ
            const [aiAnalysis, setAiAnalysis] = useState(null);
            const generateAIAnalysis = useCallback(async () => {
                console.log('generateAIAnalysis called', { apiKey: !!apiKey, messagesLength: messages.length });
                if (!apiKey || messages.length === 0) {
                    console.log('Skipping AI analysis - no API key or messages');
                    return;
                }
                
                setIsTyping(true);
                showToast('ä¼šè©±ã‚’åˆ†æä¸­...', 'info');
                
                const conversationHistory = messages.map(m => 
                    `${m.type === 'user' ? 'ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼' : persona.name}: ${m.content}${m.score ? ` (ã‚¹ã‚³ã‚¢: ${m.score}ç‚¹)` : ''}`
                ).join('\n');
                
                const analysisPrompt = `ã‚ãªãŸã¯ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼æŠ€è¡“ã®å°‚é–€å®¶ã§ã™ã€‚
ä»¥ä¸‹ã®ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ä¼šè©±ã‚’åˆ†æã—ã€ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼ï¼ˆè³ªå•è€…ï¼‰ã®æŠ€è¡“ã‚’è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚

é‡è¦: ã“ã‚Œã¯ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼ã®è³ªå•æŠ€è¡“ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã®åˆ†æã§ã™ã€‚
ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã•ã‚ŒãŸå´ï¼ˆ${persona.name}ï¼‰ã¸ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ãƒ†ãƒ¼ãƒ: ${persona.painPoints && persona.painPoints[0] ? persona.painPoints[0] : 'å›°ã‚Šã”ã¨'}
ãƒšãƒ«ã‚½ãƒŠ: ${persona.name} (${persona.age}æ­³, ${persona.job})

ä¼šè©±å±¥æ­´:
${conversationHistory}

ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼ã®è³ªå•æŠ€è¡“ã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®JSONå½¢å¼ã§åˆ†æã—ã¦ãã ã•ã„ã€‚
é‡è¦: ç°¡æ½”ã«è¦ç‚¹ã‚’ã¾ã¨ã‚ã¦ãã ã•ã„:

{
  "strengths": [
    {
      "title": "ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼ã®å¼·ã¿ï¼ˆç°¡æ½”ã«ï¼‰",
      "detail": "å…·ä½“çš„ã«ã©ã®è³ªå•ãŒè‰¯ã‹ã£ãŸã‹ã€ãªãœè‰¯ã‹ã£ãŸã‹ã‚’è©³ã—ãèª¬æ˜"
    }
  ],
  "improvements": [
    {
      "title": "æ”¹å–„ã™ã¹ãç‚¹ï¼ˆç°¡æ½”ã«ï¼‰",
      "detail": "ã©ã®è³ªå•ã®ã©ã“ãŒå•é¡Œã ã£ãŸã‹ã€ã©ã†æ”¹å–„ã™ã¹ãã‹å…·ä½“çš„ã«èª¬æ˜",
      "practice": "å®Ÿè·µçš„ãªç·´ç¿’æ–¹æ³•ã‚’å…·ä½“çš„ã«èª¬æ˜",
      "examples": ["æ”¹å–„ã•ã‚ŒãŸè³ªå•ä¾‹ã‚’2-3å€‹", "åˆ¥ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒä¾‹"]
    }
  ],
  "bestQuestion": {
    "question": "ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼ãŒè¡Œã£ãŸæœ€ã‚‚å„ªã‚ŒãŸè³ªå•",
    "reason": "ãªãœãã®è³ªå•ãŒå„ªã‚Œã¦ã„ãŸã‹"
  },
  "worstQuestion": {
    "question": "ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼ã®æœ€ã‚‚æ”¹å–„ãŒå¿…è¦ãªè³ªå•",
    "improvement": "ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼ã¯ã“ã†èãã¹ãã ã£ãŸ"
  },
  "insights": ["ã‚¤ãƒ³ã‚µã‚¤ãƒˆ1", "ã‚¤ãƒ³ã‚µã‚¤ãƒˆ2", "ã‚¤ãƒ³ã‚µã‚¤ãƒˆ3"],
  "overallFeedback": "ç·åˆçš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆ100-150æ–‡å­—ç¨‹åº¦ï¼‰",
  "nextChallenge": "ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼ãŒæ¬¡å›æŒ‘æˆ¦ã™ã¹ãå…·ä½“çš„ãªèª²é¡Œ",
  "missedOpportunities": [
    {
      "moment": "èãé€ƒã—ãŸé‡è¦ãªç¬é–“",
      "whatToAsk": "ãã®æ™‚èãã¹ãã ã£ãŸè³ªå•",
      "reason": "ãªãœãã‚ŒãŒé‡è¦ã ã£ãŸã‹"
    }
  ],
  "emotionalIntelligence": {
    "score": 80,
    "feedback": "ç›¸æ‰‹ã®æ„Ÿæƒ…ã¸ã®é…æ…®ã«ã¤ã„ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯"
  },
  "questioningTechniques": {
    "openQuestions": "ã‚ªãƒ¼ãƒ—ãƒ³è³ªå•ã®ä½¿ã„æ–¹è©•ä¾¡",
    "followUp": "ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—è³ªå•ã®è©•ä¾¡", 
    "probing": "æ·±æ˜ã‚Šè³ªå•ã®è©•ä¾¡"
  },
  "stats": {
    "avgScore": 50,
    "whyQuestions": 3,
    "openQuestions": 5,
    "avgLength": 30,
    "totalInsights": 2
  },
  "challenges": [
    {
      "title": "ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼ãŒæŒ‘æˆ¦ã™ã¹ãèª²é¡Œ",
      "approach": "ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼ãŒå–ã‚‹ã¹ãã‚¢ãƒ—ãƒ­ãƒ¼ãƒæ–¹æ³•",
      "techniques": ["ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼ãŒç¿’å¾—ã™ã¹ãå…·ä½“çš„ãªãƒ†ã‚¯ãƒ‹ãƒƒã‚¯"]
    }
  ]
}

æ³¨æ„: ã™ã¹ã¦ã®åˆ†æã¯ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼ã®æŠ€è¡“å‘ä¸Šã®ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚
${persona.name}ã¸ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`;
                
                // ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯
                const maxRetries = 3;
                let retryCount = 0;
                let lastError = null;
                
                while (retryCount < maxRetries) {
                    try {
                        const analysisModel = apiModel || 'deepseek/deepseek-chat-v3.1:free';
                        
                        console.log('Generating analysis with model:', analysisModel);
                        
                        // ãƒªãƒˆãƒ©ã‚¤æ™‚ã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ”¹å–„
                        const retryPromptSuffix = retryCount > 0 ? 
                            '\n\né‡è¦: å¿…ãšå®Œå…¨ã§æœ‰åŠ¹ãªJSONå½¢å¼ã§å¿œç­”ã—ã¦ãã ã•ã„ã€‚JSONã®ã¿ã‚’è¿”ã—ã€èª¬æ˜æ–‡ã¯å«ã‚ãªã„ã§ãã ã•ã„ã€‚é…åˆ—ãŒç©ºã®å ´åˆã§ã‚‚[]ã¨è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚æ–‡å­—åˆ—ã¯å¿…ãš""ã§å›²ã‚“ã§ãã ã•ã„ã€‚' : '';
                        
                        const response = await safariFetch('https://openrouter.ai/api/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${apiKey}`,
                                'Content-Type': 'application/json',
                                'HTTP-Referer': window.location.origin || 'http://localhost',
                                'X-Title': 'Interview Game Analysis'
                            },
                            body: JSON.stringify({
                                model: analysisModel,
                                messages: [
                                    { 
                                        role: 'system', 
                                        content: 'ã‚ãªãŸã¯ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼åˆ†æã®å°‚é–€å®¶ã§ã™ã€‚ä¸ãˆã‚‰ã‚ŒãŸä¼šè©±ã‚’åˆ†æã—ã€å¿…ãšå®Œå…¨ã§æœ‰åŠ¹ãªJSONå½¢å¼ã®ã¿ã§å¿œç­”ã—ã¦ãã ã•ã„ã€‚èª¬æ˜æ–‡ã‚„è¿½åŠ ã®ãƒ†ã‚­ã‚¹ãƒˆã¯å«ã‚ãªã„ã§ãã ã•ã„ã€‚JSONã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã¯å¿…ãšãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã¿ã€æ–‡å­—åˆ—å€¤ã‚‚ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã‚“ã§ãã ã•ã„ã€‚é…åˆ—ã‚„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æœ€å¾Œã®è¦ç´ ã«ã‚«ãƒ³ãƒã‚’ä»˜ã‘ãªã„ã§ãã ã•ã„ã€‚' 
                                    },
                                    { role: 'user', content: analysisPrompt + retryPromptSuffix }
                                ],
                                temperature: 0.5,
                                max_tokens: analysisModel === 'openrouter/sonoma-sky-alpha' ? 8000 : 4000 // Sonoma: 8000, DeepSeek: 4000
                            })
                        }, 30000); // 30 second timeout for analysis
                        
                        if (!response.ok) {
                            throw new Error(`API Error: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                            throw new Error('Invalid API response structure');
                        }
                        
                        const content = data.choices[0].message.content;
                        
                        // JSONãƒ‘ãƒ¼ã‚¹å‡¦ç†
                        try {
                            let jsonStr = content;
                            
                            // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’é™¤å»
                            jsonStr = jsonStr.replace(/```json\n?|```\n?|```/g, '');
                            
                            // JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æŠ½å‡º
                            const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                jsonStr = jsonMatch[0];
                            }
                            
                            // ä¸€èˆ¬çš„ãªJSONã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£
                            jsonStr = jsonStr
                                .replace(/,\s*\}/g, '}') // æœ«å°¾ã®ã‚«ãƒ³ãƒã‚’å‰Šé™¤
                                .replace(/,\s*\]/g, ']') // é…åˆ—æœ«å°¾ã®ã‚«ãƒ³ãƒã‚’å‰Šé™¤
                                .replace(/([\[\{,])\s*,/g, '$1') // é€£ç¶šã‚«ãƒ³ãƒã‚’å‰Šé™¤
                                .replace(/\n\s*\n/g, '\n') // ç©ºè¡Œã‚’å‰Šé™¤
                                .replace(/[\u0000-\u001F\u007F-\u009F]/g, ''); // åˆ¶å¾¡æ–‡å­—ã‚’å‰Šé™¤
                            
                            // ä¸å®Œå…¨ãªJSONã®ä¿®å¾©
                            if (jsonStr.includes('...') || jsonStr.length < 50) {
                                throw new Error('Incomplete JSON response');
                            }
                            
                            const parsedAnalysis = JSON.parse(jsonStr);
                            
                            // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ¤œè¨¼
                            if (!parsedAnalysis.strengths || !parsedAnalysis.improvements) {
                                throw new Error('Missing required fields in analysis');
                            }
                            
                            // statsãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
                            if (!parsedAnalysis.stats) {
                                const analysisData = getAnalysisData();
                                parsedAnalysis.stats = analysisData;
                            }
                            
                            // é…åˆ—ã®æ¤œè¨¼ã‚’è¿½åŠ 
                            const validatedAnalysis = {
                                ...parsedAnalysis,
                                strengths: Array.isArray(parsedAnalysis.strengths) ? parsedAnalysis.strengths : [],
                                improvements: Array.isArray(parsedAnalysis.improvements) ? parsedAnalysis.improvements : [],
                                insights: Array.isArray(parsedAnalysis.insights) ? parsedAnalysis.insights : [],
                                challenges: Array.isArray(parsedAnalysis.challenges) ? parsedAnalysis.challenges : []
                            };
                            
                            setAiAnalysis(validatedAnalysis);
                            console.log('AI Analysis parsed successfully:', validatedAnalysis);
                            showToast('åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
                            break; // æˆåŠŸã—ãŸã‚‰ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
                            
                        } catch (parseError) {
                            lastError = parseError;
                            console.error(`Parse attempt ${retryCount + 1} failed:`, parseError);
                            console.error('Raw content:', content);
                            console.error('Cleaned JSON:', jsonStr);
                            
                            // ãƒ‡ãƒãƒƒã‚°: JSONã®æ§‹é€ å•é¡Œã‚’è©³ç´°ã«è¨˜éŒ²
                            if (parseError.message.includes('JSON')) {
                                console.error('JSON parse error at position:', parseError.message);
                                // æœ€åˆã®100æ–‡å­—ã¨æœ€å¾Œã®100æ–‡å­—ã‚’è¡¨ç¤º
                                if (jsonStr && jsonStr.length > 200) {
                                    console.error('JSON start:', jsonStr.substring(0, 100));
                                    console.error('JSON end:', jsonStr.substring(jsonStr.length - 100));
                                }
                            }
                            
                            if (retryCount < maxRetries - 1) {
                                console.log(`Retrying AI analysis (${retryCount + 2}/${maxRetries})...`);
                                showToast(`åˆ†æã‚’å†è©¦è¡Œä¸­... (${retryCount + 2}/${maxRetries})`, 'info');
                                retryCount++;
                                await new Promise(resolve => setTimeout(resolve, 1000)); // 1ç§’å¾…æ©Ÿ
                            } else {
                                throw parseError;
                            }
                        }
                        
                    } catch (error) {
                        lastError = error;
                        retryCount++;
                        
                        if (retryCount >= maxRetries) {
                            console.error('All analysis attempts failed:', error);
                            showToast('AIåˆ†æã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•åˆ†æã‚’ä½¿ç”¨ã—ã¾ã™', 'warning');
                            
                            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ‰‹å‹•åˆ†æã‚’ä½¿ç”¨
                            const manualAnalysis = generateDetailedAnalysis();
                            setAiAnalysis({
                                ...manualAnalysis,
                                overallFeedback: 'è‡ªå‹•åˆ†æã«å¤±æ•—ã—ãŸãŸã‚ã€åŸºæœ¬çš„ãªåˆ†æçµæœã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚',
                                fromManual: true
                            });
                            break;
                        }
                        
                        console.log(`Retrying due to API error (${retryCount + 1}/${maxRetries})...`);
                        await new Promise(resolve => setTimeout(resolve, 2000)); // 2ç§’å¾…æ©Ÿ
                    }
                }
                
                setIsTyping(false);
            }, [apiKey, apiModel, messages, persona, showToast, getAnalysisData, generateDetailedAnalysis, insights, bestQuestions]);
            
            // çµæœç”»é¢
            const renderResult = () => {
                // AIAnalysisãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°æ‰‹å‹•åˆ†æã‚’ä½¿ç”¨
                let analysis = aiAnalysis;
                
                // AIåˆ†æãŒä¸å®Œå…¨ãªå ´åˆã¯æ‰‹å‹•åˆ†æã§è£œå®Œ
                if (!analysis || !analysis.stats) {
                    const manualAnalysis = generateDetailedAnalysis();
                    if (analysis) {
                        // AIåˆ†æã®ä¸€éƒ¨ãŒä½¿ãˆã‚‹å ´åˆã¯ãƒãƒ¼ã‚¸ï¼ˆAIåˆ†æã‚’å„ªå…ˆï¼‰
                        analysis = {
                            ...manualAnalysis,
                            ...analysis,
                            stats: analysis.stats || manualAnalysis.stats,
                            // é…åˆ—ã¯ç¢ºå®Ÿã«å­˜åœ¨ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹
                            strengths: analysis.strengths || manualAnalysis.strengths || [],
                            improvements: analysis.improvements || manualAnalysis.improvements || [],
                            insights: analysis.insights || manualAnalysis.insights || [],
                            challenges: analysis.challenges || manualAnalysis.challenges || []
                        };
                    } else {
                        analysis = manualAnalysis;
                    }
                }
                
                // ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼ã¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®è¨­å®š
                analysis = {
                    ...analysis,
                    strengths: Array.isArray(analysis.strengths) ? analysis.strengths : [],
                    improvements: Array.isArray(analysis.improvements) ? analysis.improvements : [],
                    insights: Array.isArray(analysis.insights) ? analysis.insights : [],
                    challenges: Array.isArray(analysis.challenges) ? analysis.challenges : [],
                    stats: analysis.stats || { avgScore: 0, whyQuestions: 0, openQuestions: 0, avgLength: 0, totalInsights: 0 }
                };
                
                // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
                console.log('Rendering analysis result:', {
                    hasStrengths: analysis.strengths && analysis.strengths.length > 0,
                    hasImprovements: analysis.improvements && analysis.improvements.length > 0,
                    hasInsights: analysis.insights && analysis.insights.length > 0,
                    hasChallenges: analysis.challenges && analysis.challenges.length > 0,
                    improvements: analysis.improvements
                });
                
                // insightsã¨bestQuestionsã‚’åˆ†æçµæœã‹ã‚‰å–å¾—ã€ãªã‘ã‚Œã°stateã‹ã‚‰å–å¾—
                const displayInsights = analysis.insights || insights;
                const displayBestQuestions = analysis.bestQuestion ? 
                    [{ question: analysis.bestQuestion.question, score: 90 }] : bestQuestions;
                
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-100 to-pink-100 p-4 overflow-y-auto">
                        <div className="max-w-6xl mx-auto space-y-6">
                            {/* ã‚¹ã‚³ã‚¢ã‚µãƒãƒªãƒ¼ */}
                            <div className="bg-white rounded-2xl shadow-2xl p-8 fade-in">
                                <div className="text-center mb-8">
                                    <div className="text-6xl font-bold mb-4 gradient-text">
                                        {calculateRank()}
                                    </div>
                                    <div className="text-3xl font-bold mb-2">
                                        {currentScore} pts
                                    </div>
                                    <div className="text-gray-600">
                                        {questionCount}å›ã®è³ªå• | å¹³å‡ã‚¹ã‚³ã‚¢: {analysis.stats.avgScore}ç‚¹
                                    </div>
                                </div>
                                
                                {/* çµ±è¨ˆæƒ…å ± */}
                                <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                                    <div className="text-center p-3 bg-purple-50 rounded-lg">
                                        <div className="text-2xl font-bold text-purple-600">{analysis.stats.whyQuestions}</div>
                                        <div className="text-xs text-gray-600">ãªãœè³ªå•</div>
                                    </div>
                                    <div className="text-center p-3 bg-blue-50 rounded-lg">
                                        <div className="text-2xl font-bold text-blue-600">{analysis.stats.openQuestions}</div>
                                        <div className="text-xs text-gray-600">ã‚ªãƒ¼ãƒ—ãƒ³è³ªå•</div>
                                    </div>
                                    <div className="text-center p-3 bg-green-50 rounded-lg">
                                        <div className="text-2xl font-bold text-green-600">{analysis.stats.avgLength}</div>
                                        <div className="text-xs text-gray-600">å¹³å‡æ–‡å­—æ•°</div>
                                    </div>
                                    <div className="text-center p-3 bg-yellow-50 rounded-lg">
                                        <div className="text-2xl font-bold text-yellow-600">{analysis.stats.totalInsights}</div>
                                        <div className="text-xs text-gray-600">ã‚¤ãƒ³ã‚µã‚¤ãƒˆ</div>
                                    </div>
                                    <div className="text-center p-3 bg-pink-50 rounded-lg">
                                        <div className="text-2xl font-bold text-pink-600">{bestQuestions.length}</div>
                                        <div className="text-xs text-gray-600">å„ªç§€è³ªå•</div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* ãƒ™ã‚¹ãƒˆè³ªå•ã¨ã‚¤ãƒ³ã‚µã‚¤ãƒˆ */}
                            <div className="grid md:grid-cols-2 gap-6">
                                <div className="bg-white rounded-xl shadow-lg p-6">
                                    <h3 className="font-bold text-lg mb-4 flex items-center">
                                        <span className="text-2xl mr-2">ğŸ†</span>
                                        ãƒ™ã‚¹ãƒˆè³ªå• TOP3
                                    </h3>
                                    <div className="space-y-3">
                                        {displayBestQuestions.slice(0, 3).map((q, i) => (
                                            <div key={i} className="p-3 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg">
                                                <div className="flex justify-between items-start mb-1">
                                                    <span className="text-lg font-bold text-purple-600">#{i + 1}</span>
                                                    <span className="font-bold text-purple-600">{q.score}pts</span>
                                                </div>
                                                <div className="text-sm text-gray-700">{q.question}</div>
                                            </div>
                                        ))}
                                        {displayBestQuestions.length === 0 && (
                                            <div className="text-gray-500 text-center py-4">ã¾ã é«˜å¾—ç‚¹ã®è³ªå•ãŒã‚ã‚Šã¾ã›ã‚“</div>
                                        )}
                                    </div>
                                </div>
                                
                                <div className="bg-white rounded-xl shadow-lg p-6">
                                    <h3 className="font-bold text-lg mb-4 flex items-center">
                                        <span className="text-2xl mr-2">ğŸ’¡</span>
                                        ç™ºè¦‹ã—ãŸã‚¤ãƒ³ã‚µã‚¤ãƒˆ
                                    </h3>
                                    <div className="space-y-3">
                                        {displayInsights.map((insight, i) => (
                                            <div key={i} className="p-3 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg">
                                                <div className="text-sm text-gray-700">{insight}</div>
                                            </div>
                                        ))}
                                        {displayInsights.length === 0 && (
                                            <div className="text-gray-500 text-center py-4">
                                                ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’ç™ºè¦‹ã™ã‚‹ã«ã¯ã€ã‚ˆã‚Šæ·±ã„ã€Œãªãœã€ã®è³ªå•ãŒå¿…è¦ã§ã™
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                            
                            {/* è©³ç´°åˆ†æ */}
                            <div className="bg-white rounded-xl shadow-lg p-6">
                                <h3 className="font-bold text-xl mb-6 text-center">ğŸ“Š è©³ç´°ãªåˆ†æã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h3>
                                
                                {/* å¼·ã¿ */}
                                {analysis.strengths && analysis.strengths.length > 0 && (
                                    <div className="mb-6">
                                        <h4 className="font-bold text-lg mb-3 text-green-600">âœ¨ ã‚ãªãŸã®å¼·ã¿</h4>
                                        <div className="space-y-3">
                                            {analysis.strengths.map((strength, i) => (
                                                <div key={i} className="p-4 bg-green-50 rounded-lg border-l-4 border-green-500">
                                                    <div className="font-bold text-green-700 mb-1">{strength.title}</div>
                                                    <div className="text-sm text-gray-700">{strength.detail}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                
                                {/* ãƒ™ã‚¹ãƒˆè³ªå•ã¨ãƒ¯ãƒ¼ã‚¹ãƒˆè³ªå• */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                    {analysis.bestQuestion && (
                                        <div className="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                                            <h5 className="font-bold text-blue-700 mb-2">ğŸ† æœ€ã‚‚å„ªã‚ŒãŸè³ªå•</h5>
                                            <div className="text-sm text-gray-700 italic mb-2">ã€Œ{analysis.bestQuestion.question}ã€</div>
                                            <div className="text-xs text-gray-600">{analysis.bestQuestion.reason}</div>
                                        </div>
                                    )}
                                    {analysis.worstQuestion && (
                                        <div className="p-4 bg-red-50 rounded-lg border-l-4 border-red-500">
                                            <h5 className="font-bold text-red-700 mb-2">ğŸ’­ æ”¹å–„ãŒå¿…è¦ãªè³ªå•</h5>
                                            <div className="text-sm text-gray-700 italic mb-2">ã€Œ{analysis.worstQuestion.question}ã€</div>
                                            <div className="text-xs text-gray-600">{analysis.worstQuestion.improvement}</div>
                                        </div>
                                    )}
                                </div>
                                
                                {/* æ”¹å–„ç‚¹ */}
                                {analysis.improvements && analysis.improvements.length > 0 && (
                                    <div className="mb-6">
                                        <h4 className="font-bold text-lg mb-3 text-orange-600">ğŸ“ˆ æ”¹å–„ãƒã‚¤ãƒ³ãƒˆ</h4>
                                        <div className="space-y-3">
                                            {analysis.improvements.map((improvement, i) => (
                                                <div key={i} className="p-4 bg-orange-50 rounded-lg border-l-4 border-orange-500">
                                                    <div className="font-bold text-orange-700 mb-1">{improvement.title}</div>
                                                    <div className="text-sm text-gray-700 mb-2">{improvement.detail}</div>
                                                    {improvement.practice && (
                                                        <div className="p-3 bg-white rounded-md">
                                                            <div className="text-xs font-bold text-orange-600 mb-1">ğŸ’ª ç·´ç¿’æ–¹æ³•</div>
                                                            <div className="text-xs text-gray-600">{improvement.practice}</div>
                                                            {improvement.examples && improvement.examples.length > 0 && (
                                                                <div className="mt-2">
                                                                    <div className="text-xs font-bold text-orange-600 mb-1">ğŸ“ è³ªå•ä¾‹</div>
                                                                    <div className="space-y-1">
                                                                        {improvement.examples.map((example, i) => (
                                                                            <div key={i} className="text-xs text-gray-600 pl-2">
                                                                                {example}
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                
                                {/* èãé€ƒã—ãŸæ©Ÿä¼š */}
                                {analysis.missedOpportunities && analysis.missedOpportunities.length > 0 && (
                                    <div className="mb-6">
                                        <h4 className="font-bold text-lg mb-3 text-yellow-600">âš ï¸ èãé€ƒã—ãŸé‡è¦ãªæ©Ÿä¼š</h4>
                                        <div className="space-y-3">
                                            {analysis.missedOpportunities.map((opportunity, i) => (
                                                <div key={i} className="p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-500">
                                                    <div className="font-bold text-yellow-700 mb-1">ç¬é–“: {opportunity.moment}</div>
                                                    <div className="text-sm text-gray-700 mb-1">èãã¹ãã ã£ãŸè³ªå•: ã€Œ{opportunity.whatToAsk}ã€</div>
                                                    <div className="text-xs text-gray-600">ç†ç”±: {opportunity.reason}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                
                                {/* æ„Ÿæƒ…çŸ¥æ€§è©•ä¾¡ */}
                                {analysis.emotionalIntelligence && (
                                    <div className="mb-6 p-4 bg-pink-50 rounded-lg border-l-4 border-pink-500">
                                        <h4 className="font-bold text-pink-700 mb-2">ğŸ’— æ„Ÿæƒ…ã¸ã®é…æ…®ã‚¹ã‚³ã‚¢: {analysis.emotionalIntelligence.score}/100</h4>
                                        <div className="text-sm text-gray-700">{analysis.emotionalIntelligence.feedback}</div>
                                    </div>
                                )}
                                
                                {/* è³ªå•æŠ€è¡“ã®è©³ç´°è©•ä¾¡ */}
                                {analysis.questioningTechniques && (
                                    <div className="mb-6">
                                        <h4 className="font-bold text-lg mb-3 text-teal-600">ğŸ¯ è³ªå•æŠ€è¡“ã®è©³ç´°è©•ä¾¡</h4>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                            <div className="p-3 bg-teal-50 rounded-lg">
                                                <div className="font-bold text-teal-700 text-sm mb-1">ã‚ªãƒ¼ãƒ—ãƒ³è³ªå•</div>
                                                <div className="text-xs text-gray-600">{analysis.questioningTechniques.openQuestions}</div>
                                            </div>
                                            <div className="p-3 bg-teal-50 rounded-lg">
                                                <div className="font-bold text-teal-700 text-sm mb-1">ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—</div>
                                                <div className="text-xs text-gray-600">{analysis.questioningTechniques.followUp}</div>
                                            </div>
                                            <div className="p-3 bg-teal-50 rounded-lg">
                                                <div className="font-bold text-teal-700 text-sm mb-1">æ·±æ˜ã‚ŠåŠ›</div>
                                                <div className="text-xs text-gray-600">{analysis.questioningTechniques.probing}</div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                {/* ç·åˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ */}
                                {analysis.overallFeedback && (
                                    <div className="mb-6 p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg border-l-4 border-indigo-500">
                                        <h4 className="font-bold text-indigo-700 mb-2">ğŸ’¡ ç·åˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h4>
                                        <div className="text-sm text-gray-700">{analysis.overallFeedback}</div>
                                    </div>
                                )}
                                
                                {/* æ¬¡å›ã®èª²é¡Œ */}
                                {analysis.challenges && analysis.challenges.length > 0 && (
                                <div>
                                    <h4 className="font-bold text-lg mb-3 text-purple-600">ğŸ¯ æ¬¡å›ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã™ã‚‹èª²é¡Œ</h4>
                                    <div className="space-y-3">
                                        {analysis.challenges.map((challenge, i) => (
                                            <div key={i} className="p-4 bg-purple-50 rounded-lg border-l-4 border-purple-500">
                                                <div className="font-bold text-purple-700 mb-1">{challenge.title}</div>
                                                <div className="text-sm text-gray-700">{challenge.approach}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                )}
                            </div>
                            
                            {/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */}
                            <div className="bg-white rounded-xl shadow-lg p-6">
                                <div className="flex gap-3">
                                    <button
                                        onClick={resetGame}
                                        className="flex-1 py-3 px-6 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors"
                                    >
                                        ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
                                    </button>
                                    <button
                                        onClick={() => {
                                            const text = `ãƒ‡ã‚¶ã‚¤ãƒ³æ€è€ƒã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ 
ãƒ©ãƒ³ã‚¯: ${calculateRank()}
ç·åˆã‚¹ã‚³ã‚¢: ${currentScore}pts
å¹³å‡: ${analysis.stats.avgScore}ç‚¹/è³ªå•
ãªãœè³ªå•: ${analysis.stats.whyQuestions}å›
ã‚ªãƒ¼ãƒ—ãƒ³è³ªå•: ${analysis.stats.openQuestions}å›`;
                                            if (navigator.share) {
                                                navigator.share({
                                                    title: 'ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ çµæœ',
                                                    text: text
                                                });
                                            } else {
                                                navigator.clipboard.writeText(text);
                                                showToast('çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
                                            }
                                        }}
                                        className="flex-1 py-3 px-6 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-medium hover:from-purple-600 hover:to-pink-600 transition-all transform hover:scale-105"
                                    >
                                        çµæœã‚’ã‚·ã‚§ã‚¢
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };
            
            // ãƒšãƒ«ã‚½ãƒŠç¢ºèªç”»é¢
            const renderPersona = () => (
                <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-purple-100 to-pink-100">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl w-full fade-in">
                        <h2 className="text-2xl font-bold text-center mb-6 gradient-text">
                            ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ç›¸æ‰‹ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
                        </h2>
                        
                        {persona && (
                            <div className="space-y-6">
                                {/* åŸºæœ¬æƒ…å ±ã‚«ãƒ¼ãƒ‰ */}
                                <div className="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-6">
                                    <div className="flex items-center mb-4">
                                        <div className="w-20 h-20 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full flex items-center justify-center text-white text-3xl font-bold">
                                            {persona.name.charAt(0)}
                                        </div>
                                        <div className="ml-4">
                                            <h3 className="text-2xl font-bold text-gray-800">{persona.name}</h3>
                                            <p className="text-gray-600">{persona.age}æ­³ / {persona.gender}</p>
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="bg-white rounded-lg p-3">
                                            <div className="text-xs text-gray-500 mb-1">è·æ¥­</div>
                                            <div className="font-medium text-gray-800">{persona.job}</div>
                                        </div>
                                        <div className="bg-white rounded-lg p-3">
                                            <div className="text-xs text-gray-500 mb-1">å±…ä½åœ°</div>
                                            <div className="font-medium text-gray-800">{persona.location}</div>
                                        </div>
                                        <div className="bg-white rounded-lg p-3">
                                            <div className="text-xs text-gray-500 mb-1">å®¶æ—æ§‹æˆ</div>
                                            <div className="font-medium text-gray-800">{persona.family}</div>
                                        </div>
                                        <div className="bg-white rounded-lg p-3">
                                            <div className="text-xs text-gray-500 mb-1">è¶£å‘³</div>
                                            <div className="font-medium text-gray-800">{persona.hobbies.join('ã€')}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ */}
                                <div className="bg-blue-50 rounded-xl p-4">
                                    <h4 className="font-bold text-blue-800 mb-2">ä»Šå›ã®ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ</h4>
                                    <p className="text-gray-700 text-lg">{persona.painPoints && persona.painPoints[0] ? persona.painPoints[0] : 'å›°ã‚Šã”ã¨'}</p>
                                </div>
                                
                                {/* èƒŒæ™¯æƒ…å ±ï¼ˆAIç”Ÿæˆã®å ´åˆï¼‰ */}
                                {(persona.background || persona.currentSituation) && (
                                    <div className="bg-green-50 rounded-xl p-4">
                                        <h4 className="font-bold text-green-800 mb-2">ğŸ“– äººç‰©èƒŒæ™¯</h4>
                                        {persona.background && (
                                            <p className="text-sm text-gray-700 mb-2">{persona.background}</p>
                                        )}
                                        {persona.currentSituation && (
                                            <p className="text-sm text-gray-700">{persona.currentSituation}</p>
                                        )}
                                        {persona.personality?.traits && persona.personality.traits.length > 0 && (
                                            <div className="mt-2 pt-2 border-t border-green-200">
                                                <span className="text-xs font-bold text-green-700">æ€§æ ¼ç‰¹æ€§: </span>
                                                <span className="text-xs text-gray-600">{persona.personality.traits.join('ã€')}</span>
                                            </div>
                                        )}
                                    </div>
                                )}
                                
                                {/* ãƒ’ãƒ³ãƒˆ */}
                                <div className="bg-yellow-50 rounded-xl p-4">
                                    <h4 className="font-bold text-yellow-800 mb-2">ğŸ’¡ ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã®ãƒ’ãƒ³ãƒˆ</h4>
                                    <ul className="text-sm text-gray-700 space-y-1">
                                        <li>â€¢ ç›¸æ‰‹ã®èƒŒæ™¯ã‚’æ„è­˜ã—ã¦è³ªå•ã—ã¾ã—ã‚‡ã†</li>
                                        <li>â€¢ {persona.age}æ­³ã®{persona.gender}ã¨ã—ã¦ã®è¦–ç‚¹ã‚’è€ƒæ…®ã—ã¾ã—ã‚‡ã†</li>
                                        <li>â€¢ {persona.job}ã¨ã„ã†è·æ¥­ç‰¹æœ‰ã®èª²é¡ŒãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“</li>
                                        <li>â€¢ ã€Œãªãœã€ã‚’æ·±æ˜ã‚Šã—ã¦æœ¬è³ªçš„ãªãƒ‹ãƒ¼ã‚ºã‚’æ¢ã‚Šã¾ã—ã‚‡ã†</li>
                                    </ul>
                                    
                                    {persona.painPoints && persona.painPoints.length > 0 && (
                                        <div className="mt-3 pt-3 border-t border-yellow-200">
                                            <div className="text-xs font-bold text-yellow-700 mb-1">
                                                ğŸ¯ ã“ã®ãƒ†ãƒ¼ãƒã§æƒ³å®šã•ã‚Œã‚‹èª²é¡Œ
                                            </div>
                                            <div className="text-xs text-gray-600">
                                                {persona.painPoints.join('ã€')}
                                            </div>
                                        </div>
                                    )}
                                    
                                    {persona.hiddenNeeds && persona.hiddenNeeds.length > 0 && (
                                        <div className="mt-2">
                                            <div className="text-xs font-bold text-yellow-700 mb-1">
                                                ğŸ” ç™ºè¦‹ã™ã¹ãæ½œåœ¨ãƒ‹ãƒ¼ã‚º
                                            </div>
                                            <div className="text-xs text-gray-600">
                                                æ·±ã„è³ªå•ã§è¦‹ã¤ã‘ã¦ã¿ã¾ã—ã‚‡ã†ï¼ˆãƒ’ãƒ³ãƒˆ: {persona.hiddenNeeds.length}å€‹ï¼‰
                                            </div>
                                        </div>
                                    )}
                                </div>
                                
                                {/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */}
                                <div className="flex gap-3">
                                    <button
                                        onClick={async () => {
                                            const finalPainPoint = customPainPoint || selectedPainPoint || 
                                                (persona.painPoints && persona.painPoints[0] ? persona.painPoints[0] : 'å›°ã‚Šã”ã¨');
                                            setIsGeneratingPersona(true);
                                            try {
                                                const aiPersona = await generatePersonaWithAI(finalPainPoint);
                                                if (aiPersona) {
                                                    setPersona(aiPersona);
                                                } else {
                                                    setPersona(generatePersona(finalPainPoint));
                                                }
                                            } finally {
                                                setIsGeneratingPersona(false);
                                            }
                                        }}
                                        disabled={isGeneratingPersona}
                                        className={`flex-1 py-3 px-6 ${
                                            !isGeneratingPersona
                                                ? 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                        } rounded-lg font-medium transition-colors`}
                                    >
                                        {isGeneratingPersona ? 'ç”Ÿæˆä¸­...' : 'åˆ¥ã®äººã‚’é¸ã¶'}
                                    </button>
                                    <button
                                        onClick={startInterview}
                                        disabled={isGeneratingPersona}
                                        className={`flex-1 py-3 px-6 ${
                                            !isGeneratingPersona
                                                ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white hover:from-purple-600 hover:to-pink-600 transform hover:scale-105'
                                                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                        } rounded-lg font-medium transition-all`}
                                    >
                                        ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚’é–‹å§‹
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
            
            return (
                <div className={`min-h-screen bg-gradient-to-br ${getMoodColor()} transition-all duration-1000`}>
                    {/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */}
                    {isGeneratingPersona && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg p-8 flex flex-col items-center">
                                <div className="animate-spin rounded-full h-12 w-12 border-4 border-purple-500 border-t-transparent mb-4"></div>
                                <div className="text-lg font-semibold text-gray-800">ãƒšãƒ«ã‚½ãƒŠã‚’ç”Ÿæˆä¸­...</div>
                                <div className="text-sm text-gray-600 mt-2">å°‘ã—ãŠå¾…ã¡ãã ã•ã„</div>
                            </div>
                        </div>
                    )}
                    
                    {gameState === 'menu' && renderMenu()}
                    {gameState === 'persona' && renderPersona()}
                    {gameState === 'playing' && renderGame()}
                    {gameState === 'result' && renderResult()}
                    
                    {/* ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */}
                    {showParticles && (
                        <div className="fixed inset-0 pointer-events-none">
                            {[...Array(20)].map((_, i) => (
                                <div
                                    key={i}
                                    className="particle"
                                    style={{
                                        left: `${Math.random() * 100}%`,
                                        top: `${Math.random() * 100}%`,
                                        '--x': `${(Math.random() - 0.5) * 200}px`,
                                        '--y': `${(Math.random() - 0.5) * 200}px`,
                                        animationDelay: `${Math.random() * 0.5}s`
                                    }}
                                >
                                    â­
                                </div>
                            ))}
                        </div>
                    )}
                    
                    {/* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */}
                    <div className="fixed bottom-4 right-4 space-y-2 z-50">
                        {toasts.map(toast => (
                            <div
                                key={toast.id}
                                className={`toast ${
                                    toast.type === 'success' ? 'bg-green-500' :
                                    toast.type === 'warning' ? 'bg-yellow-500' :
                                    toast.type === 'error' ? 'bg-red-500' :
                                    'bg-gray-700'
                                } text-white px-4 py-2 rounded-lg shadow-lg`}
                            >
                                {toast.message}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };
        
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<InterviewGame />);
    </script>
</body>
</html>
