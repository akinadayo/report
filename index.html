<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>çˆ†é€Ÿã‚¹ã‚¯ãƒ¼ãƒ—ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ | AIãŒæš´ãè¡æ’ƒã®çœŸå®Ÿ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Sawarabi+Mincho:wght@700&display=swap" rel="stylesheet">
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
:root{
  --bg: #0a0a0a;
  --fg: #ffffff;
  --accent: #ff0066;
  --accent-2: #00ffcc;
  --surface: #1a1a1a;
  --card: #ffffff;
  --shadow: 0 12px 32px rgba(255,0,102,.3);
  --radius: 16px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family: 'Noto Sans JP', "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;}

.app{display:flex;flex-direction:column;height:100vh}

.welcome-screen{position:fixed;inset:0;background:linear-gradient(135deg, #ff0066, #00ffcc);z-index:1000;display:flex;align-items:center;justify-content:center;}
.welcome-content{text-align:center;color:white;animation: pulse 2s ease infinite;padding: 20px;}
.welcome-content h1{font-size:clamp(32px, 8vw, 48px);margin-bottom:32px;text-shadow: 0 4px 12px rgba(0,0,0,.3);}
.name-input{padding:16px 24px;font-size:20px;border:none;border-radius:8px;margin-bottom:16px;width:clamp(250px, 80vw, 300px);}
.start-btn{padding:16px 40px;font-size:20px;border:none;border-radius:8px;background:white;color:#ff0066;font-weight:bold;cursor:pointer;transition:transform 0.2s;}
.start-btn:hover{transform:scale(1.05);}
@keyframes pulse{0%,100%{transform:scale(1)} 50%{transform:scale(1.02)}}

header{padding:16px 24px;border-bottom:2px solid var(--accent);background:var(--surface);display:flex;align-items:center;gap:16px;box-shadow: 0 4px 12px rgba(255,0,102,.2);}
.logo{width:48px;height:48px;border-radius:8px;background: conic-gradient(from 45deg, var(--accent), var(--accent-2), var(--accent));animation: spin 20s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.titles h1{font-size:clamp(18px, 4vw, 24px);margin:0;font-weight:900;letter-spacing:.08em;background:linear-gradient(90deg, var(--accent), var(--accent-2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.titles p{font-size:14px;margin:4px 0 0;color:#aaa}

.container{display:flex;flex-direction:column;flex:1;min-height:0}
.chat{flex:1;overflow-y:auto;padding:12px;background: radial-gradient(800px 800px at 20% 20%, rgba(255,0,102,.1), transparent), radial-gradient(800px 800px at 80% 80%, rgba(0,255,204,.1), transparent), var(--bg);}
.row{display:flex;gap:12px;margin:16px 0;align-items:flex-start}
.bubble{max-width:min(800px, 85%);padding:12px 16px;border-radius:16px;line-height:1.8;box-shadow: var(--shadow);animation: slideIn 0.5s ease;}
@keyframes slideIn{from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)}}
.ai .avatar,.user .avatar{flex:0 0 40px;height:40px;border-radius:50%;display:grid;place-items:center;font-weight:900;font-size:14px;}
.ai .avatar{background:linear-gradient(135deg, var(--accent), var(--accent-2));box-shadow: 0 0 20px rgba(255,0,102,.5);}
.user .avatar{background:linear-gradient(135deg, #7c3aed, #06b6d4);color:white;}
.ai .bubble{background:var(--surface);border:2px solid rgba(255,0,102,.3);}
.user .bubble{background:linear-gradient(135deg, #7c3aed, #06b6d4);color:white;border:none;}
.meta{font-size:12px;color:#888;margin-bottom:8px;letter-spacing:.1em;text-transform:uppercase;}

/* å…¥åŠ›ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« - v2 */
.input-bar{border-top:2px solid var(--accent);background:var(--surface);padding:20px;}
.input-bar .status-container { margin-bottom:12px; text-align:center; }
.input-bar .form{display:flex;gap:12px;align-items:center;}
.input-bar .form input[type=text]{flex:1;padding:18px 24px;border-radius:12px;background:#0a0a0a;color:var(--fg);border:2px solid #333;outline:none;font-size:18px;transition:border-color 0.3s;height:60px;width:100%;box-sizing:border-box;}
.input-bar .form input[type=text]:focus{border-color:var(--accent);box-shadow:0 0 0 4px rgba(255,0,102,.2);}
.input-bar .form button{padding:18px 36px;border-radius:12px;border:none;font-weight:900;font-size:18px;cursor:pointer;background:linear-gradient(135deg, var(--accent), var(--accent-2));color:white;transition:transform 0.2s;box-shadow: 0 8px 20px rgba(255,0,102,.3);height:60px;white-space:nowrap;flex-shrink:0;}
.form button:active{transform:translateY(2px)}

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã¯ä¸Šã§å®šç¾© */
.status{color:#888;font-size:14px;}
.progress-bar-container{width: 100%; height: 4px; background-color: #333; border-radius: 2px; overflow: hidden;}
.progress-bar{width: 100%; height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); transition: width 0.5s ease; animation: indeterminate-progress 2s infinite ease-in-out;}
@keyframes indeterminate-progress { 0% { transform: translateX(-100%) scaleX(0.5); } 50% { transform: translateX(0) scaleX(0.5); } 100% { transform: translateX(100%) scaleX(0.5); } }

.toast{position:fixed;right:24px;bottom:24px;background:var(--accent);color:white;padding:16px 24px;border-radius:12px;box-shadow: var(--shadow);font-weight:700;max-width:min(80vw,480px);animation: toastSlide 0.5s ease;z-index: 4000;}
@keyframes toastSlide{from{transform:translateX(400px)} to{transform:translateX(0)}}
.hidden{display:none}

/* Styles for the temporary container used for image generation */
.image-render-container {
    font-family: 'Sawarabi Mincho', serif;
    position: absolute;
    left: -9999px;
    top: -9999px;
    width: 1120px; /* A4-like wider layout */
    padding: 60px;   /* Adjusted padding */
    background: #ffffff !important;
    color: #000000 !important;
}
.image-render-container h1 {
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 48px;   /* Increased font size */
    font-weight: 900;
    color: #000000 !important;
    text-align: center;
    margin-bottom: 40px; /* Adjusted margin */
}
.image-render-container h2 {
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 32px;   /* Increased font size */
    font-weight: 700;
    color: #1a1a1a !important;
    border-bottom: 2px solid #333;
    padding-bottom: 12px; /* Adjusted padding */
    margin-top: 40px;     /* Adjusted margin */
    margin-bottom: 24px;
}
.image-render-container p {
    font-size: 20px;   /* Increased font size */
    line-height: 1.7;  /* Adjusted line height */
    color: #1a1a1a !important;
    font-weight: 400;
    margin-bottom: 20px; /* Adjusted margin */
}

/* Styles for the image preview overlay */
.overlay-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 3000;
    padding: 20px;
    backdrop-filter: blur(5px);
}

.overlay-content {
    position: relative;
    background: #fff;
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.4);
    max-width: 90vw;
    max-height: 90vh;
    overflow: auto;
    text-align: center;
}

.close-btn {
    position: absolute;
    top: 15px;
    right: 25px;
    font-size: 40px;
    color: #555;
    cursor: pointer;
    transition: transform 0.2s;
}
.close-btn:hover {
    transform: scale(1.1);
    color: #000;
}

#generated-image-preview {
    max-width: 100%;
    max-height: calc(90vh - 120px);
    border: 1px solid #ddd;
    border-radius: 8px;
}

.download-btn {
    display: inline-block;
    margin-top: 20px;
    padding: 14px 28px;
    background: var(--accent);
    color: white;
    text-decoration: none;
    font-weight: bold;
    border-radius: 12px;
    transition: all 0.3s;
    font-size: 18px;
}
.download-btn:hover {
    background: var(--accent-2);
    color: #000;
    transform: scale(1.05);
}

.mobile-save-hint {
    display: none; /* Hidden by default */
    margin-top: 15px;
    color: #888;
    font-size: 16px;
}

.post-generation-controls {
    padding: 40px 20px;
    text-align: center;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    display: none; /* åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤º */
}

.control-btn {
    padding: 16px 32px;
    border-radius: 12px;
    border: none;
    font-weight: 900;
    font-size: 18px;
    cursor: pointer;
    background: var(--surface);
    color: var(--fg);
    transition: all 0.3s;
    margin: 10px;
    border: 2px solid var(--accent-2);
    min-width: 280px;
}

.control-btn.accent {
    background: var(--accent);
    color: white;
    border: 2px solid var(--accent);
}

.control-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
}

@media (max-width: 768px) {
    .titles p { display: none; }
    .bubble { padding: 10px 14px; }
    .form { flex-direction: column; align-items: stretch; max-width: 100%; }
    .form input[type=text] { min-height: 48px; padding: 14px 18px; font-size: 16px; }
    .form button { min-height: 48px; padding: 14px 24px; font-size: 16px; }
    .status-container { margin: 8px 0; max-width: 100%; }
    .download-btn { display: none; } /* Hide download button on mobile */
    .mobile-save-hint { display: block; } /* Show hint on mobile */
}

</style>
</head>
<body>
<div class="welcome-screen" id="welcome">
  <div class="welcome-content">
    <h1>ğŸš¨ çˆ†é€Ÿã‚¹ã‚¯ãƒ¼ãƒ—ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ ğŸš¨</h1>
    <p style="color: white; font-size: 18px; margin-bottom: 24px;">
      ç„¡æ–™ãƒ¢ãƒ‡ãƒ«: <strong>DeepSeek Chat V3.1</strong> ã‚’ä½¿ç”¨
    </p>
    <input type="text" id="userName" class="name-input" placeholder="ã‚ãªãŸã®åå‰ã‚’å…¥åŠ›">
    <br>
    <input type="password" id="apiKey" class="name-input" placeholder="OpenRouterã®APIã‚­ãƒ¼ã‚’å…¥åŠ›" style="margin-bottom: 8px;">
    <p style="color: rgba(255,255,255,0.8); font-size: 14px; margin: 8px 0 16px;">
      <a href="https://openrouter.ai/keys" target="_blank" style="color: white; text-decoration: underline;">APIã‚­ãƒ¼ã®å–å¾—ã¯ã“ã¡ã‚‰</a>
    </p>
    <button class="start-btn" onclick="startApp()">ã‚¹ã‚¯ãƒ¼ãƒ—ã‚’å§‹ã‚ã‚‹ï¼</button>
  </div>
</div>

<div class="app" style="display:none;">
  <header>
    <div class="logo" aria-hidden="true"></div>
    <div class="titles">
      <h1>çˆ†é€Ÿã‚¹ã‚¯ãƒ¼ãƒ—ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
      <p>DeepSeek Chat V3.1 (ç„¡æ–™) ã§å‹•ä½œä¸­</p>
    </div>
  </header>
  
  <div class="container">
    <main id="chat" class="chat" aria-live="polite"></main>
    <section id="input-bar" class="input-bar" style="padding: 20px 40px;">
      <div style="width: 100%; max-width: 1600px; margin: 0 auto;">
          <div class="status-container" style="margin-bottom: 12px; text-align: center;">
              <div id="progress-bar-container" class="progress-bar-container hidden">
                  <div class="progress-bar"></div>
              </div>
              <span id="status" class="status">å¾…æ©Ÿä¸­</span>
          </div>
          <div class="form" style="display: flex; gap: 16px; align-items: center; width: 100%;">
            <input id="text" type="text" placeholder="ä»Šæ—¥ã®å‡ºæ¥äº‹ã‚’æ•™ãˆã¦ãã ã•ã„â€¦" autocomplete="off" style="flex: 1; padding: 20px 30px; font-size: 20px; height: 65px; border-radius: 12px; background: #0a0a0a; color: white; border: 2px solid #333; min-width: 0;" />
            <button id="send" aria-label="é€ä¿¡" style="padding: 20px 45px; font-size: 20px; height: 65px; border-radius: 12px; background: linear-gradient(135deg, #ff0066, #00ffcc); color: white; border: none; font-weight: 900; cursor: pointer; flex-shrink: 0;">é€ä¿¡</button>
          </div>
      </div>
    </section>
    <div id="post-generation-controls" class="post-generation-controls hidden">
        <button id="reopen-btn" class="control-btn">æœ€æ–°ã®è¨˜äº‹ã‚’ã‚‚ã†ä¸€åº¦è¡¨ç¤º</button>
        <button id="start-over-btn" class="control-btn accent">æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
    </div>
  </div>
</div>

<div id="toast" class="toast hidden"></div>

<div id="image-overlay" class="overlay-container" style="display: none;">
  <div class="overlay-content">
    <span class="close-btn" id="close-overlay">&times;</span>
    <img id="generated-image-preview" src="" alt="ç”Ÿæˆã•ã‚ŒãŸè¨˜äº‹ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
    <br>
    <a id="download-image-btn" class="download-btn" href="#" download="scoop.png">ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
    <p class="mobile-save-hint">ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ä¿å­˜</p>
  </div>
</div>

<script type="module">
// OpenRouter APIã®è¨­å®š
const MODEL = "deepseek/deepseek-chat-v3.1:free"; // ç„¡æ–™ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨
let USER_API_KEY = "";

const chatEl = document.getElementById('chat');
const inputEl = document.getElementById('text');
const sendBtn = document.getElementById('send');
const statusEl = document.getElementById('status');
const toastEl = document.getElementById('toast');
const appEl = document.querySelector('.app');
const progressBarContainer = document.getElementById('progress-bar-container');
const imageOverlay = document.getElementById('image-overlay');
const closeOverlayBtn = document.getElementById('close-overlay');
const imagePreview = document.getElementById('generated-image-preview');
const downloadImageBtn = document.getElementById('download-image-btn');
const inputBar = document.getElementById('input-bar');
const postGenerationControls = document.getElementById('post-generation-controls');
const reopenBtn = document.getElementById('reopen-btn');
const startOverBtn = document.getElementById('start-over-btn');

let depth = 0;
let locked = false;
let userName = "";
const MAX_DEPTH = 5;
let lastGeneratedImageDataUrl = null;

const conversation = [
  {
    role: "system",
    content: `ã‚ãªãŸã¯é€±åˆŠèªŒã®AIè¨˜è€…ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è©±ã‚’é¢ç™½ãŠã‹ã—ãè†¨ã‚‰ã¾ã›ã¦å–æã—ã¾ã™ã€‚

é‡è¦ãªãƒ«ãƒ¼ãƒ«ï¼š
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¿”ç­”ã‚’ã—ã£ã‹ã‚Šç†è§£ã—ã¦ã€ãã®å†…å®¹ã«åŸºã¥ã„ãŸè³ªå•ã‚’ã™ã‚‹
2. å‰ã®ä¼šè©±ã®æ–‡è„ˆã‚’è¸ã¾ãˆã¦è‡ªç„¶ã«ä¼šè©±ã‚’ç¶šã‘ã‚‹
3. è©±ã®çŸ›ç›¾ã‚„å‹˜é•ã„ã‚’ã—ãªã„
4. è³ªå•ã¯1ã¤ã ã‘ã€çŸ­ãçš„ç¢ºã«
5. å¤§ã’ã•ã§é¢ç™½ã„ãŒã€è©±ã®æµã‚Œã¯å®ˆã‚‹
6. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨€ã£ã¦ãªã„ã“ã¨ã‚’å‹æ‰‹ã«ä»˜ã‘åŠ ãˆãªã„`
  }
];

window.startApp = function() {
  const nameInput = document.getElementById('userName');
  const apiKeyInput = document.getElementById('apiKey');
  userName = nameInput.value.trim();
  USER_API_KEY = apiKeyInput.value.trim();
  
  if (!userName) {
    alert("ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
    return;
  }
  
  if (!USER_API_KEY) {
    alert("OpenRouterã®APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
    return;
  }
  
  // APIã‚­ãƒ¼ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ï¼ˆæ¬¡å›ä»¥é™ã®åˆ©ä¾¿æ€§ã®ãŸã‚ï¼‰
  localStorage.setItem('openrouter_api_key', USER_API_KEY);
  
  document.getElementById('welcome').style.display = 'none';
  appEl.style.display = 'flex';
  boot();
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ä¿å­˜ã•ã‚ŒãŸAPIã‚­ãƒ¼ãŒã‚ã‚Œã°è‡ªå‹•å…¥åŠ›
window.addEventListener('DOMContentLoaded', () => {
  const savedApiKey = localStorage.getItem('openrouter_api_key');
  if (savedApiKey) {
    const apiKeyInput = document.getElementById('apiKey');
    if (apiKeyInput) {
      apiKeyInput.value = savedApiKey;
    }
  }
})

function showToast(msg, timeout=3200){
  toastEl.textContent = msg;
  toastEl.classList.remove('hidden');
  window.clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>toastEl.classList.add('hidden'), timeout);
}

function renderMessage(role, content){
  const row = document.createElement('div');
  row.className = `row ${role === 'assistant' ? 'ai' : 'user'}`;
  
  const avatar = document.createElement('div');
  avatar.className = 'avatar';
  avatar.textContent = role === 'assistant' ? 'AI' : userName.substring(0,2);
  
  const wrap = document.createElement('div');
  const meta = document.createElement('div');
  meta.className = 'meta';
  meta.textContent = role === 'assistant' ? 'AIã‚¸ãƒ£ãƒ¼ãƒŠãƒªã‚¹ãƒˆ' : userName;
  
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.textContent = content;
  
  wrap.appendChild(meta);
  wrap.appendChild(bubble);
  row.appendChild(avatar);
  row.appendChild(wrap);
  chatEl.appendChild(row);
  chatEl.scrollTop = chatEl.scrollHeight;
}

async function generateAndShowImage(headline, body) {
    setStatus("ç”»åƒã‚’ç”Ÿæˆä¸­â€¦", true);

    const renderContainer = document.createElement('div');
    renderContainer.className = 'image-render-container';

    const h1 = document.createElement('h1');
    h1.textContent = headline;
    renderContainer.appendChild(h1);

    body.split('\n\n').forEach(paragraph => {
        if (paragraph.startsWith('**') && paragraph.endsWith('**')) {
            const h2 = document.createElement('h2');
            h2.textContent = paragraph.slice(2, -2);
            renderContainer.appendChild(h2);
        } else {
            const p = document.createElement('p');
            p.textContent = paragraph;
            renderContainer.appendChild(p);
        }
    });

    document.body.appendChild(renderContainer);

    try {
        const canvas = await html2canvas(renderContainer, { 
            scale: 1.5, 
            useCORS: true,
            backgroundColor: '#ffffff',
            width: renderContainer.scrollWidth,
            height: renderContainer.scrollHeight
        });
        
        lastGeneratedImageDataUrl = canvas.toDataURL('image/png');
        
        imagePreview.src = lastGeneratedImageDataUrl;
        downloadImageBtn.href = lastGeneratedImageDataUrl;
        downloadImageBtn.download = `${userName}_scoop.png`;
        
        imageOverlay.style.display = 'flex';

        showToast("ç”»åƒã®ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼");

    } catch (err) {
        console.error("Image generation error:", err);
        showToast("ç”»åƒã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    } finally {
        document.body.removeChild(renderContainer);
        setStatus("å®Œäº† ğŸ“°");
    }
}

function setStatus(msg, showProgress = false) {
    statusEl.textContent = msg;
    progressBarContainer.classList.toggle('hidden', !showProgress);
}

async function callOpenRouter(messages, retryCount = 0){
  locked = true;
  const body = {
    model: MODEL,
    temperature: 0.9,
    max_tokens: 2500,
    messages
  };
  
  try {
    // OpenRouter APIã‚’ç›´æ¥å‘¼ã³å‡ºã—ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®APIã‚­ãƒ¼ã‚’ä½¿ç”¨ï¼‰
    const apiUrl = 'https://openrouter.ai/api/v1/chat/completions';
    
    console.log('Using model:', MODEL);
    
    const headers = {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${USER_API_KEY}`,
      "HTTP-Referer": window.location.href,
      "X-Title": "Scoop Generator"
    };
    
    const resp = await fetch(apiUrl, {
      method: "POST",
      headers,
      body: JSON.stringify(body)
    });
    
    if(!resp.ok) {
      const errorData = await resp.text();
      console.error('API Error:', resp.status, errorData);
      if (resp.status === 401) {
        throw new Error("APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚æ­£ã—ã„ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      }
      throw new Error("API error: " + resp.status);
    }
    
    const data = await resp.json();
    return data?.choices?.[0]?.message?.content ?? "";
  } catch(e) {
      console.error(e);
      if (e.message.includes('APIã‚­ãƒ¼ãŒç„¡åŠ¹')) {
          showToast(e.message);
          throw e;
      }
      if (retryCount < 1) {
          setStatus(`ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿã€‚3ç§’å¾Œã«å†è©¦è¡Œã—ã¾ã™â€¦`, true);
          await new Promise(resolve => setTimeout(resolve, 3000));
          return callOpenRouter(messages, retryCount + 1);
      } else {
          showToast("é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
          throw e;
      }
  }
}

async function askNext(){
  setStatus("å–æä¸­â€¦ğŸ¤", true);
  try{
    // ä¼šè©±å±¥æ­´å…¨ä½“ã‚’é€ã£ã¦æ–‡è„ˆã‚’ç†è§£ã•ã›ã‚‹
    const contextMessages = [
      conversation[0], // ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
      ...conversation.slice(1).map(msg => ({
        role: msg.role,
        content: msg.content
      }))
    ];
    
    const reply = await callOpenRouter(contextMessages);
    conversation.push({ role:"assistant", content: reply });
    renderMessage("assistant", reply);
  }catch(e){
    console.error(e);
  } finally {
    setStatus("å¾…æ©Ÿä¸­");
    locked = false;
  }
}

async function generateArticle(){
  setStatus("ğŸš¨ ç·Šæ€¥é€Ÿå ±ä½œæˆä¸­ ğŸš¨", true);
  const sys = {
    role: "system",
    content: `ã‚ãªãŸã¯é€±åˆŠèªŒã®è¨˜äº‹åŸ·ç­†è€…ã§ã™ã€‚ã“ã‚Œã‹ã‚‰æ¸¡ã™å–æå†…å®¹ã‚’å…ƒã«ã€å®Œæˆã—ãŸè¨˜äº‹ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚

ã€è¶…é‡è¦ã€‘ã“ã‚Œã¯è¨˜äº‹åŸ·ç­†ã®æ®µéšã§ã™ã€‚ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã¯çµ‚äº†ã—ã¦ã„ã¾ã™ã€‚
- å–æå†…å®¹ã®å¼•ç”¨ã‚„ã€ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã®å†ç¾ã¯çµ¶å¯¾ã«ã—ãªã„ã§ãã ã•ã„
- ã€Œâ—‹â—‹ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€ã®ã‚ˆã†ãªè³ªå•æ–‡ã¯çµ¶å¯¾ã«æ›¸ã‹ãªã„ã§ãã ã•ã„
- ã‚ãªãŸã¯è¨˜è€…ã¨ã—ã¦ã€${userName}ã•ã‚“ã®æ—¥å¸¸ã‚’çˆ†ç¬‘ã‚¹ã‚¯ãƒ¼ãƒ—è¨˜äº‹ã¨ã—ã¦åŸ·ç­†ã™ã‚‹ã ã‘ã§ã™

åŸ·ç­†ã‚¹ã‚¿ã‚¤ãƒ«ï¼š
- è™šæ§‹æ–°èã‚„ãƒœãƒ¼ãƒœãƒœé¢¨ã®å¤§ã’ã•ã§é¦¬é¹¿é¦¬é¹¿ã—ã„æ–‡ä½“
- ã©ã‚“ãªäº›ç´°ãªã“ã¨ã‚‚å›½å®¶ãƒ¬ãƒ™ãƒ«ã®å¤§äº‹ä»¶ã¨ã—ã¦æ‰±ã†
- çœŸé¢ç›®ãªå£èª¿ã§é¦¬é¹¿ã’ãŸã“ã¨ã‚’æ›¸ãï¼ˆã‚·ãƒªã‚¢ã‚¹ãªç¬‘ã„ï¼‰
- ã€Œå®šé£Ÿå±‹ãŒæ··ã‚“ã§ãŸã€â†’ã€Œå‰ä»£æœªèã®é£²é£Ÿåº—åŒ…å›²ç¶²ã€ã¿ãŸã„ãªå¤§ä»°ãªè¡¨ç¾
- å®Ÿéš›ã®å‡ºæ¥äº‹ã¯å®ˆã‚Šã¤ã¤ã€è§£é‡ˆã¨è¡¨ç¾ã‚’æ¥µé™ã¾ã§èª‡å¼µ

ç¬‘ã„ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ï¼š
- å¤§ã’ã•ãªæ¯”å–©ï¼ˆã€Œã¾ã‚‹ã§â—‹â—‹ã®ã‚ˆã†ãªã€ã‚’å¤šç”¨ï¼‰
- é–¢ä¿‚è€…ã®è¨¼è¨€ã‚’æé€ ï¼ˆã€Œè¿‘æ‰€ã®çŒ«ã‚‚é©šãã‚’éš ã›ãªã„æ§˜å­ã€ç­‰ï¼‰
- å°‚é–€å®¶ã®åˆ†æã‚’å‰µä½œï¼ˆã€Œâ—‹â—‹è©•è«–å®¶ã«ã‚ˆã‚‹ã¨æ­´å²çš„ç¬é–“ã€ç­‰ï¼‰
- æ•°å­—ã‚„çµ±è¨ˆã‚’é©å½“ã«ä½œã‚‹ï¼ˆã€Œå®Ÿã«97.3%ã®ç¢ºç‡ã§ã€ç­‰ï¼‰
- æ·±èª­ã¿ã—ã™ãã‚‹è€ƒå¯Ÿï¼ˆã€Œã“ã‚ŒãŒæ„å‘³ã™ã‚‹ã‚‚ã®ã¯...ã€ï¼‰
- æ€¥ã«å“²å­¦çš„ã«ãªã‚‹
- æœ€å¾Œã¯å¿…ãšå£®å¤§ãªã‚ªãƒã§ç· ã‚ã‚‹

è¦ä»¶ï¼š
- è¦‹å‡ºã—ã¯ã€Œã€é€Ÿå ±ã€‘${userName}æ°ã€â—‹â—‹ã§ä¸–ç•Œã‚’éœ‡æ’¼ã•ã›ã‚‹ã€ã¿ãŸã„ãªå½¢å¼
- æœ¬æ–‡750ã€œ1200å­—ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã«**ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«**å¿…é ˆ
- ã¨ã«ã‹ãèª­è€…ãŒå¹ãå‡ºã™ã‚ˆã†ãªé¦¬é¹¿ã’ãŸå†…å®¹ã«
- ã§ã‚‚å–æã§èã„ãŸåŸºæœ¬çš„äº‹å®Ÿï¼ˆå ´æ‰€ãƒ»ç‰©ãƒ»äººï¼‰ã¯æ­£ç¢ºã«

è¨˜äº‹ã®å‡ºåŠ›å½¢å¼ï¼ˆå¿…ãšã“ã®å½¢å¼ã§è¨˜äº‹ã‚’æ›¸ã„ã¦ãã ã•ã„ï¼‰ï¼š
ã€é€Ÿå ±ã€‘â—‹â—‹ï¼ˆè¡æ’ƒçš„ãªè¦‹å‡ºã—ï¼‰

**ç¬¬ä¸€ç« ï¼šâ—‹â—‹ï¼ˆã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ï¼‰**

ï¼ˆè¨˜äº‹æœ¬æ–‡ãƒ‘ãƒ©ã‚°ãƒ©ãƒ•ï¼‰

**ç¬¬äºŒç« ï¼šâ—‹â—‹ï¼ˆã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ï¼‰**

ï¼ˆè¨˜äº‹æœ¬æ–‡ãƒ‘ãƒ©ã‚°ãƒ©ãƒ•ï¼‰

**ç¬¬ä¸‰ç« ï¼šâ—‹â—‹ï¼ˆã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ï¼‰**

ï¼ˆè¨˜äº‹æœ¬æ–‡ãƒ‘ãƒ©ã‚°ãƒ©ãƒ•ï¼‰

æ³¨æ„ï¼šã“ã‚Œã¯å®Œæˆã—ãŸè¨˜äº‹ã§ã™ã€‚å–æå†…å®¹ã‚„è³ªå•ã‚’æ›¸ãã®ã§ã¯ãªãã€ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã¨ã—ã¦æ›¸ã„ã¦ãã ã•ã„ã€‚`
  };
  
  try{
    // è¨˜äº‹ç”Ÿæˆç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ§‹ç¯‰
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›ç­”ã®ã¿ã‚’æŠ½å‡ºã—ã¦è¨˜äº‹ç”Ÿæˆã«ä½¿ç”¨
    const userResponses = conversation
      .filter(msg => msg.role === "user")
      .map(msg => msg.content)
      .join("\n\n");
    
    const articleMessages = [
      sys,
      {
        role: "user",
        content: `å–æãƒ¡ãƒ¢ï¼š${userName}ã•ã‚“ã¸ã®ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼å†…å®¹\n\n${userResponses}\n\nä¸Šè¨˜ã®å–æãƒ¡ãƒ¢ã‚’å…ƒã«ã€å®Œæˆã—ãŸãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã‚’åŸ·ç­†ã—ã¦ãã ã•ã„ã€‚\nã€é‡è¦ã€‘ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼å†…å®¹ã®å†ç¾ã§ã¯ãªãã€ãƒ—ãƒ­ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒªã‚¹ãƒˆãŒæ›¸ã„ãŸå®Œæˆè¨˜äº‹ã¨ã—ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚`
      }
    ];
    
    const reply = await callOpenRouter(articleMessages);
    const lines = reply.split('\n\n');
    const headline = lines.shift() || "è¡æ’ƒã®ã‚¹ã‚¯ãƒ¼ãƒ—ï¼";
    const body = lines.join('\n\n');
    
    await generateAndShowImage(headline, body);

  }catch(e){
    showToast("ã‚¹ã‚¯ãƒ¼ãƒ—ä½œæˆå¤±æ•—ï¼ã‚‚ã†ä¸€åº¦ï¼");
  }finally{
    setStatus("å®Œäº† ğŸ“°");
    locked = false;
  }
}

function handleSend(){
  if(locked) return;
  const text = inputEl.value.trim();
  if(!text) return;
  
  inputEl.value = "";
  
  renderMessage("user", text);
  conversation.push({ role:"user", content: text });
  
  locked = true;
  if(depth < MAX_DEPTH){
    depth++;
    askNext();
  }else{
    generateArticle();
  }
}

sendBtn.addEventListener('click', handleSend);
inputEl.addEventListener('keydown', (e)=> {
  if(e.key === 'Enter' && !e.isComposing) {
      e.preventDefault();
      handleSend();
  }
});

closeOverlayBtn.addEventListener('click', () => {
    imageOverlay.style.display = 'none';
    inputBar.style.display = 'none';
    chatEl.innerHTML = '';
    postGenerationControls.style.display = 'flex';
});

reopenBtn.addEventListener('click', () => {
    if (lastGeneratedImageDataUrl) {
        imageOverlay.style.display = 'flex';
    }
});

startOverBtn.addEventListener('click', () => {
    window.location.reload();
});

function boot(){
  // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ï¼ˆã¾ãŸã¯ãƒªã‚»ãƒƒãƒˆæ™‚ï¼‰ã¯ã€å…¥åŠ›ãƒãƒ¼ã‚’è¡¨ç¤ºã—ã€è¨˜äº‹å¾Œã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’éè¡¨ç¤ºã«ã™ã‚‹
  inputBar.style.display = 'flex';
    postGenerationControls.style.display = 'none';

  const greeting = `ã“ã‚“ã«ã¡ã¯${userName}ã•ã‚“ï¼ç§ã¯é€±åˆŠèªŒã®AIè¨˜è€…ã§ã™ã€‚ä»Šæ—¥ã‚ã£ãŸå‡ºæ¥äº‹ã§ã€ä¸€ç•ªå°è±¡çš„ã ã£ãŸã“ã¨ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚ã©ã‚“ãªäº›ç´°ãªã“ã¨ã§ã‚‚å¤§ã‚¹ã‚¯ãƒ¼ãƒ—ã«ä»•ç«‹ã¦ä¸Šã’ã¾ã™ã‚ˆï¼`;
  conversation.push({ role: "assistant", content: greeting });
  renderMessage("assistant", greeting);
  setStatus("å¾…æ©Ÿä¸­");
}

</script>
</body>
</html>
