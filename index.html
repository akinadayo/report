<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ÁàÜÈÄü„Çπ„ÇØ„Éº„Éó„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº | AI„ÅåÊö¥„ÅèË°ùÊíÉ„ÅÆÁúüÂÆü</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Sawarabi+Mincho:wght@700&display=swap" rel="stylesheet">
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
:root{
  --bg: #0a0a0a;
  --fg: #ffffff;
  --accent: #ff0066;
  --accent-2: #00ffcc;
  --surface: #1a1a1a;
  --card: #ffffff;
  --shadow: 0 12px 32px rgba(255,0,102,.3);
  --radius: 16px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family: 'Noto Sans JP', "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;}

.app{display:flex;flex-direction:column;height:100vh}

.welcome-screen{position:fixed;inset:0;background:linear-gradient(135deg, #ff0066, #00ffcc);z-index:1000;display:flex;align-items:center;justify-content:center;}
.welcome-content{text-align:center;color:white;animation: pulse 2s ease infinite;padding: 20px;}
.welcome-content h1{font-size:clamp(32px, 8vw, 48px);margin-bottom:32px;text-shadow: 0 4px 12px rgba(0,0,0,.3);}
.name-input{padding:16px 24px;font-size:20px;border:none;border-radius:8px;margin-bottom:16px;width:clamp(250px, 80vw, 300px);}
.start-btn{padding:16px 40px;font-size:20px;border:none;border-radius:8px;background:white;color:#ff0066;font-weight:bold;cursor:pointer;transition:transform 0.2s;}
.start-btn:hover{transform:scale(1.05);}
@keyframes pulse{0%,100%{transform:scale(1)} 50%{transform:scale(1.02)}}

header{padding:16px 24px;border-bottom:2px solid var(--accent);background:var(--surface);display:flex;align-items:center;gap:16px;box-shadow: 0 4px 12px rgba(255,0,102,.2);}
.logo{width:48px;height:48px;border-radius:8px;background: conic-gradient(from 45deg, var(--accent), var(--accent-2), var(--accent));animation: spin 20s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.titles h1{font-size:clamp(18px, 4vw, 24px);margin:0;font-weight:900;letter-spacing:.08em;background:linear-gradient(90deg, var(--accent), var(--accent-2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.titles p{font-size:14px;margin:4px 0 0;color:#aaa}

.container{display:flex;flex-direction:column;flex:1;min-height:0}
.chat{flex:1;overflow-y:auto;padding:12px;background: radial-gradient(800px 800px at 20% 20%, rgba(255,0,102,.1), transparent), radial-gradient(800px 800px at 80% 80%, rgba(0,255,204,.1), transparent), var(--bg);}
.row{display:flex;gap:12px;margin:16px 0;align-items:flex-start}
.bubble{max-width:min(800px, 85%);padding:12px 16px;border-radius:16px;line-height:1.8;box-shadow: var(--shadow);animation: slideIn 0.5s ease;}
@keyframes slideIn{from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)}}
.ai .avatar,.user .avatar{flex:0 0 40px;height:40px;border-radius:50%;display:grid;place-items:center;font-weight:900;font-size:14px;}
.ai .avatar{background:linear-gradient(135deg, var(--accent), var(--accent-2));box-shadow: 0 0 20px rgba(255,0,102,.5);}
.user .avatar{background:linear-gradient(135deg, #7c3aed, #06b6d4);color:white;}
.ai .bubble{background:var(--surface);border:2px solid rgba(255,0,102,.3);}
.user .bubble{background:linear-gradient(135deg, #7c3aed, #06b6d4);color:white;border:none;}
.meta{font-size:12px;color:#888;margin-bottom:8px;letter-spacing:.1em;text-transform:uppercase;}

/* ÂÖ•Âäõ„Ç®„É™„Ç¢„ÅÆ„Çπ„Çø„Ç§„É´ - v2 */
.input-bar{border-top:2px solid var(--accent);background:var(--surface);padding:20px;}
.input-bar .status-container { margin-bottom:12px; text-align:center; }
.input-bar .form{display:flex;gap:12px;align-items:center;}
.input-bar .form input[type=text]{flex:1;padding:18px 24px;border-radius:12px;background:#0a0a0a;color:var(--fg);border:2px solid #333;outline:none;font-size:18px;transition:border-color 0.3s;height:60px;width:100%;box-sizing:border-box;}
.input-bar .form input[type=text]:focus{border-color:var(--accent);box-shadow:0 0 0 4px rgba(255,0,102,.2);}
.input-bar .form button{padding:18px 36px;border-radius:12px;border:none;font-weight:900;font-size:18px;cursor:pointer;background:linear-gradient(135deg, var(--accent), var(--accent-2));color:white;transition:transform 0.2s;box-shadow: 0 8px 20px rgba(255,0,102,.3);height:60px;white-space:nowrap;flex-shrink:0;}
.form button:active{transform:translateY(2px)}

/* „Çπ„ÉÜ„Éº„Çø„Çπ„Ç≥„É≥„ÉÜ„Éä„ÅØ‰∏ä„ÅßÂÆöÁæ© */
.status{color:#888;font-size:14px;}
.progress-bar-container{width: 100%; height: 4px; background-color: #333; border-radius: 2px; overflow: hidden;}
.progress-bar{width: 100%; height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); transition: width 0.5s ease; animation: indeterminate-progress 2s infinite ease-in-out;}
@keyframes indeterminate-progress { 0% { transform: translateX(-100%) scaleX(0.5); } 50% { transform: translateX(0) scaleX(0.5); } 100% { transform: translateX(100%) scaleX(0.5); } }

.toast{position:fixed;right:24px;bottom:24px;background:var(--accent);color:white;padding:16px 24px;border-radius:12px;box-shadow: var(--shadow);font-weight:700;max-width:min(80vw,480px);animation: toastSlide 0.5s ease;z-index: 4000;}
@keyframes toastSlide{from{transform:translateX(400px)} to{transform:translateX(0)}}
.hidden{display:none}

/* Styles for the temporary container used for image generation */
.image-render-container {
    font-family: 'Sawarabi Mincho', serif;
    position: absolute;
    left: -9999px;
    top: -9999px;
    width: 1120px; /* A4-like wider layout */
    padding: 60px;   /* Adjusted padding */
    background: #ffffff !important;
    color: #000000 !important;
}
.image-render-container h1 {
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 48px;   /* Increased font size */
    font-weight: 900;
    color: #000000 !important;
    text-align: center;
    margin-bottom: 40px; /* Adjusted margin */
}
.image-render-container h2 {
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 32px;   /* Increased font size */
    font-weight: 700;
    color: #1a1a1a !important;
    border-bottom: 2px solid #333;
    padding-bottom: 12px; /* Adjusted padding */
    margin-top: 40px;     /* Adjusted margin */
    margin-bottom: 24px;
}
.image-render-container p {
    font-size: 20px;   /* Increased font size */
    line-height: 1.7;  /* Adjusted line height */
    color: #1a1a1a !important;
    font-weight: 400;
    margin-bottom: 20px; /* Adjusted margin */
}

/* Styles for the image preview overlay */
.overlay-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 3000;
    padding: 20px;
    backdrop-filter: blur(5px);
}

.overlay-content {
    position: relative;
    background: #fff;
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.4);
    max-width: 90vw;
    max-height: 90vh;
    overflow: auto;
    text-align: center;
}

.close-btn {
    position: absolute;
    top: 15px;
    right: 25px;
    font-size: 40px;
    color: #555;
    cursor: pointer;
    transition: transform 0.2s;
}
.close-btn:hover {
    transform: scale(1.1);
    color: #000;
}

#generated-image-preview {
    max-width: 100%;
    max-height: calc(90vh - 120px);
    border: 1px solid #ddd;
    border-radius: 8px;
}

.download-btn {
    display: inline-block;
    margin-top: 20px;
    padding: 14px 28px;
    background: var(--accent);
    color: white;
    text-decoration: none;
    font-weight: bold;
    border-radius: 12px;
    transition: all 0.3s;
    font-size: 18px;
}
.download-btn:hover {
    background: var(--accent-2);
    color: #000;
    transform: scale(1.05);
}

.mobile-save-hint {
    display: none; /* Hidden by default */
    margin-top: 15px;
    color: #888;
    font-size: 16px;
}

.post-generation-controls {
    padding: 40px 20px;
    text-align: center;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    display: none; /* ÂàùÊúüÁä∂ÊÖã„Åß„ÅØÈùûË°®Á§∫ */
}

.control-btn {
    padding: 16px 32px;
    border-radius: 12px;
    border: none;
    font-weight: 900;
    font-size: 18px;
    cursor: pointer;
    background: var(--surface);
    color: var(--fg);
    transition: all 0.3s;
    margin: 10px;
    border: 2px solid var(--accent-2);
    min-width: 280px;
}

.control-btn.accent {
    background: var(--accent);
    color: white;
    border: 2px solid var(--accent);
}

.control-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
}

@media (max-width: 768px) {
    .titles p { display: none; }
    .bubble { padding: 10px 14px; }
    .form { flex-direction: column; align-items: stretch; max-width: 100%; }
    .form input[type=text] { min-height: 48px; padding: 14px 18px; font-size: 16px; }
    .form button { min-height: 48px; padding: 14px 24px; font-size: 16px; }
    .status-container { margin: 8px 0; max-width: 100%; }
    .download-btn { display: none; } /* Hide download button on mobile */
    .mobile-save-hint { display: block; } /* Show hint on mobile */
}

</style>
</head>
<body>
<div class="welcome-screen" id="welcome">
  <div class="welcome-content">
    <h1>üö® ÁàÜÈÄü„Çπ„ÇØ„Éº„Éó„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº üö®</h1>
    <p style="color: white; font-size: 18px; margin-bottom: 24px;">
      ÁÑ°Êñô„É¢„Éá„É´: <strong>DeepSeek Chat V3.1</strong> „Çí‰ΩøÁî®
    </p>
    <input type="text" id="userName" class="name-input" placeholder="„ÅÇ„Å™„Åü„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ">
    <br>
    <input type="password" id="apiKey" class="name-input" placeholder="OpenRouter„ÅÆAPI„Ç≠„Éº„ÇíÂÖ•Âäõ" style="margin-bottom: 8px;">
    <p style="color: rgba(255,255,255,0.8); font-size: 14px; margin: 8px 0 16px;">
      <a href="https://openrouter.ai/keys" target="_blank" style="color: white; text-decoration: underline;">API„Ç≠„Éº„ÅÆÂèñÂæó„ÅØ„Åì„Å°„Çâ</a>
    </p>
    <button class="start-btn" onclick="startApp()">„Çπ„ÇØ„Éº„Éó„ÇíÂßã„ÇÅ„ÇãÔºÅ</button>
  </div>
</div>

<div class="app" style="display:none;">
  <header>
    <div class="logo" aria-hidden="true"></div>
    <div class="titles">
      <h1>ÁàÜÈÄü„Çπ„ÇØ„Éº„Éó„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº</h1>
      <p>DeepSeek Chat V3.1 (ÁÑ°Êñô) „ÅßÂãï‰Ωú‰∏≠</p>
    </div>
  </header>
  
  <div class="container">
    <main id="chat" class="chat" aria-live="polite"></main>
    <section id="input-bar" class="input-bar" style="padding: 20px 40px;">
      <div style="width: 100%; max-width: 1600px; margin: 0 auto;">
          <div class="status-container" style="margin-bottom: 12px; text-align: center;">
              <div id="progress-bar-container" class="progress-bar-container hidden">
                  <div class="progress-bar"></div>
              </div>
              <span id="status" class="status">ÂæÖÊ©ü‰∏≠</span>
          </div>
          <div class="form" style="display: flex; gap: 16px; align-items: center; width: 100%;">
            <input id="text" type="text" placeholder="‰ªäÊó•„ÅÆÂá∫Êù•‰∫ã„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ‚Ä¶" autocomplete="off" style="flex: 1; padding: 20px 30px; font-size: 20px; height: 65px; border-radius: 12px; background: #0a0a0a; color: white; border: 2px solid #333; min-width: 0;" />
            <button id="send" aria-label="ÈÄÅ‰ø°" style="padding: 20px 45px; font-size: 20px; height: 65px; border-radius: 12px; background: linear-gradient(135deg, #ff0066, #00ffcc); color: white; border: none; font-weight: 900; cursor: pointer; flex-shrink: 0;">ÈÄÅ‰ø°</button>
          </div>
      </div>
    </section>
    <div id="post-generation-controls" class="post-generation-controls hidden">
        <button id="reopen-btn" class="control-btn">ÊúÄÊñ∞„ÅÆË®ò‰∫ã„Çí„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ë°®Á§∫</button>
        <button id="start-over-btn" class="control-btn accent">ÊúÄÂàù„Åã„Çâ„ÇÑ„ÇäÁõ¥„Åô</button>
    </div>
  </div>
</div>

<div id="toast" class="toast hidden"></div>

<div id="image-overlay" class="overlay-container" style="display: none;">
  <div class="overlay-content">
    <span class="close-btn" id="close-overlay">&times;</span>
    <img id="generated-image-preview" src="" alt="ÁîüÊàê„Åï„Çå„ÅüË®ò‰∫ã„ÅÆ„Éó„É¨„Éì„É•„Éº">
    <br>
    <a id="download-image-btn" class="download-btn" href="#" download="scoop.png">ÁîªÂÉè„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</a>
    <p class="mobile-save-hint">ÁîªÂÉè„ÇíÈï∑Êäº„Åó„Åó„Å¶‰øùÂ≠ò</p>
  </div>
</div>

<script type="module">
// OpenRouter API„ÅÆË®≠ÂÆö
const MODEL = "deepseek/deepseek-chat-v3.1:free"; // ÁÑ°Êñô„É¢„Éá„É´„Çí‰ΩøÁî®
let USER_API_KEY = "";

const chatEl = document.getElementById('chat');
const inputEl = document.getElementById('text');
const sendBtn = document.getElementById('send');
const statusEl = document.getElementById('status');
const toastEl = document.getElementById('toast');
const appEl = document.querySelector('.app');
const progressBarContainer = document.getElementById('progress-bar-container');
const imageOverlay = document.getElementById('image-overlay');
const closeOverlayBtn = document.getElementById('close-overlay');
const imagePreview = document.getElementById('generated-image-preview');
const downloadImageBtn = document.getElementById('download-image-btn');
const inputBar = document.getElementById('input-bar');
const postGenerationControls = document.getElementById('post-generation-controls');
const reopenBtn = document.getElementById('reopen-btn');
const startOverBtn = document.getElementById('start-over-btn');

let depth = 0;
let locked = false;
let userName = "";
const MAX_DEPTH = 5;
let lastGeneratedImageDataUrl = null;

const conversation = [
  {
    role: "system",
    content: `„ÅÇ„Å™„Åü„ÅØÈÄ±ÂàäË™å„ÅÆAIË®òËÄÖ„Åß„Åô„ÄÇ„É¶„Éº„Ç∂„Éº„ÅÆË©±„ÇíÈù¢ÁôΩ„Åä„Åã„Åó„ÅèËÜ®„Çâ„Åæ„Åõ„Å¶ÂèñÊùê„Åó„Åæ„Åô„ÄÇ

ÈáçË¶Å„Å™„É´„Éº„É´Ôºö
1. „É¶„Éº„Ç∂„Éº„ÅÆËøîÁ≠î„Çí„Åó„Å£„Åã„ÇäÁêÜËß£„Åó„Å¶„ÄÅ„Åù„ÅÆÂÜÖÂÆπ„Å´Âü∫„Å•„ÅÑ„ÅüË≥™Âïè„Çí„Åô„Çã
2. Ââç„ÅÆ‰ºöË©±„ÅÆÊñáËÑà„ÇíË∏è„Åæ„Åà„Å¶Ëá™ÁÑ∂„Å´‰ºöË©±„ÇíÁ∂ö„Åë„Çã
3. Ë©±„ÅÆÁüõÁõæ„ÇÑÂãòÈÅï„ÅÑ„Çí„Åó„Å™„ÅÑ
4. Ë≥™Âïè„ÅØ1„Å§„Å†„Åë„ÄÅÁü≠„ÅèÁöÑÁ¢∫„Å´
5. Â§ß„Åí„Åï„ÅßÈù¢ÁôΩ„ÅÑ„Åå„ÄÅË©±„ÅÆÊµÅ„Çå„ÅØÂÆà„Çã
6. „É¶„Éº„Ç∂„Éº„ÅåË®Ä„Å£„Å¶„Å™„ÅÑ„Åì„Å®„ÇíÂãùÊâã„Å´‰ªò„ÅëÂä†„Åà„Å™„ÅÑ`
  }
];

window.startApp = function() {
  const nameInput = document.getElementById('userName');
  const apiKeyInput = document.getElementById('apiKey');
  userName = nameInput.value.trim();
  USER_API_KEY = apiKeyInput.value.trim();
  
  if (!userName) {
    alert("„ÅäÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ");
    return;
  }
  
  if (!USER_API_KEY) {
    alert("OpenRouter„ÅÆAPI„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ");
    return;
  }
  
  // API„Ç≠„Éº„Çí„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠òÔºàÊ¨°Âõû‰ª•Èôç„ÅÆÂà©‰æøÊÄß„ÅÆ„Åü„ÇÅÔºâ
  localStorage.setItem('openrouter_api_key', USER_API_KEY);
  
  document.getElementById('welcome').style.display = 'none';
  appEl.style.display = 'flex';
  boot();
}

// „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´‰øùÂ≠ò„Åï„Çå„ÅüAPI„Ç≠„Éº„Åå„ÅÇ„Çå„Å∞Ëá™ÂãïÂÖ•Âäõ
window.addEventListener('DOMContentLoaded', () => {
  const savedApiKey = localStorage.getItem('openrouter_api_key');
  if (savedApiKey) {
    const apiKeyInput = document.getElementById('apiKey');
    if (apiKeyInput) {
      apiKeyInput.value = savedApiKey;
    }
  }
})

function showToast(msg, timeout=3200){
  toastEl.textContent = msg;
  toastEl.classList.remove('hidden');
  window.clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>toastEl.classList.add('hidden'), timeout);
}

function renderMessage(role, content){
  const row = document.createElement('div');
  row.className = `row ${role === 'assistant' ? 'ai' : 'user'}`;
  
  const avatar = document.createElement('div');
  avatar.className = 'avatar';
  avatar.textContent = role === 'assistant' ? 'AI' : userName.substring(0,2);
  
  const wrap = document.createElement('div');
  const meta = document.createElement('div');
  meta.className = 'meta';
  meta.textContent = role === 'assistant' ? 'AI„Ç∏„É£„Éº„Éä„É™„Çπ„Éà' : userName;
  
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.textContent = content;
  
  wrap.appendChild(meta);
  wrap.appendChild(bubble);
  row.appendChild(avatar);
  row.appendChild(wrap);
  chatEl.appendChild(row);
  chatEl.scrollTop = chatEl.scrollHeight;
}

async function generateAndShowImage(headline, body) {
    setStatus("ÁîªÂÉè„ÇíÁîüÊàê‰∏≠‚Ä¶", true);

    const renderContainer = document.createElement('div');
    renderContainer.className = 'image-render-container';

    const h1 = document.createElement('h1');
    h1.textContent = headline;
    renderContainer.appendChild(h1);

    body.split('\n\n').forEach(paragraph => {
        if (paragraph.startsWith('**') && paragraph.endsWith('**')) {
            const h2 = document.createElement('h2');
            h2.textContent = paragraph.slice(2, -2);
            renderContainer.appendChild(h2);
        } else {
            const p = document.createElement('p');
            p.textContent = paragraph;
            renderContainer.appendChild(p);
        }
    });

    document.body.appendChild(renderContainer);

    try {
        const canvas = await html2canvas(renderContainer, { 
            scale: 1.5, 
            useCORS: true,
            backgroundColor: '#ffffff',
            width: renderContainer.scrollWidth,
            height: renderContainer.scrollHeight
        });
        
        lastGeneratedImageDataUrl = canvas.toDataURL('image/png');
        
        imagePreview.src = lastGeneratedImageDataUrl;
        downloadImageBtn.href = lastGeneratedImageDataUrl;
        downloadImageBtn.download = `${userName}_scoop.png`;
        
        imageOverlay.style.display = 'flex';

        showToast("ÁîªÂÉè„ÅÆÁîüÊàê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ");

    } catch (err) {
        console.error("Image generation error:", err);
        showToast("ÁîªÂÉè„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
    } finally {
        document.body.removeChild(renderContainer);
        setStatus("ÂÆå‰∫Ü üì∞");
    }
}

function setStatus(msg, showProgress = false) {
    statusEl.textContent = msg;
    progressBarContainer.classList.toggle('hidden', !showProgress);
}

async function callOpenRouter(messages, retryCount = 0){
  locked = true;
  const body = {
    model: MODEL,
    temperature: 0.9,
    max_tokens: 2500,
    messages
  };
  
  try {
    // OpenRouter API„ÇíÁõ¥Êé•Âëº„Å≥Âá∫„ÅóÔºà„É¶„Éº„Ç∂„Éº„ÅÆAPI„Ç≠„Éº„Çí‰ΩøÁî®Ôºâ
    const apiUrl = 'https://openrouter.ai/api/v1/chat/completions';
    
    console.log('Using model:', MODEL);
    
    const headers = {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${USER_API_KEY}`,
      "HTTP-Referer": window.location.href,
      "X-Title": "Scoop Generator"
    };
    
    const resp = await fetch(apiUrl, {
      method: "POST",
      headers,
      body: JSON.stringify(body)
    });
    
    if(!resp.ok) {
      const errorData = await resp.text();
      console.error('API Error:', resp.status, errorData);
      if (resp.status === 401) {
        throw new Error("API„Ç≠„Éº„ÅåÁÑ°Âäπ„Åß„Åô„ÄÇÊ≠£„Åó„ÅÑ„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
      }
      throw new Error("API error: " + resp.status);
    }
    
    const data = await resp.json();
    return data?.choices?.[0]?.message?.content ?? "";
  } catch(e) {
      console.error(e);
      if (e.message.includes('API„Ç≠„Éº„ÅåÁÑ°Âäπ')) {
          showToast(e.message);
          throw e;
      }
      if (retryCount < 1) {
          setStatus(`„Ç®„É©„ÉºÁô∫Áîü„ÄÇ3ÁßíÂæå„Å´ÂÜçË©¶Ë°å„Åó„Åæ„Åô‚Ä¶`, true);
          await new Promise(resolve => setTimeout(resolve, 3000));
          return callOpenRouter(messages, retryCount + 1);
      } else {
          showToast("ÈÄö‰ø°„Ç®„É©„ÉºÔºÅAPI„Ç≠„Éº„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
          throw e;
      }
  }
}

async function askNext(){
  setStatus("ÂèñÊùê‰∏≠‚Ä¶üé§", true);
  try{
    // ‰ºöË©±Â±•Ê≠¥ÂÖ®‰Ωì„ÇíÈÄÅ„Å£„Å¶ÊñáËÑà„ÇíÁêÜËß£„Åï„Åõ„Çã
    const contextMessages = [
      conversation[0], // „Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„Éà
      ...conversation.slice(1).map(msg => ({
        role: msg.role,
        content: msg.content
      }))
    ];
    
    const reply = await callOpenRouter(contextMessages);
    conversation.push({ role:"assistant", content: reply });
    renderMessage("assistant", reply);
  }catch(e){
    console.error(e);
  } finally {
    setStatus("ÂæÖÊ©ü‰∏≠");
    locked = false;
  }
}

async function generateArticle(){
  setStatus("üö® Á∑äÊÄ•ÈÄüÂ†±‰ΩúÊàê‰∏≠ üö®", true);
  const sys = {
    role: "system",
    content: `„ÅÇ„Å™„Åü„ÅØÈÄ±ÂàäË™å„ÅÆË®ò‰∫ãÂü∑Á≠ÜËÄÖ„Åß„Åô„ÄÇ„Åì„Çå„Åã„ÇâÊ∏°„ÅôÂèñÊùêÂÜÖÂÆπ„ÇíÂÖÉ„Å´„ÄÅÂÆåÊàê„Åó„ÅüË®ò‰∫ã„ÇíÊõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

„ÄêË∂ÖÈáçË¶Å„Äë„Åì„Çå„ÅØË®ò‰∫ãÂü∑Á≠Ü„ÅÆÊÆµÈöé„Åß„Åô„ÄÇ„Ç§„É≥„Çø„Éì„É•„Éº„ÅØÁµÇ‰∫Ü„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ
- ÂèñÊùêÂÜÖÂÆπ„ÅÆÂºïÁî®„ÇÑ„ÄÅ„Ç§„É≥„Çø„Éì„É•„Éº„ÅÆÂÜçÁèæ„ÅØÁµ∂ÂØæ„Å´„Åó„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ
- „Äå‚óã‚óã„Å´„Å§„ÅÑ„Å¶Êïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ„Äç„ÅÆ„Çà„ÅÜ„Å™Ë≥™ÂïèÊñá„ÅØÁµ∂ÂØæ„Å´Êõ∏„Åã„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ
- „ÅÇ„Å™„Åü„ÅØË®òËÄÖ„Å®„Åó„Å¶„ÄÅ${userName}„Åï„Çì„ÅÆÊó•Â∏∏„ÇíÁàÜÁ¨ë„Çπ„ÇØ„Éº„ÉóË®ò‰∫ã„Å®„Åó„Å¶Âü∑Á≠Ü„Åô„Çã„Å†„Åë„Åß„Åô

Âü∑Á≠Ü„Çπ„Çø„Ç§„É´Ôºö
- ËôöÊßãÊñ∞ËÅû„ÇÑ„Éú„Éº„Éú„ÉúÈ¢®„ÅÆÂ§ß„Åí„Åï„ÅßÈ¶¨ÈπøÈ¶¨Èπø„Åó„ÅÑÊñá‰Ωì
- „Å©„Çì„Å™‰∫õÁ¥∞„Å™„Åì„Å®„ÇÇÂõΩÂÆ∂„É¨„Éô„É´„ÅÆÂ§ß‰∫ã‰ª∂„Å®„Åó„Å¶Êâ±„ÅÜ
- ÁúüÈù¢ÁõÆ„Å™Âè£Ë™ø„ÅßÈ¶¨Èπø„Åí„Åü„Åì„Å®„ÇíÊõ∏„ÅèÔºà„Ç∑„É™„Ç¢„Çπ„Å™Á¨ë„ÅÑÔºâ
- „ÄåÂÆöÈ£üÂ±ã„ÅåÊ∑∑„Çì„Åß„Åü„Äç‚Üí„ÄåÂâç‰ª£Êú™ËÅû„ÅÆÈ£≤È£üÂ∫óÂåÖÂõ≤Á∂≤„Äç„Åø„Åü„ÅÑ„Å™Â§ß‰ª∞„Å™Ë°®Áèæ
- ÂÆüÈöõ„ÅÆÂá∫Êù•‰∫ã„ÅØÂÆà„Çä„Å§„Å§„ÄÅËß£Èáà„Å®Ë°®Áèæ„ÇíÊ•µÈôê„Åæ„ÅßË™áÂºµ

Á¨ë„ÅÑ„ÅÆ„ÉÜ„ÇØ„Éã„ÉÉ„ÇØÔºö
- Â§ß„Åí„Åï„Å™ÊØîÂñ©Ôºà„Äå„Åæ„Çã„Åß‚óã‚óã„ÅÆ„Çà„ÅÜ„Å™„Äç„ÇíÂ§öÁî®Ôºâ
- Èñ¢‰øÇËÄÖ„ÅÆË®ºË®Ä„ÇíÊçèÈÄ†Ôºà„ÄåËøëÊâÄ„ÅÆÁå´„ÇÇÈ©ö„Åç„ÇíÈö†„Åõ„Å™„ÅÑÊßòÂ≠ê„ÄçÁ≠âÔºâ
- Â∞ÇÈñÄÂÆ∂„ÅÆÂàÜÊûê„ÇíÂâµ‰ΩúÔºà„Äå‚óã‚óãË©ïË´ñÂÆ∂„Å´„Çà„Çã„Å®Ê≠¥Âè≤ÁöÑÁû¨Èñì„ÄçÁ≠âÔºâ
- Êï∞Â≠ó„ÇÑÁµ±Ë®à„ÇíÈÅ©ÂΩì„Å´‰Ωú„ÇãÔºà„ÄåÂÆü„Å´97.3%„ÅÆÁ¢∫Áéá„Åß„ÄçÁ≠âÔºâ
- Ê∑±Ë™≠„Åø„Åó„Åô„Åé„ÇãËÄÉÂØüÔºà„Äå„Åì„Çå„ÅåÊÑèÂë≥„Åô„Çã„ÇÇ„ÅÆ„ÅØ...„ÄçÔºâ
- ÊÄ•„Å´Âì≤Â≠¶ÁöÑ„Å´„Å™„Çã
- ÊúÄÂæå„ÅØÂøÖ„ÅöÂ£ÆÂ§ß„Å™„Ç™„ÉÅ„ÅßÁ∑†„ÇÅ„Çã

Ë¶Å‰ª∂Ôºö
- Ë¶ãÂá∫„Åó„ÅØ„Äå„ÄêÈÄüÂ†±„Äë${userName}Ê∞è„ÄÅ‚óã‚óã„Åß‰∏ñÁïå„ÇíÈúáÊíº„Åï„Åõ„Çã„Äç„Åø„Åü„ÅÑ„Å™ÂΩ¢Âºè
- Êú¨Êñá750„Äú1200Â≠ó„ÄÅ„Çª„ÇØ„Ç∑„Éß„É≥„Åî„Å®„Å´**„Çµ„Éñ„Çø„Ç§„Éà„É´**ÂøÖÈ†à
- „Å®„Å´„Åã„ÅèË™≠ËÄÖ„ÅåÂêπ„ÅçÂá∫„Åô„Çà„ÅÜ„Å™È¶¨Èπø„Åí„ÅüÂÜÖÂÆπ„Å´
- „Åß„ÇÇÂèñÊùê„ÅßËÅû„ÅÑ„ÅüÂü∫Êú¨ÁöÑ‰∫ãÂÆüÔºàÂ†¥ÊâÄ„ÉªÁâ©„Éª‰∫∫Ôºâ„ÅØÊ≠£Á¢∫„Å´

Ë®ò‰∫ã„ÅÆÂá∫ÂäõÂΩ¢ÂºèÔºàÂøÖ„Åö„Åì„ÅÆÂΩ¢Âºè„ÅßË®ò‰∫ã„ÇíÊõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑÔºâÔºö
„ÄêÈÄüÂ†±„Äë‚óã‚óãÔºàË°ùÊíÉÁöÑ„Å™Ë¶ãÂá∫„ÅóÔºâ

**Á¨¨‰∏ÄÁ´†Ôºö‚óã‚óãÔºà„Çµ„Éñ„Çø„Ç§„Éà„É´Ôºâ**

ÔºàË®ò‰∫ãÊú¨Êñá„Éë„É©„Ç∞„É©„ÉïÔºâ

**Á¨¨‰∫åÁ´†Ôºö‚óã‚óãÔºà„Çµ„Éñ„Çø„Ç§„Éà„É´Ôºâ**

ÔºàË®ò‰∫ãÊú¨Êñá„Éë„É©„Ç∞„É©„ÉïÔºâ

**Á¨¨‰∏âÁ´†Ôºö‚óã‚óãÔºà„Çµ„Éñ„Çø„Ç§„Éà„É´Ôºâ**

ÔºàË®ò‰∫ãÊú¨Êñá„Éë„É©„Ç∞„É©„ÉïÔºâ

Ê≥®ÊÑèÔºö„Åì„Çå„ÅØÂÆåÊàê„Åó„ÅüË®ò‰∫ã„Åß„Åô„ÄÇÂèñÊùêÂÜÖÂÆπ„ÇÑË≥™Âïè„ÇíÊõ∏„Åè„ÅÆ„Åß„ÅØ„Å™„Åè„ÄÅ„Éã„É•„Éº„ÇπË®ò‰∫ã„Å®„Åó„Å¶Êõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`
  };
  
  try{
    // Ë®ò‰∫ãÁîüÊàêÁî®„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÊßãÁØâ
    // „É¶„Éº„Ç∂„Éº„ÅÆÂõûÁ≠î„ÅÆ„Åø„ÇíÊäΩÂá∫„Åó„Å¶Ë®ò‰∫ãÁîüÊàê„Å´‰ΩøÁî®
    const userResponses = conversation
      .filter(msg => msg.role === "user")
      .map(msg => msg.content)
      .join("\n\n");
    
    const articleMessages = [
      sys,
      {
        role: "user",
        content: `ÂèñÊùê„É°„É¢Ôºö${userName}„Åï„Çì„Å∏„ÅÆ„Ç§„É≥„Çø„Éì„É•„ÉºÂÜÖÂÆπ\n\n${userResponses}\n\n‰∏äË®ò„ÅÆÂèñÊùê„É°„É¢„ÇíÂÖÉ„Å´„ÄÅÂÆåÊàê„Åó„Åü„Éã„É•„Éº„ÇπË®ò‰∫ã„ÇíÂü∑Á≠Ü„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n„ÄêÈáçË¶Å„Äë„Ç§„É≥„Çø„Éì„É•„ÉºÂÜÖÂÆπ„ÅÆÂÜçÁèæ„Åß„ÅØ„Å™„Åè„ÄÅ„Éó„É≠„ÅÆ„Ç∏„É£„Éº„Éä„É™„Çπ„Éà„ÅåÊõ∏„ÅÑ„ÅüÂÆåÊàêË®ò‰∫ã„Å®„Åó„Å¶Âá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`
      }
    ];
    
    const reply = await callOpenRouter(articleMessages);
    const lines = reply.split('\n\n');
    const headline = lines.shift() || "Ë°ùÊíÉ„ÅÆ„Çπ„ÇØ„Éº„ÉóÔºÅ";
    const body = lines.join('\n\n');
    
    await generateAndShowImage(headline, body);

  }catch(e){
    showToast("„Çπ„ÇØ„Éº„Éó‰ΩúÊàêÂ§±ÊïóÔºÅ„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÔºÅ");
  }finally{
    setStatus("ÂÆå‰∫Ü üì∞");
    locked = false;
  }
}

function handleSend(){
  if(locked) return;
  const text = inputEl.value.trim();
  if(!text) return;
  
  inputEl.value = "";
  
  renderMessage("user", text);
  conversation.push({ role:"user", content: text });
  
  locked = true;
  if(depth < MAX_DEPTH){
    depth++;
    askNext();
  }else{
    generateArticle();
  }
}

sendBtn.addEventListener('click', handleSend);
inputEl.addEventListener('keydown', (e)=> {
  if(e.key === 'Enter' && !e.isComposing) {
      e.preventDefault();
      handleSend();
  }
});

closeOverlayBtn.addEventListener('click', () => {
    imageOverlay.style.display = 'none';
    inputBar.style.display = 'none';
    chatEl.innerHTML = '';
    postGenerationControls.style.display = 'flex';
});

reopenBtn.addEventListener('click', () => {
    if (lastGeneratedImageDataUrl) {
        imageOverlay.style.display = 'flex';
    }
});

startOverBtn.addEventListener('click', () => {
    window.location.reload();
});

function boot(){
  // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÈñãÂßãÊôÇÔºà„Åæ„Åü„ÅØ„É™„Çª„ÉÉ„ÉàÊôÇÔºâ„ÅØ„ÄÅÂÖ•Âäõ„Éê„Éº„ÇíË°®Á§∫„Åó„ÄÅË®ò‰∫ãÂæå„Ç≥„É≥„Éà„É≠„Éº„É´„ÇíÈùûË°®Á§∫„Å´„Åô„Çã
  inputBar.style.display = 'flex';
    postGenerationControls.style.display = 'none';

  const greeting = `„Åì„Çì„Å´„Å°„ÅØ${userName}„Åï„ÇìÔºÅÁßÅ„ÅØÈÄ±ÂàäË™å„ÅÆAIË®òËÄÖ„Åß„Åô„ÄÇ‰ªäÊó•„ÅÇ„Å£„ÅüÂá∫Êù•‰∫ã„Åß„ÄÅ‰∏ÄÁï™Âç∞Ë±°ÁöÑ„Å†„Å£„Åü„Åì„Å®„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Å©„Çì„Å™‰∫õÁ¥∞„Å™„Åì„Å®„Åß„ÇÇÂ§ß„Çπ„ÇØ„Éº„Éó„Å´‰ªïÁ´ã„Å¶‰∏ä„Åí„Åæ„Åô„ÇàÔºÅ`;
  conversation.push({ role: "assistant", content: greeting });
  renderMessage("assistant", greeting);
  setStatus("ÂæÖÊ©ü‰∏≠");
}

</script>
</body>
</html>
